#!/bin/bash -xe

# Standard setup and printing of debug information.  Keep in sync with other scripts.
set -exv
cd $(dirname ${0})
cd ..
echo "Current directory"
pwd
echo "Git information"
git version
git log -n 1
# End of standard setup

# The boilerplate debug information at the top of this script
# ensures we are one directory up from this script's location.
# Thus, incorporate a more hard-coded approach to specifying
# the path to the tnrp/versions script compared to
# the dynamic process for doing so performed by
# the tnrp/evaluate_pr script.
getSMBPackageName() {
    VERSIONS_SCRIPT="./tnrp/versions"
    if [[ ! -f "${VERSIONS_SCRIPT}" ]]; then
      echo "${VERSIONS_SCRIPT} is missing or not a file."
      exit 1
    fi

    source "${VERSIONS_SCRIPT}"
    if [[ -z "${SMBPACKAGE}" ]]; then
      echo "SMBPACKAGE variable must be non-empty."
      exit 1
    fi
}

if [ -z "$FIREFLY" ]; then
   SAMBINDIR=/opt/sam
else
   echo "*** EXECUTING IN $FIREFLY ENVIRONMENT"
   SAMBINDIR=/sam
   getSMBPackageName
   yum install -y "${SMBPACKAGE}"
   echo "Verifying package installed: ${SMBPACKAGE}"
   if ! yum list installed "${SMBPACKAGE}"; then
     echo "Expected package not installed: ${SMBPACKAGE}"
     exit 1
   fi
fi


while getopts ":o:" opt; do
  case $opt in
    o)
      OUTPUT_DIR=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done

#Generate git history file
$SAMBINDIR/manifestctl manifest-git-info --inputDir . -outputPath ${OUTPUT_DIR}/git-info.yaml -gitHistoryMode lib -alsologtostderr
 # Disable estates check for now until we work out the access token stuff
$SAMBINDIR/sam-manifest-builder -logtostderr -output ${OUTPUT_DIR} -estatescheck=false -tnrppipelinelabel ${TNRP_PIPELINE_LABEL} -root . -validationExceptionsFile=./sam-internal/validation-whitelist.yaml --swaggerspecdir=$SAMBINDIR/swagger-spec -imagefileoutdir . -internalpassthrough k8s-out,sdn,authorizer -gitHistoryInfoFile ${OUTPUT_DIR}/git-info.yaml -skip-sam-internals -alsologtostderr

$SAMBINDIR/manifestctl build-repo -inputManifestDir . -outputDir ${OUTPUT_DIR} -alsologtostderr

$SAMBINDIR/manifestctl compare-manifests -oldManifestDir=${OUTPUT_DIR}/goal-state -newManifestDir=${OUTPUT_DIR}/goal

# Copy over vips.yaml files for SLB
/opt/slb/slb-manifest-builder -root . -output ${OUTPUT_DIR} -v=2


cp ./image-promotion.yaml ${OUTPUT_DIR}

# Temporary for now
env > ${OUTPUT_DIR}/debug_env.txt
git log -n 1 > ${OUTPUT_DIR}/debug_gitlog.txt
