#!/bin/bash
#exit on error
set -e

REPO_OWNER=sam

if [ -z "$FIREFLY" ]; then
   SAMBINDIR=/opt/sam
else
   echo "*** EXECUTING IN $FIREFLY ENVIRONMENT"
   SAMBINDIR=/sam
   # This is required for SAM to run json consistency tests for sam-internal files
   yum install -y make gcc gcc-c++ slb-manifest-builder-20190214_162244.840e110.clean.47c9914c4982-1.x86_64
fi


#exitIfMergeCommitFound checks if there are any
#merge commits introduced by the current branch
#which are not present in the origin/master.
#If it finds any merge commits, it calls exit.
exitIfMergeCommitFound() {
    GIT_CURRENT_BRANCH=$(git name-rev --name-only HEAD)
    tnrpBotName='tnrp-ro@salesforce.com'
    #Find count of all the merge commits that are
    #present in the current branch but not in origin/master.
    #Merge commits by tnrp bot are ignored.
    key="commit"
    mergeCommits=$(git log origin/master..$GIT_CURRENT_BRANCH --merges --pretty=format:"$key %H %P %an" |grep -v $tnrpBotName | grep -c $key) || true
    #Find count of all non merge commits that are
    #present in the current branch but not in origin/master.
    #Commits by tnrp bot are ignored.
    nonMergeCommits=$(git log origin/master..$GIT_CURRENT_BRANCH --no-merges --pretty=format:"$key %H %P %an" |grep -v $tnrpBotName | grep -c $key) || true
    echo "PR has ${mergeCommits} merge commits and ${nonMergeCommits} normal commits"
    if [ "$mergeCommits" -ne "0" ]
    then
        echo "Merge commits are not allowed in PRs"
        echo "For help removing them see http://stackoverflow.com/questions/21115596/remove-a-merge-commit-keeping-current-changes"
        exit 1
    fi
}

exitIfMergeCommitFound

# If running in Firefly, we need to remove everything from /tmp in order to make sure
# any stale generated files don't interfere with the current run.
# This is only needed for Firefly since execution environments are recycled accross runs
if [ -z "$FIREFLY" ]; then
    rm -rf /tmp/manifests || true
else
    rm -rf /tmp/* || true
fi

cd /tmp
git clone git@git.soma.salesforce.com:sam/${TNRP_PRODUCT}.git manifests

cd -

# This is a temporary work-around while we wait for secret support in Firefly ~2/15.
# This is a pgp encrypted read-only git token.  We use the md5 of the firefly ssh key to decrypt this at runtime.
echo "jA0EAwMCM83UkvAikDvXyUgPQVzVBUGsBSaU+nMLOMMohLld2pa5kGe3pfvZrlLC39/rQUMnccVKvM3gLZCorgbTR2E7cHuV69VAlTgNNIbqxMUF7q96lAc=" | base64 -d > token.txt.gpg
gpg --yes --batch --passphrase=$(md5sum /root/.ssh/id_rsa | cut -f1 -d" ") ./token.txt.gpg &> /dev/nul

# For ops0-artifactrepo1-0-gcp and gcr.io in unvalidated-image-prefixes, it is a temp work-around to bypass image existence check during image promotion so that we can unblock customer PCN deployment
# The reason we need two image prefixes here is that we have dual-run of both SMB and MANIFESTCTL:
#  1)for SMB, though gcr images are valid long-form images, it is seen as short-form and get added prefix due to hard coded SMB function;
#  2)for MANIFESTCTL, it is reserved in its original form
$SAMBINDIR/evaluate-pr \
--ghe-token-file ./token.txt \
-authorizer $STAGE_GO_TRIGGER_USER \
-orig-dir /tmp/manifests \
-dir-with-changes $PWD \
-pr="$STAGE_PULL_REQUEST_ID" \
-smb $SAMBINDIR/sam-manifest-builder \
-repo-name="$TNRP_PRODUCT" \
-unvalidated-image-prefixes "minikube,ops0-artifactrepo1-0-mvp,gcr.io,ops0-artifactrepo2-0-xrd.slb.sfdc.net" \
-full-schema \
-image-exists-tries=2 \
-image-exists-try-sleep-duration=10s \
-validate-self-check-enabled=true \
-self-authorize-check-regex="^(?:[^/]*/)sam-internal/k8s-out/([^/]*)/([^/]*)/,^(?:[^/]*/)apps/team/(?:[^/]*)/vips/" \
--moratoriumEnabled=true \
--maxNumberOfAdmins 2 \
--moratoriumBegin="2018-12-17T08:00:00Z" \
--moratoriumEnd="2019-01-02T08:00:00Z" \
--MoratoriumAccessDisabledMessage="End-of-Year Moratorium begins at 08:00 UTC on Monday, December 17 (03:00 EST, 12:00 AM PST on Monday morning) and ends at 08:00 UTC on Wednesday, January 2 (03:00 EST, 12:00 AM PST on Wednesday morning. During the moratorium prod PRs require approval by an admin, and admins are required to ensure that changes properly follow the moratorium guidelines. For more information see http://sfdc.co/sam-admins."
# Validate vips.yaml files for SLB, this does not copy any files to output
/opt/slb/slb-manifest-builder -root $PWD -output $PWD -validate -v=1
