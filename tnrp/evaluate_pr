#!/bin/bash -e

#Exit on first error
set -e

# Check if json files conforms to jsonnets
ensureLatestJsons() {
pushd ./sam-internal/k8s-in
./build.sh > /dev/null
popd
if [[ `git status --porcelain` ]]; then
  echo "build.sh output does not match applied changes"
  git status
  exit 1
fi
}

#exitIfMergeCommitFound checks if there are any
#merge commits introduced by the current branch
#which are not present in the origin/master.
#If it finds any merge commits, it calls exit.
exitIfMergeCommitFound() {
  GIT_CURRENT_BRANCH=$(git name-rev --name-only HEAD)
  tnrpBotName='tnrp-ro@salesforce.com'
  #Find count of all the merge commits that are
  #present in the current branch but not in origin/master.
  #Merge commits by tnrp bot are ignored.
  key="commit"
  mergeCommits=$(git log origin/master..$GIT_CURRENT_BRANCH --merges --pretty=format:"$key %H %P %an" |grep -v $tnrpBotName | grep -c $key) || true
  #Find count of all non merge commits that are
  #present in the current branch but not in origin/master.
  #Commits by tnrp bot are ignored.
  nonMergeCommits=$(git log origin/master..$GIT_CURRENT_BRANCH --no-merges --pretty=format:"$key %H %P %an" |grep -v $tnrpBotName | grep -c $key) || true
  echo "PR has ${mergeCommits} merge commits and ${nonMergeCommits} normal commits"
  if [ "$mergeCommits" -ne "0" ]
  then
    echo "Merge commits are not allowed in PRs"
    echo "For help removing them see http://stackoverflow.com/questions/21115596/remove-a-merge-commit-keeping-current-changes"
    exit 1
  fi
}

readOnlyGitToken="ef11904af720485500651dedc5c513303bc3a5d3"

exitIfApproverNAuthorAreDifferent() {

    author=$(curl https://$readOnlyGitToken@git.soma.salesforce.com/api/v3/repos/sam/manifests/pulls/$STAGE_PULL_REQUEST_ID |  python -c 'import json,sys;obj=json.load(sys.stdin);print obj["user"]["login"]' | tr '-' '.')

    echo "Pull request author is $author"

    approver=$(basename $STAGE_GO_TRIGGER_USER @salesforce.com)

    if [ "$author" == "$approver" ]; then
        echo "$author and $approver are same"
    else
        echo "Author and approver are different"
        exit 0
    fi
}

echo -e "\nEvaluating PR\n"


ensureLatestJsons

exitIfMergeCommitFound

/opt/sam/aclrepo --pr=$STAGE_PULL_REQUEST_ID --userId=$STAGE_GO_TRIGGER_USER

/opt/sam/sam-manifest-builder --root='./' --swaggerspecdir='/opt/sam/swagger-spec' -validateonly -validationExceptionsFile=./sam-internal/validation-whitelist.yaml

exitIfApproverNAuthorAreDifferent

#scratch pad for SMB output with PR changes
prOutputDir=/tmp/PR_$STAGE_PULL_REQUEST_ID

rm -rf $prOutputDir || true

mkdir $prOutputDir

/opt/sam/sam-manifest-builder --root='./' --swaggerspecdir='/opt/sam/swagger-spec' -output $prOutputDir -validationExceptionsFile=./sam-internal/validation-whitelist.yaml

#A branch without PR changes.
origBranch=br_$STAGE_PULL_REQUEST_ID

#scratch pad for SMB output without PR changes
origOutputDir=/tmp/$origBranch

rm -rf $origOutputDir || true
mkdir $origOutputDir

git pull origin master:$origBranch
git checkout $origBranch

/opt/sam/sam-manifest-builder --root='./' --swaggerspecdir='/opt/sam/swagger-spec' -output $origOutputDir -validationExceptionsFile=./sam-internal/validation-whitelist.yaml

#Switch back to the last branch
git checkout -

git branch -D $origBranch

if ! diff -wr "$origOutputDir/sam-internal" "$prOutputDir/sam-internal"; then
    echo "sam-stack updates are not allowed when author and approver are the same"
    exit 1
fi

#Ignore hashes.yaml and the prd folder
#Ignore output,timeStamp and all strings begining with 
#latest in control-estate.yaml as these would be
#different for different runs in different branches.
difference=$(diff -wr -x hashes.yaml --exclude=prd -I output -I timeStamp -I 'latest*' $origOutputDir/goal-state $prOutputDir/goal-state)
if [ ! -z $difference ]; then
    echo "Non prd changes are not allowed when author and approver are the same"
    exit 1
else
    echo "Only prd changes in this PR approver and author can be same."
fi
