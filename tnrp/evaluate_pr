#!/bin/bash
#exit on error
set -e

REPO_OWNER=sam

if [ -z "$FIREFLY" ]; then
   SAMBINDIR=/opt/sam
else
   echo "*** EXECUTING IN $FIREFLY ENVIRONMENT"
   SAMBINDIR=/sam
   yum install -y slb-manifest-builder-20181102_195903.30938bb.dirty.ops_pipedocker1_1_prd-1.x86_64
fi


#exitIfMergeCommitFound checks if there are any
#merge commits introduced by the current branch
#which are not present in the origin/master.
#If it finds any merge commits, it calls exit.
exitIfMergeCommitFound() {
    GIT_CURRENT_BRANCH=$(git name-rev --name-only HEAD)
    tnrpBotName='tnrp-ro@salesforce.com'
    #Find count of all the merge commits that are
    #present in the current branch but not in origin/master.
    #Merge commits by tnrp bot are ignored.
    key="commit"
    mergeCommits=$(git log origin/master..$GIT_CURRENT_BRANCH --merges --pretty=format:"$key %H %P %an" |grep -v $tnrpBotName | grep -c $key) || true
    #Find count of all non merge commits that are
    #present in the current branch but not in origin/master.
    #Commits by tnrp bot are ignored.
    nonMergeCommits=$(git log origin/master..$GIT_CURRENT_BRANCH --no-merges --pretty=format:"$key %H %P %an" |grep -v $tnrpBotName | grep -c $key) || true
    echo "PR has ${mergeCommits} merge commits and ${nonMergeCommits} normal commits"
    if [ "$mergeCommits" -ne "0" ]
    then
        echo "Merge commits are not allowed in PRs"
        echo "For help removing them see http://stackoverflow.com/questions/21115596/remove-a-merge-commit-keeping-current-changes"
        exit 1
    fi
}

exitIfMergeCommitFound

cd /tmp
rm -rf manifests || true
git clone git@git.soma.salesforce.com:sam/${TNRP_PRODUCT}.git manifests

cd -

$SAMBINDIR/evaluate-pr -authorizer $STAGE_GO_TRIGGER_USER -orig-dir /tmp/manifests -dir-with-changes $PWD -pr="$STAGE_PULL_REQUEST_ID" -smb $SAMBINDIR/sam-manifest-builder -repo-name="$TNRP_PRODUCT" -unvalidated-image-prefixes "minikube" -full-schema -image-exists-tries=2 -image-exists-try-sleep-duration=10s -validate-self-check-enabled=true -self-authorize-check-regex="^(?:[^/]*/)sam-internal/k8s-out/([^/]*)/([^/]*)/,^(?:[^/]*/)apps/team/(?:[^/]*)/vips/" --moratoriumEnabled=true --maxNumberOfAdmins 2 --moratoriumBegin="2018-11-19T08:01:00Z" --moratoriumEnd="2018-11-28T07:59:00Z" --MoratoriumAccessDisabledMessage="Thanksgiving moratorium is in effect (Starts Monday, November 19, 2018 12:01AM PST, Ends November 27, 11:59PM PST). During the moratorium prod PRs require approval by an admin, and admins are required to ensure that changes properly follow the moratorium guidelines. For more information see http://sfdc.co/sam-admins "

# Validate vips.yaml files for SLB, this does not copy any files to output
/opt/slb/slb-manifest-builder -root $PWD -output $PWD -validate -v=1
