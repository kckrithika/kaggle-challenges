apiVersion: v1
data:
  watchdog-samsql-queries.jsonnet: '{"sql_alerts": [{"alertFrequency": "24h", "alertThreshold":
    "30m", "instructions": "The following deployments are reported as bad customer
    deployments in Production. Debug Instructions: https://git.soma.salesforce.com/sam/sam/wiki/Debug-Failed-Deployment",
    "name": "Bad-Customer-Deployments-Production", "sql": "SELECT * FROM\n(\n  SELECT\n    ControlEstate,\n    Namespace,\n    Name,\n    JSON_EXTRACT(Payload,
    ''$.metadata.annotations.\"smb.sam.data.sfdc.net/emailTo\"'') AS email,\n    JSON_EXTRACT(Payload,
    ''$.spec.replicas'') AS desiredReplicas,\n    JSON_EXTRACT(Payload, ''$.status.availableReplicas'')
    AS availableReplicas,\n    JSON_EXTRACT(Payload, ''$.status.replicas'') AS replicas,\n    JSON_EXTRACT(Payload,
    ''$.status.readyReplicas'') AS readyReplicas,\n    JSON_EXTRACT(Payload, ''$.status.updatedReplicas'')
    AS updatedReplicas,\n    CONCAT(''http://dashboard-'',SUBSTR(ControlEstate, 1,
    3),''-sam.csc-sam.prd-sam.prd.slb.sfdc.net/#!/deployment/'',Namespace,''/'',Name,''?namespace='',Namespace)
    AS Url\n  FROM k8s_resource\n  WHERE ApiKind = ''Deployment''\n) AS ss\nWHERE\n  (
    Namespace != ''sam-watchdog'' AND Namespace != ''sam-system'' AND Namespace !=
    ''csc-sam'') AND\n  (availableReplicas != desiredReplicas OR availableReplicas
    IS NULL) AND\n  NOT ControlEstate LIKE ''prd-%'' AND\n  desiredReplicas != 0",
    "watchdogFrequency": "15m"}]}'
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: watchdogsamsqlqueries
  namespace: sam-system
