apiVersion: v1
items:
- apiVersion: v1
  data:
    application.yml: |-
      {
          "firefly": {
              "crawler": {
                  "ghe-context-prefix": "",
                  "ghe-health-check-repo": "tnrpfirefly",
                  "job-interval-in-milliseconds": 300000,
                  "max-commit-retry": 10,
                  "max-prr-retry": 10,
                  "repositories": "tnrpfirefly/test_sam_manifests,sam/test-firefly-manifests",
                  "since-commit-time-in-minutes": 30,
                  "since-prr-time-in-minutes": 30,
                  "until-commit-status-time-in-minutes": 2,
                  "until-commit-time-in-minutes": 5,
                  "until-prr-status-time-in-minutes": 2,
                  "until-prr-time-in-minutes": 5
              },
              "intake": {
                  "api-url": "http://firefly-intake.firefly.prd-sam.prd.slb.sfdc.net:8080",
                  "connect-timeout": "10000ms",
                  "http-logging-interceptor-level": "NONE",
                  "keep-alive-duration": "5m",
                  "max-idle-connections": 10,
                  "read-timeout": "10000ms",
                  "write-timeout": "10000ms"
              },
              "monitoring": {
                  "datacenter": "prd",
                  "pod": "firefly-crawler",
                  "report-frequency": 60,
                  "superpod": "NONE",
                  "system-exception-threshold": 5
              }
          },
          "logging": {
              "level": {
                  "com.salesforce": "INFO",
                  "org": "INFO"
              },
              "pattern": {
                  "console": "%d{yyyy-MM-dd HH:mm:ss} - %C:%L[%thread] %-5level - details=[%msg]  %n"
              }
          },
          "management": {
              "endpoint": {
                  "health": {
                      "show-details": "always"
                  }
              },
              "endpoints": {
                  "web": {
                      "exposure": {
                          "include": "*"
                      }
                  }
              },
              "server": {
                  "port": 8081
              }
          },
          "scm": {
              "ghe": {
                  "api-url": "https://git.soma.salesforce.com/api/v3/",
                  "clone-timeout": "60s",
                  "connect-timeout": "5s",
                  "dark-launch": "${DARKLAUNCH}",
                  "keep-alive-duration": "60000ms",
                  "max-attempts": 3,
                  "max-idle-connections": 10,
                  "oauth-token": "${gitRWPassword#FromSecretService}",
                  "read-timeout": "5s",
                  "url": "https://git.soma.salesforce.com",
                  "user": "svc-tnrp-git-rw",
                  "write-timeout": "5s"
              }
          },
          "server": {
              "port": -1
          },
          "spring": {
              "quartz": {
                  "properties": {
                      "org.quartz.threadPool.threadCount": 100
                  }
              }
          }
      }
  kind: ConfigMap
  metadata:
    labels:
      sam.data.sfdc.net/owner: tnrp
    name: firefly-crawler-configmap
    namespace: firefly
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      slb.sfdc.net/name: firefly-crawler
      slb.sfdc.net/portconfigurations: '[{"lbtype": "http", "port": 8081, "reencrypt":
        false, "sticky": 0, "targetPort": 8081, "tls": false}]'
    labels:
      app: firefly-crawler
      sam.data.sfdc.net/owner: tnrp
    name: firefly-crawler-service
    namespace: firefly
  spec:
    ports:
    - name: admin-port
      port: 8081
      protocol: TCP
      targetPort: 8081
    selector:
      name: firefly-crawler
    type: NodePort
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      name: firefly-crawler
      sam.data.sfdc.net/owner: tnrp
    name: firefly-crawler-deployment
    namespace: firefly
  spec:
    replicas: 1
    selector:
      matchLabels:
        name: firefly-crawler
        sam.data.sfdc.net/owner: tnrp
    strategy:
      rollingUpdate:
        maxSurge: 0
        maxUnavailable: 1
      type: RollingUpdate
    template:
      metadata:
        annotations:
          madkub.sam.sfdc.net/allcerts: '{"certreqs":[{"name": "certs","san":["firefly"],"cert-type":"client",
            "kingdom":"prd", "role": "firefly"}]}'
        labels:
          name: firefly-crawler
          sam.data.sfdc.net/owner: tnrp
        name: firefly-crawler-deployment
        namespace: firefly
      spec:
        containers:
        - args:
          - /sam/madkub-client
          - --madkub-endpoint
          - https://10.254.208.254:32007
          - --maddog-endpoint
          - https://all.pkicontroller.pki.blank.prd.prod.non-estates.sfdcsd.net:8443
          - --maddog-server-ca
          - /maddog-certs/ca/security-ca.pem
          - --madkub-server-ca
          - /maddog-certs/ca/cacerts.pem
          - --cert-folders
          - certs:/certs/
          - --token-folder
          - /tokens/
          - --requested-cert-type
          - client
          - --refresher
          - --run-init-for-refresher-mode
          - --ca-folder
          - /maddog-certs/ca
          env:
          - name: MADKUB_NODENAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
          - name: MADKUB_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: MADKUB_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          image: ops0-artifactrepo2-0-prd.data.sfdc.net/docker-release-candidate/tnrp/sam/madkub:1.0.0-0000077-b1d3a629
          name: madkub-refresher
          resources: {}
          volumeMounts:
          - mountPath: /certs
            name: certs
          - mountPath: /tokens
            name: tokens
          - mountPath: /maddog-certs/
            name: maddog-certs
        - command:
          - java
          - -jar
          - /crawler-svc.jar
          - --spring.profiles.active=prd-sam
          - --spring.config.location=/etc/firefly/config/
          env:
          - name: MY_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: MY_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: MY_POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          - name: CONFIG_VERSION
            value: "6"
          - name: DARKLAUNCH
            value: "false"
          image: ops0-artifactrepo2-0-prd.data.sfdc.net/dva/firefly-crawler:197
          imagePullPolicy: Always
          livenessProbe:
            failureThreshold: 10
            httpGet:
              path: /actuator
              port: admin-port
            initialDelaySeconds: 30
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 30
          name: firefly-crawler
          ports:
          - containerPort: 8081
            name: admin-port
            protocol: TCP
          resources:
            limits:
              sam.sfdc.net/ip-address: "1"
            requests:
              sam.sfdc.net/ip-address: "1"
          volumeMounts:
          - mountPath: /certs
            name: certs
          - mountPath: /root/.ssh/
            name: git-ssh-keys
          - mountPath: /etc/firefly/config
            name: app-config-volume
        initContainers:
        - args:
          - /sam/madkub-client
          - --madkub-endpoint
          - https://10.254.208.254:32007
          - --maddog-endpoint
          - https://all.pkicontroller.pki.blank.prd.prod.non-estates.sfdcsd.net:8443
          - --maddog-server-ca
          - /maddog-certs/ca/security-ca.pem
          - --madkub-server-ca
          - /maddog-certs/ca/cacerts.pem
          - --cert-folders
          - certs:/certs/
          - --token-folder
          - /tokens/
          - --requested-cert-type
          - client
          - --ca-folder
          - /maddog-certs/ca
          env:
          - name: MADKUB_NODENAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: MADKUB_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: MADKUB_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          image: ops0-artifactrepo2-0-prd.data.sfdc.net/docker-release-candidate/tnrp/sam/madkub:1.0.0-0000077-b1d3a629
          imagePullPolicy: IfNotPresent
          name: madkub-init
          volumeMounts:
          - mountPath: /certs
            name: certs
          - mountPath: /maddog-certs/
            name: maddog-certs
          - mountPath: /tokens
            name: tokens
        nodeSelector:
          pool: prd-sam
        terminationGracePeriodSeconds: 10
        volumes:
        - name: app-config-volume
          projected:
            sources:
            - configMap:
                items:
                - key: application.yml
                  path: application.yml
                name: firefly-crawler-configmap
        - emptyDir: {}
          name: docker-graph-storage
        - emptyDir: {}
          name: docker-build-dir
        - emptyDir:
            medium: Memory
          name: tokens
        - emptyDir:
            medium: Memory
          name: certs
        - emptyDir:
            medium: Memory
          name: git-ssh-keys
        - hostPath:
            path: /etc/pki_service
          name: maddog-certs
kind: List
