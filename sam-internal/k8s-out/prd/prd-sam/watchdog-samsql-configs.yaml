apiVersion: v1
data:
  watchdog-samsql-profiles.jsonnet: '{"alertProfiles": [{"email": "sam-test-alerts@salesforce.com",
    "name": "sam", "pagerDuty": "sam-pagerduty@salesforce.com"}]}'
  watchdog-samsql-queries.jsonnet: '{"argus_metrics": [{"name": "MachineCountByKernelVersion",
    "sql": "select ''GLOBAL'' as Kingdom, ''NONE'' as SuperPod, ''global'' as Estate,
    ''sql.machineCountByKernelVersion'' as Metric, COUNT(*) as Value, CONCAT(''KernelVersion='',KernelVersion)
    as Tags from nodeDetailView group by kernelVersion", "watchdogFrequency": "60m"},
    {"name": "MachineCountByKingdomAndKernelVersion", "sql": "select UPPER(kingdom)
    as Kingdom, ''NONE'' as SuperPod, ControlEstate as Estate, ''sql.machineCountByKingdomAndKernelVersion''
    as Metric, COUNT(*) as Value, CONCAT(''KernelVersion='',KernelVersion) as Tags
    from nodeDetailView group by ControlEstate, kingdom, kernelVersion", "watchdogFrequency":
    "60m"}, {"name": "WatchdogSuccessPct", "sql": "select ''GLOBAL'' as Kingdom, ''NONE''
    as SuperPod, ''global'' as Estate, \n''sql.checkerPassPct'' as Metric, SuccessPct
    as Value, CONCAT(''CheckerName='',CheckerName) as Tags\nfrom (\n  select\n    CheckerName,\n    SUM(SuccessCount)/(SUM(SuccessCount)+SUM(FailureCount))
    as SuccessPct\n  from\n  (\n    select\n      Payload->>''$.status.report.CheckerName''
    as CheckerName,\n      case when Payload->>''$.status.report.Success'' = ''true''
    then 1 else 0 end as SuccessCount,\n      case when Payload->>''$.status.report.Success''
    = ''false'' then 1 else 0 end as FailureCount\n    from k8s_resource\n    where
    ApiKind = ''WatchDog''\n  ) as ss\n  where CheckerName not like ''Sql%'' and CheckerName
    not like ''MachineCount%''\n  group by CheckerName\n) as ss2", "watchdogFrequency":
    "60m"}, {"name": "WatchdogSuccessPctByKingdom", "sql": "select UPPER(kingdom)
    as Kingdom, ''NONE'' as SuperPod, ControlEstate as Estate,\n''sql.checkerPassPctPerKingdom''
    as Metric, SuccessPct as Value, CONCAT(''CheckerName='',CheckerName) as Tags\nfrom
    (\n  select\n    ControlEstate,\n    Kingdom,\n    CheckerName,\n    SUM(SuccessCount)/(SUM(SuccessCount)+SUM(FailureCount))
    as SuccessPct\n  from\n  (\n    select\n      substr(ControlEstate,1,3) AS Kingdom,\n      ControlEstate,\n      Payload->>''$.status.report.CheckerName''
    as CheckerName,\n      case when Payload->>''$.status.report.Success'' = ''true''
    then 1 else 0 end as SuccessCount,\n      case when Payload->>''$.status.report.Success''
    = ''false'' then 1 else 0 end as FailureCount\n    from k8s_resource\n    where
    ApiKind = ''WatchDog''\n  ) as ss\n  where CheckerName not like ''Sql%'' and CheckerName
    not like ''MachineCount%''\n  group by CheckerName, ControlEstate, Kingdom\n)
    as ss2", "watchdogFrequency": "60m"}, {"name": "Sql95thPctPRLatencyOverLast24Hr",
    "sql": "SELECT latency as PRLatency95PctOverLast24Hr FROM\n     ( SELECT\n         prLatency.*,\n         @row_num
    :=@row_num + 1 AS row_num\n    FROM\n        (\n        SELECT\n            prs.pr_num,\n            MAX(TIMESTAMPDIFF(MINUTE,prs.merged_time,
    CASE WHEN payload -> ''$.status.endTime'' = ''0001-01-01T00:00:00Z'' THEN CURRENT_TIMESTAMP()
    ELSE payload -> ''$.status.endTime'' END  )) latency\n    FROM\n        PullRequests
    prs\n    LEFT  JOIN\n            (\n            SELECT *\n            FROM\n            crd_history\n            WHERE
    ApiKind = ''Bundle'') crds\n        ON crds.PRNum = prs.pr_num\n    WHERE state
    =''merged'' AND `merged_time` > NOW() - INTERVAL 24 HOUR\n    GROUP BY prs.pr_num\n    )
    prLatency ,\n     (SELECT @row_num:=0) counter ORDER BY prLatency.latency\n     )\n    temp
    WHERE temp.row_num = ROUND (.95* @row_num)", "watchdogFrequency": "15m"}], "sql_alerts":
    [{"alertAction": "email", "alertFrequency": "24h", "alertProfile": "sam", "alertThreshold":
    "10m", "instructions": "The following deployments are reported as bad customer
    deployments in Production. Debug Instructions: https://git.soma.salesforce.com/sam/sam/wiki/Debug-Failed-Deployment",
    "name": "SqlSlaDepl", "sql": "SELECT * FROM\n                        (\n                          SELECT\n                            ControlEstate,\n                            Namespace,\n                            Name,\n                            JSON_EXTRACT(Payload,
    ''$.metadata.annotations.\"smb.sam.data.sfdc.net/emailTo\"'') AS email,\n                            CASE
    WHEN JSON_EXTRACT(Payload, ''$.metadata.labels.sam_app'') is NULL then False\n                                 ELSE
    True END AS IsSamApp,\n                            JSON_EXTRACT(Payload, ''$.spec.replicas'')
    AS desiredReplicas,\n                            JSON_EXTRACT(Payload, ''$.status.availableReplicas'')
    AS availableReplicas,\n                            JSON_EXTRACT(Payload, ''$.status.updatedReplicas'')
    AS updatedReplicas,\n                            (JSON_EXTRACT(Payload, ''$.spec.replicas'')
    - JSON_EXTRACT(Payload, ''$.status.availableReplicas'')) AS kpodsDown,\n                            COALESCE(JSON_EXTRACT(Payload,
    ''$.status.availableReplicas'') /nullif(JSON_EXTRACT(Payload, ''$.spec.replicas''),
    0), 0) AS availability,\n                            0.6 as minAvailability,\n                            CONCAT(''http://dashboard-'',SUBSTR(ControlEstate,
    1, 3),''-sam.csc-sam.prd-sam.prd.slb.sfdc.net/#!/deployment/'',Namespace,''/'',Name,''?namespace='',Namespace)
    AS Url\n                            FROM k8s_resource\n                            WHERE
    ApiKind = ''Deployment''\n                        ) AS ss\n                        WHERE\n                           isSamApp
    AND\n                           ( Namespace != ''sam-watchdog'' AND Namespace
    != ''sam-system'' AND Namespace != ''csc-sam'' AND Namespace NOT LIKE ''%slb%''
    AND Namespace NOT LIKE ''%user%'') AND\n                           (availableReplicas
    != desiredReplicas OR availableReplicas IS NULL) AND\n                           (availability
    IS NULL OR availability < 0.6) AND\n                           (kpodsDown IS NULL
    OR kpodsDown >1) AND\n                           NOT ControlEstate LIKE ''prd-%''
    AND\n                           ControlEstate != ''unknown'' AND\n                           desiredReplicas
    > 1", "watchdogFrequency": "10m"}, {"alertAction": "email", "alertFrequency":
    "24h", "alertProfile": "sam", "alertThreshold": "10m", "instructions": "The following
    minion pools have multiple nodes down in Production requiring immediate attention
    according to our SLA. Debug Instructions: https://git.soma.salesforce.com/sam/sam/wiki/Repair-Failed-SAM-Host",
    "name": "SqlSlaNode", "sql": "SELECT\n              \tminionpool,\n              \tTotalCount,\n              \tNotReadyCount,\n              \tNotReadyPerc\n              FROM\n              (\n              SELECT\n                      minionpool,\n                      TotalCount
    ,\n                      NotReadyCount,\n                      (NotReadyCount/TotalCount)
    as ''NotReadyPerc''\n\n              FROM\n              (\n                  SELECT\n                        COUNT(*)
    as TotalCount,\n                        SUM(CASE WHEN READY = ''True'' THEN 0
    ELSE 1 END) as NotReadyCount,\n                        minionpool\n                  FROM\n                        nodeDetailView\n                  WHERE\n                        KINGDOM
    != ''PRD'' AND KINGDOM != ''UNK''\n                        AND minionpool NOT
    LIKE ''%ceph%''\n                  GROUP BY minionpool\n              ) ss\n              )
    ss2\n              WHERE (TotalCount < 10 AND NotReadyCount >=2) OR (TotalCount
    >= 10 AND NotReadyPerc >=0.2)", "watchdogFrequency": "10m"}, {"alertAction": "email",
    "alertFrequency": "24h", "alertProfile": "sam", "alertThreshold": "10m", "instructions":
    "The following SAM control stack components dont have even 1 healhty pod", "name":
    "SqlSamControl", "sql": "SELECT * FROM\n                  (\n                    SELECT\n                      ControlEstate,\n                      Namespace,\n                      Name,\n                      JSON_EXTRACT(Payload,
    ''$.spec.replicas'') AS desiredReplicas,\n                      JSON_EXTRACT(Payload,
    ''$.status.availableReplicas'') AS availableReplicas,\n                      JSON_EXTRACT(Payload,
    ''$.status.updatedReplicas'') AS updatedReplicas,\n                      (JSON_EXTRACT(Payload,
    ''$.spec.replicas'') - JSON_EXTRACT(Payload, ''$.status.availableReplicas''))
    AS kpodsDown,\n                      COALESCE(JSON_EXTRACT(Payload, ''$.status.availableReplicas'')
    /nullif(JSON_EXTRACT(Payload, ''$.spec.replicas''), 0), 0) AS availability,\n                      CONCAT(''http://dashboard-'',SUBSTR(ControlEstate,
    1, 3),''-sam.csc-sam.prd-sam.prd.slb.sfdc.net/#!/deployment/'',Namespace,''/'',Name,''?namespace='',Namespace)
    AS Url\n                      FROM k8s_resource\n                      WHERE ApiKind
    = ''Deployment''\n                  ) AS ss\n                  WHERE\n                     Namespace
    = ''sam-system'' AND\n                     (availableReplicas < 1 OR availableReplicas
    IS NULL) AND\n                     ControlEstate NOT LIKE ''%sdc%'' AND\n                     ControlEstate
    NOT LIKE ''%storage%'' AND\n                     ControlEstate NOT LIKE ''%sdn%''
    AND\n                     ControlEstate NOT LIKE ''%slb%'' AND\n                     desiredReplicas
    != 0", "watchdogFrequency": "10m"}, {"alertAction": "email", "alertFrequency":
    "24h", "alertProfile": "sam", "alertThreshold": "10m", "instructions": "Following
    PRs have failed to get deployed within 45 minutes of getting merged.", "name":
    "SqlPRLatency", "sql": "SELECT \n \tpr_num\nFROM \n\t(\n\tSELECT \t\n   \t\tprs.pr_num,\n   \t\tTIMESTAMPDIFF(MINUTE,prs.merged_time,
    CASE WHEN payload -> ''$.status.endTime'' = ''0001-01-01T00:00:00Z'' THEN CURRENT_TIMESTAMP()
    ELSE payload -> ''$.status.endTime'' END  ) latency\nFROM \n\tPullRequests prs\nLEFT  JOIN  \n\t\t(\n\t\tSELECT
    * \n\t\tFROM \n\t\tcrd_history \n\t \tWHERE ApiKind = ''Bundle'') crds\n\tON crds.PRNum
    = prs.pr_num\nORDER BY prs.pr_num \n) prLatency\nWHERE latency > 45", "watchdogFrequency":
    "10m"}, {"alertAction": "email", "alertFrequency": "24h", "alertProfile": "sam",
    "alertThreshold": "10m", "instructions": "Following PRs don''t have authorization
    link after 6 minutes of getting created.", "name": "SqlPRAuthroizationLinkPostTimeLatency",
    "sql": "SELECT\n          * \n        FROM (SELECT \n            pr_num,\n            TIMESTAMPDIFF(MINUTE,
    CASE WHEN first_approval_link_posted_time IS NULL THEN now() ELSE first_approval_link_posted_time
    END, created_time) latency,\n            first_approval_link_posted_time,\n            created_time\n        FROM
    PullRequests \n        WHERE created_time IS NOT NULL AND state =''open'') noApprovalLink\n        WHERE
    noApprovalLink.latency > 6 AND pr_num > 1000\n        ORDER BY latency desc",
    "watchdogFrequency": "10m"}, {"alertAction": "email", "alertFrequency": "24h",
    "alertProfile": "sam", "alertThreshold": "10m", "instructions": "Following PRs
    haven''t run evaluatePR more than 30 mins after getting authorized.", "name":
    "SqlPRFailtedToRunEvalPR", "sql": "SELECT \n         *\n        FROM\n        (SELECT
    \n          pr_num,\n          created_time,\n          evaluate_pr_status,\n          authorized_by,\n          most_recent_authorized_time,\n          TIMESTAMPDIFF(MINUTE,
    now(), most_recent_authorized_time) latency\n        FROM PullRequests\n        WHERE
    created_time IS NOT NULL AND authorized_by IS NOT NULL AND authorized_by !=''''
    AND (`evaluate_pr_status` IS NULL OR evaluate_pr_status = ''unknown'') AND most_recent_authorized_time
    IS NOT NULL\n            AND state =''open''\n        ) authedButUnkwn\n        WHERE
    authedButUnkwn.latency > 30 AND pr_num > 1000", "watchdogFrequency": "10m"}, {"alertAction":
    "email", "alertFrequency": "24h", "alertProfile": "sam", "alertThreshold": "10m",
    "instructions": "Following PRs have failed to produce corresponding manifest.zip
    file after 30 minutes of getting  merged.", "name": "SqlPRFailedToProduceManifestZip",
    "sql": "SELECT \n             *   \n            FROM\n            (SELECT \n              pr_num,\n              manifest_zip_time,\n              merged_time,\n              TIMESTAMPDIFF(MINUTE,
    CASE WHEN manifest_zip_time IS NULL THEN now() ELSE manifest_zip_time END, `merged_time`)
    latency\n            FROM PullRequests\n            WHERE state =''merged'' AND
    (manifest_zip_version IS  NULL OR manifest_zip_version = '''')  AND `merged_time`
    > NOW() - INTERVAL 10 DAY\n            ) manifestZip\n            WHERE manifestZip.latency
    > 30 AND pr_num > 11927", "watchdogFrequency": "10m"}, {"alertAction": "email",
    "alertFrequency": "24h", "alertProfile": "sam", "instructions": "Following PRs
    have at least one image that''s not available after 20 minutes of getting it merged",
    "name": "SqlPRImageUnavailable", "sql": "SELECT \n                *\n            FROM
    \n                (\n                SELECT \t\n                    prs.pr_num,\n                    crds.PoolName,\n                    crds.ControlEstate,\n                    TIMESTAMPDIFF(MINUTE,
    CASE WHEN payload -> ''$.status.maxImageEndTime'' = ''0001-01-01T00:00:00Z'' THEN
    CURRENT_TIMESTAMP() ELSE payload -> ''$.status.maxImageEndTime'' END, prs.merged_time)
    latencyMin\n            FROM \n                PullRequests prs\n            LEFT  JOIN  \n                    (\n                    SELECT
    * \n                    FROM \n                    crd_history \n                    WHERE
    ApiKind = ''Bundle'') crds\n                ON crds.PRNum = prs.pr_num \n            ORDER
    BY prs.pr_num \n            ) imageLatency\n            WHERE  latencyMin > 20",
    "watchdogFrequency": "10m"}]}'
kind: ConfigMap
metadata:
  creationTimestamp: null
  labels:
    sam.data.sfdc.net/owner: sam
  name: watchdogsamsqlqueries
  namespace: sam-system
