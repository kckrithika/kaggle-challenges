{
   "apiVersion": "extensions/v1beta1",
   "kind": "Deployment",
   "metadata": {
      "labels": {
         "app": "stampy-webhook"
      },
      "name": "stampy-webhook-deployment",
      "namespace": "stampy-webhook"
   },
   "spec": {
      "replicas": 1,
      "selector": {
         "matchLabels": {
            "app": "stampy-webhook",
            "name": "stampy-webhook"
         }
      },
      "template": {
         "metadata": {
            "annotations": {
               "madkub.sam.sfdc.net/allcerts": "{\n \"certreqs\": [\n  {\n   \"cert-type\": \"server\",\n   \"kingdom\": \"prd\",\n   \"name\": \"cert1\",\n   \"role\": \"stampy-webhook\",\n   \"san\": [\n    \"stampy-webhook\",\n    \"stampy-webhook.stampy-webhook\",\n    \"stampy-webhook.stampy-webhook.svc\",\n    \"stampy-webhook.stampy-webhook.svc.cluster.local\",\n    \"stampy-webhook.stampy-webhook.svc.prd-samtest.prd.sam.sfdc.net\"\n   ]\n  },\n  {\n   \"cert-type\": \"client\",\n   \"kingdom\": \"prd\",\n   \"name\": \"cert2\",\n   \"role\": \"stampy-webhook\",\n   \"san\": [\n    \"stampy-webhook\",\n    \"stampy-webhook.stampy-webhook\",\n    \"stampy-webhook.stampy-webhook.svc\",\n    \"stampy-webhook.stampy-webhook.svc.cluster.local\",\n    \"stampy-webhook.stampy-webhook.svc.prd-samtest.prd.sam.sfdc.net\"\n   ]\n  }\n ]\n}",
               "scheduler.alpha.kubernetes.io/critical-pod": ""
            },
            "labels": {
               "app": "stampy-webhook",
               "name": "stampy-webhook"
            }
         },
         "spec": {
            "containers": [
               {
                  "args": [
                     "-log-level=debug",
                     "-tls-port=17772",
                     "-http-port=17773",
                     "-cert-file-path=/server-certs/server/certificates/server.pem",
                     "-key-file-path=/server-certs/server/keys/server-key.pem"
                  ],
                  "env": [
                     {
                        "name": "SFDC_ENVIRONMENT",
                        "value": "stampy"
                     },
                     {
                        "name": "SETTINGS_SERVICENAME",
                        "value": "stampy-webhook"
                     },
                     {
                        "name": "FUNCTION_NAMESPACE",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "metadata.namespace"
                           }
                        }
                     },
                     {
                        "name": "FUNCTION_INSTANCE_NAME",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "metadata.name"
                           }
                        }
                     },
                     {
                        "name": "FUNCTION_INSTANCE_IP",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "status.podIP"
                           }
                        }
                     },
                     {
                        "name": "FUNCTION",
                        "value": "stampy-webhook"
                     },
                     {
                        "name": "KINGDOM",
                        "value": "prd"
                     },
                     {
                        "name": "ESTATE",
                        "value": "prd-samtest"
                     },
                     {
                        "name": "SUPERPOD",
                        "value": "-"
                     },
                     {
                        "name": "SETTINGS_SUPERPOD",
                        "value": "-"
                     },
                     {
                        "name": "SETTINGS_PATH",
                        "value": "stampy.-.prd.-.stampy-webhook"
                     },
                     {
                        "name": "SFDC_SETTINGS_PATH",
                        "value": "stampy.-.prd.-.stampy-webhook"
                     },
                     {
                        "name": "SFDC_METRICS_SERVICE_HOST",
                        "value": "ajnafunneldirecttls.funnel.localhost.mesh.force.com"
                     },
                     {
                        "name": "SFDC_METRICS_SERVICE_PORT",
                        "value": "5442"
                     },
                     {
                        "name": "FAKE_REDEPLOY_VAR",
                        "value": "1"
                     }
                  ],
                  "image": "ops0-artifactrepo2-0-prd.data.sfdc.net/dva/stampy-webhook-admission-controller-1p:3",
                  "imagePullPolicy": "Always",
                  "livenessProbe": {
                     "exec": {
                        "command": [
                           "./is-alive.sh",
                           "17442",
                           "/client-certs/client/certificates/client.pem",
                           "/client-certs/client/keys/client-key.pem"
                        ]
                     },
                     "initialDelaySeconds": 2,
                     "periodSeconds": 3
                  },
                  "name": "injector",
                  "ports": [
                     {
                        "containerPort": 17442
                     }
                  ],
                  "readinessProbe": {
                     "exec": {
                        "command": [
                           "./is-ready.sh",
                           "17442",
                           "/client-certs/client/certificates/client.pem",
                           "/client-certs/client/keys/client-key.pem"
                        ]
                     },
                     "initialDelaySeconds": 4,
                     "periodSeconds": 3
                  },
                  "resources": {
                     "limits": {
                        "sam.sfdc.net/ip-address": "1"
                     },
                     "requests": {
                        "sam.sfdc.net/ip-address": "1"
                     }
                  },
                  "terminationMessagePolicy": "FallbackToLogsOnError",
                  "volumeMounts": [
                     {
                        "mountPath": "/server-certs",
                        "name": "cert1"
                     },
                     {
                        "mountPath": "/client-certs",
                        "name": "cert2"
                     }
                  ]
               },
               {
                  "args": [
                     "/sam/madkub-client",
                     "--madkub-endpoint=https://10.254.208.254:32007",
                     "--maddog-endpoint=https://all.pkicontroller.pki.blank.prd.prod.non-estates.sfdcsd.net:8443",
                     "--maddog-server-ca=/maddog-certs/ca/security-ca.pem",
                     "--madkub-server-ca=/maddog-certs/ca/cacerts.pem",
                     "--cert-folders=cert1:/cert1/",
                     "--cert-folders=cert2:/cert2/",
                     "--token-folder=/tokens/",
                     "--ca-folder=/maddog-certs/ca",
                     "--refresher",
                     "--run-init-for-refresher-mode"
                  ],
                  "env": [
                     {
                        "name": "MADKUB_NODENAME",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "spec.nodeName"
                           }
                        }
                     },
                     {
                        "name": "MADKUB_NAME",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "metadata.name"
                           }
                        }
                     },
                     {
                        "name": "MADKUB_NAMESPACE",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "metadata.namespace"
                           }
                        }
                     },
                     {
                        "name": "ESTATE",
                        "value": "prd-samtest"
                     }
                  ],
                  "image": "ops0-artifactrepo2-0-prd.data.sfdc.net/docker-release-candidate/tnrp/sam/madkub:1.0.0-0000082-3d5c21b4",
                  "imagePullPolicy": "IfNotPresent",
                  "name": "madkub-refresher",
                  "volumeMounts": [
                     {
                        "mountPath": "/cert1",
                        "name": "cert1"
                     },
                     {
                        "mountPath": "/cert2",
                        "name": "cert2"
                     },
                     {
                        "mountPath": "/maddog-certs/",
                        "name": "maddog-certs"
                     },
                     {
                        "mountPath": "/tokens",
                        "name": "tokens"
                     }
                  ]
               }
            ],
            "initContainers": [
               {
                  "args": [
                     "/sam/madkub-client",
                     "--madkub-endpoint=https://10.254.208.254:32007",
                     "--maddog-endpoint=https://all.pkicontroller.pki.blank.prd.prod.non-estates.sfdcsd.net:8443",
                     "--maddog-server-ca=/maddog-certs/ca/security-ca.pem",
                     "--madkub-server-ca=/maddog-certs/ca/cacerts.pem",
                     "--cert-folders=cert1:/cert1/",
                     "--cert-folders=cert2:/cert2/",
                     "--token-folder=/tokens/",
                     "--ca-folder=/maddog-certs/ca"
                  ],
                  "env": [
                     {
                        "name": "MADKUB_NODENAME",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "spec.nodeName"
                           }
                        }
                     },
                     {
                        "name": "MADKUB_NAME",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "metadata.name"
                           }
                        }
                     },
                     {
                        "name": "MADKUB_NAMESPACE",
                        "valueFrom": {
                           "fieldRef": {
                              "apiVersion": "v1",
                              "fieldPath": "metadata.namespace"
                           }
                        }
                     },
                     {
                        "name": "ESTATE",
                        "value": "prd-samtest"
                     }
                  ],
                  "image": "ops0-artifactrepo2-0-prd.data.sfdc.net/docker-release-candidate/tnrp/sam/madkub:1.0.0-0000082-3d5c21b4",
                  "imagePullPolicy": "IfNotPresent",
                  "name": "madkub-init",
                  "volumeMounts": [
                     {
                        "mountPath": "/cert1",
                        "name": "cert1"
                     },
                     {
                        "mountPath": "/cert2",
                        "name": "cert2"
                     },
                     {
                        "mountPath": "/maddog-certs/",
                        "name": "maddog-certs"
                     },
                     {
                        "mountPath": "/tokens",
                        "name": "tokens"
                     }
                  ]
               },
               {
                  "command": [
                     "bash",
                     "-c",
                     "set -ex\nchmod 775 -R /cert1 && chown -R 7447:7447 /cert1\nchmod 775 -R /cert2 && chown -R 7447:7447 /cert2\n"
                  ],
                  "image": "ops0-artifactrepo2-0-prd.data.sfdc.net/docker-release-candidate/tnrp/sam/hypersam:sam-c07d4afb-673",
                  "imagePullPolicy": "IfNotPresent",
                  "name": "permissionsetterinitcontainer",
                  "securityContext": {
                     "runAsNonRoot": false,
                     "runAsUser": 0
                  },
                  "volumeMounts": [
                     {
                        "mountPath": "/cert1",
                        "name": "cert1"
                     },
                     {
                        "mountPath": "/cert2",
                        "name": "cert2"
                     }
                  ]
               }
            ],
            "nodeSelector": {
               "master": "true"
            },
            "volumes": [
               {
                  "hostPath": {
                     "path": "/etc/pki_service"
                  },
                  "name": "maddog-certs"
               },
               {
                  "hostPath": {
                     "path": "/etc/kubernetes"
                  },
                  "name": "kubeconfig"
               },
               {
                  "emptyDir": {
                     "medium": "Memory"
                  },
                  "name": "cert1"
               },
               {
                  "emptyDir": {
                     "medium": "Memory"
                  },
                  "name": "cert2"
               },
               {
                  "emptyDir": {
                     "medium": "Memory"
                  },
                  "name": "tokens"
               },
               {
                  "configMap": {
                     "name": "stampy-webhook-configs-data"
                  },
                  "name": "stampy-webhook-configs-data-volume"
               }
            ]
         }
      }
   }
}
