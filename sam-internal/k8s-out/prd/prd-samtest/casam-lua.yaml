apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  annotations:
    manifestctl.sam.data.sfdc.net/swagger: disable
  name: casam-lua-filter
spec:
  filters:
  - filterConfig:
      inlineCode: |
        function envoy_on_request(request_handle)
            request_handle:logInfo("Calling Lua Script")
            -- Log all headers
            for key, value in pairs(request_handle:headers()) do
                request_handle:logDebug("header key " .. key .. " value " .. value)
            end
            -- Remove ciphersuite header for all incoming requests.
            request_handle:headers():remove("CipherSuite")
            -- Add a dummy CipherSuite header if the downstream connection uses ssl.
            if request_handle:connection():ssl() ~= nil then
                request_handle:logDebug("adding dummy cipher suite")
                request_handle:headers():add("CipherSuite", "https")
            end
        end
    filterName: envoy.lua
    filterType: HTTP
    listenerMatch:
      listenerProtocol: HTTP
      listenerType: GATEWAY
      portNumber: 8085
  workloadLabels:
    istio: ingressgateway
