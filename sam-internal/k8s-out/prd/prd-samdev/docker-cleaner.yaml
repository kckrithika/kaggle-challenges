apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  labels:
    name: docker-cleaner
    sam.data.sfdc.net/owner: sam
  name: docker-cleaner
  namespace: sam-system
spec:
  template:
    metadata:
      labels:
        name: docker-cleaner
        sam.data.sfdc.net/owner: sam
    spec:
      containers:
      - command:
        - sh
        - -c
        - |
          while true
          do
            usedCowdataPercent=`df -h /cowdata/ | tail -1 | awk '{print $5}'  | cut -f 1 -d %`
            if [ $usedCowdataPercent -gt 75 ]; then
              echo "used $usedCowdataPercent % in /cowdata, starting cleaning"
              docker system prune -af
              if [[ `hostname` == "shared0-samdevcompute1-1-prd.eng.sfdc.net" ]]; then
                docker load -i /opt/kubernetes/images/etcd.tar
                echo "loaded etcd image on `hostname`"
              else
                echo "skipping loading of etcd since it's not a Jenkins machine"
              fi
            else
              echo "only used $usedCowdataPercent %, not doing cleaning"
            fi
            echo "about to sleep at `date`"
            sleep 604800
            echo "done sleeping, new time `date`"
          done
        image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-devmvp/tkuznets/docker:dind
        name: docker-cleaner
        volumeMounts:
        - mountPath: /cowdata
          name: cowdata
        - mountPath: /opt/kubernetes/images
          name: images
        - mountPath: /var/run/docker.sock
          name: docker-socket
      securityContext:
        fsGroup: 0
        runAsUser: 0
      volumes:
      - hostPath:
          path: /opt/kubernetes/images/
        name: images
      - hostPath:
          path: /cowdata/
        name: cowdata
      - hostPath:
          path: /var/run/docker.sock
        name: docker-socket
