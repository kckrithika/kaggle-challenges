apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    service: prometheus-scraper
  name: prometheus-scraper
  namespace: flowsnake
spec:
  minReadySeconds: 15
  replicas: 1
  selector:
    matchLabels:
      service: prometheus-scraper
  template:
    metadata:
      labels:
        apptype: monitoring
        flowsnakeOwner: dva-transform
        flowsnakeRole: PrometheusScraper
        name: prometheus-scraper
        service: prometheus-scraper
    spec:
      containers:
      - args:
        - --config.file=/etc/config/prometheus.json
        - --storage.tsdb.path=/prometheus-storage
        - --web.external-url=http://localhost/
        - --web.enable-lifecycle
        image: ops0-artifactrepo1-0-cdu.data.sfdc.net/dva/prome_for_k8s:35
        livenessProbe:
          httpGet:
            path: /metrics
            port: 9090
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
        name: prometheus
        ports:
        - containerPort: 9090
        volumeMounts:
        - mountPath: /prometheus-storage
          name: prometheus-storage-volume
        - mountPath: /etc/config
          name: prometheus-server-conf
      - args:
        - --serviceName=flowsnake
        - --subserviceName=NONE
        - --tagDefault=superpod:NONE
        - --tagDefault=datacenter:cdu
        - --tagDefault=estate:cdu-flowsnake_prod
        - --batchSize=512
        - --funnelUrl=http://ajna0-funnel1-0-cdu.data.sfdc.net:80
        image: ops0-artifactrepo1-0-cdu.data.sfdc.net/dva/funnel_writer:35
        livenessProbe:
          httpGet:
            path: /
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
        name: funnel-writer
        ports:
        - containerPort: 8000
        volumeMounts:
        - mountPath: /prometheus-storage
          name: prometheus-storage-volume
      restartPolicy: Always
      serviceAccountName: prometheus-scraper
      volumes:
      - configMap:
          name: prometheus-server-conf
        name: prometheus-server-conf
      - emptyDir:
          medium: Memory
        name: prometheus-storage-volume
