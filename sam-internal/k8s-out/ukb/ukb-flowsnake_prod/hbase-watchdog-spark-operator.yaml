apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    name: watchdog-spark-operator-hbase
  name: watchdog-spark-operator-hbase
  namespace: flowsnake
spec:
  replicas: 1
  selector:
    matchLabels:
      app: watchdog-spark-operator-hbase
      apptype: monitoring
  template:
    metadata:
      annotations:
        madkub.sam.sfdc.net/allcerts: '{"certreqs": [{"cert-type": "client", "kingdom":
          "ukb", "name": "watchdogsparkoperator", "role": "flowsnake_test.flowsnake-watchdog"}]}'
      labels:
        app: watchdog-spark-operator-hbase
        apptype: monitoring
        flowsnakeOwner: dva-transform
        flowsnakeRole: WatchdogSparkOperator
    spec:
      containers:
      - command:
        - /sam/watchdog
        - -role=CLI
        - -emailFrequency=24h
        - -timeout=2s
        - -funnelEndpoint=ajna0-funnel1-0-ukb.data.sfdc.net:80
        - --config=/config/hbase-watchdog.json
        - -cliCheckerCommandTarget=SparkHbaseIntegrationTest
        - --hostsConfigFile=/sfdchosts/hosts.json
        - -watchdogFrequency=1m
        - -alertThreshold=1m
        - -cliCheckerTimeout=20m
        - -includeCommandOutput=true
        env:
        - name: DOCKER_TAG
          value: "22"
        - name: S3_PROXY_HOST
          value: public0-proxy1-0-ukb.data.sfdc.net
        - name: DRIVER_SERVICE_ACCOUNT
          value: spark-driver-flowsnake-watchdog
        - name: DOCKER_REGISTRY
          value: ops0-artifactrepo1-0-ukb.data.sfdc.net
        - name: NODENAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: KINGDOM
          value: ukb
        - name: ESTATE
          value: ukb-flowsnake_prod
        image: ops0-artifactrepo1-0-ukb.data.sfdc.net/dva/flowsnake-spark-on-k8s-integration-test-runner:22
        imagePullPolicy: IfNotPresent
        name: watchdog
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
          requests:
            cpu: "1"
            memory: 1Gi
        volumeMounts:
        - mountPath: /config
          name: config
        - mountPath: /sfdchosts
          name: sfdchosts
        - mountPath: /watchdog-spark-scripts
          name: watchdog-spark-scripts
        - mountPath: /certs
          name: datacerts
      - args:
        - /sam/madkub-client
        - --madkub-endpoint
        - https://10.254.208.254:32007
        - --maddog-endpoint
        - https://all.pkicontroller.pki.blank.ukb.prod.non-estates.sfdcsd.net:8443
        - --maddog-server-ca
        - /etc/pki_service/ca/security-ca.pem
        - --madkub-server-ca
        - /etc/pki_service/ca/cacerts.pem
        - --token-folder
        - /tokens
        - --kingdom
        - ukb
        - --superpod
        - None
        - --estate
        - ukb-flowsnake_prod
        - --refresher
        - --run-init-for-refresher-mode
        - --cert-folders
        - watchdogsparkoperator:/certs
        - --ca-folder
        - /etc/pki_service/ca
        - --funnel-endpoint
        - http://ajna0-funnel1-0-ukb.data.sfdc.net:80
        env:
        - name: MADKUB_NODENAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: MADKUB_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: MADKUB_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        image: ops0-artifactrepo1-0-ukb.data.sfdc.net/tnrp/sam/madkub:1.0.0-0000084-9f4a6ca6
        name: sam-madkub-integration-refresher
        resources: {}
        securityContext:
          runAsNonRoot: true
          runAsUser: 7337
        volumeMounts:
        - mountPath: /certs
          name: datacerts
        - mountPath: /tokens
          name: tokens
        - mountPath: /etc/pki_service/ca
          name: certificate-authority
          readOnly: true
        - mountPath: /etc/pki_service/platform/platform-client/certificates
          name: client-certificate
          readOnly: true
        - mountPath: /etc/pki_service/platform/platform-client/keys
          name: client-key
          readOnly: true
      hostNetwork: true
      initContainers:
      - args:
        - /sam/madkub-client
        - --madkub-endpoint
        - https://10.254.208.254:32007
        - --maddog-endpoint
        - https://all.pkicontroller.pki.blank.ukb.prod.non-estates.sfdcsd.net:8443
        - --maddog-server-ca
        - /etc/pki_service/ca/security-ca.pem
        - --madkub-server-ca
        - /etc/pki_service/ca/cacerts.pem
        - --token-folder
        - /tokens
        - --kingdom
        - ukb
        - --superpod
        - None
        - --estate
        - ukb-flowsnake_prod
        - --cert-folders
        - watchdogsparkoperator:/certs
        - --ca-folder
        - /etc/pki_service/ca
        - --funnel-endpoint
        - http://ajna0-funnel1-0-ukb.data.sfdc.net:80
        env:
        - name: MADKUB_NODENAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: MADKUB_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: MADKUB_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        image: ops0-artifactrepo1-0-ukb.data.sfdc.net/tnrp/sam/madkub:1.0.0-0000084-9f4a6ca6
        name: sam-madkub-integration-init
        resources: {}
        securityContext:
          runAsNonRoot: true
          runAsUser: 7337
        volumeMounts:
        - mountPath: /certs
          name: datacerts
        - mountPath: /tokens
          name: tokens
        - mountPath: /etc/pki_service/ca
          name: certificate-authority
          readOnly: true
        - mountPath: /etc/pki_service/platform/platform-client/certificates
          name: client-certificate
          readOnly: true
        - mountPath: /etc/pki_service/platform/platform-client/keys
          name: client-key
          readOnly: true
      restartPolicy: Always
      serviceAccount: watchdog-spark-operator-serviceaccount
      serviceAccountName: watchdog-spark-operator-serviceaccount
      volumes:
      - configMap:
          name: hbase-watchdog
        name: config
      - configMap:
          defaultMode: 493
          name: watchdog-spark-on-k8s-script-configmap
        name: watchdog-spark-scripts
      - configMap:
          name: sfdchosts
        name: sfdchosts
      - emptyDir:
          medium: Memory
        name: datacerts
      - emptyDir:
          medium: Memory
        name: tokens
      - hostPath:
          path: /etc/pki_service/ca
        name: certificate-authority
      - hostPath:
          path: /etc/pki_service/platform/platform-client/certificates
        name: client-certificate
      - hostPath:
          path: /etc/pki_service/platform/platform-client/keys
        name: client-key
