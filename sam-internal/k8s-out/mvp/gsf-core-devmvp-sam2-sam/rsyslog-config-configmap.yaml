apiVersion: v1
data:
  base.conf.erb: "module(load = \"imfile\")\nmodule(load = \"omkafka\")\nmodule(load
    = \"omhttp\")\nmodule(load = \"omprog\")\nmodule(load = \"mmexternal\")\nmodule(load
    = \"mmjsonparse\")\nmodule(load = \"omstdout\")\n\n# load statistics\nmodule(load=\"impstats\"
    interval=\"120\" format=\"cee\" ruleset=\"rs_impstats2funnel\")\n\nruleset(name=\"ruleset_stdout\")
    {  \n  action(type=\"omstdout\")\n}\n\n# funnel json format\ntemplate(name=\"tpl_funnel\"
    type=\"list\") {\n    constant(value=\"{\")   \n    constant(value=\"\\\"service\\\":
    \\\"system\\\"\")\n    constant(value=\",\")   \n    constant(value=\"\\\"metricName\\\":\")
    \  \n    property(name=\"$!metric_array\")\n    constant(value=\",\")   \n    constant(value=\"\\\"tags\\\":\")
    \        \n    property(name=\"$!metric_tags\")\n    # format as \"json\" to convert
    to numeric value \n    constant(value=\",\")   \n    constant(value=\"\\\"metricValue\\\":\")
    \ \n    property(name=\"$!metric_value\" format=\"json\")\n    constant(value=\",\")
    \  \n    constant(value=\"\\\"timestamp\\\":\")    \n    property(name=\"timereported\"
    dateFormat=\"unixtimestamp\" format=\"json\")\n    constant(value=\"}\\n\")\n}\n\n#
    parsed stats for debugging to file, for example\ntemplate(name=\"tpl_echo\" type=\"list\")
    {\n    property(name=\"$.stats\")\n    constant(value=\"\\n\")\n}\n\n# keep track
    of the number of metrics processed \ndyn_stats(name=\"metrics\" resettable=\"off\")\n\nruleset(name=\"rs_impstats2funnel\")
    {\n    # hack to refresh pki certs\n    action(type=\"omprog\"\n       name=\"pki_monitor\"\n
    \      binary=\"/usr/local/bin/pki_cert_monitor.py /cert1/client\"\n       queue.type=\"LinkedList\"\n
    \      queue.saveOnShutdown=\"off\"\n       queue.workerThreads=\"1\"\n       action.execOnlyOnceEveryInterval=\"1800\"\n
    \      action.resumeInterval=\"5\"\n       killUnresponsive=\"on\"\n       forceSingleInstance=\"on\")\n
    \   # task to clean up statefiles\n    action(type=\"omprog\"\n       name=\"statefile_monitor\"\n
    \      binary=\"/usr/local/bin/clean_statefiles.py\"\n       queue.type=\"LinkedList\"\n
    \      queue.saveOnShutdown=\"off\"\n       queue.workerThreads=\"1\"\n       action.execOnlyOnceEveryInterval=\"1800\"\n
    \      action.resumeInterval=\"5\"\n       killUnresponsive=\"on\"\n       forceSingleInstance=\"on\")
    \      \n    \n    # write to stdout\n    call ruleset_stdout   \n    \n    #
    parse the cee formatted impstats input\n    action(type=\"mmjsonparse\" container=\"$.stats\")\n
    \   \n    # after mmjsonparse, \"name\", \"origin\", and \"values\" are special
    fields\n    # \"values\" may not be present depending on the source of the stat\n
    \   # the message looks like this for normal builtin stats counter\n    #   {
    \"name\": \"main Q\", \"origin\": \"core.queue\", \"size\": 5, \"enqueued\": 11,
    \"full\": 0, \"discarded.full\": 0, \"discarded.nf\": 0, \"maxqsize\": 6  }\n
    \   # if dynamic counters are used (dyn_stats/dyn_inc), then there will be a values
    field with metrics\n    #   { \"name\": \"global\", \"origin\": \"dynstats\",
    \"values\": { \"metrics.ops_overflow\": 0, \"metrics.new_metric_add\": 0, \"metrics.no_metric\":
    0, \"metrics.metrics_purged\": 0, \"metrics.ops_ignored\": 0, \"metrics.purge_triggered\":
    0  }  }\n\n    # replace/normalize characters, \"main Q\" -> \"main_Q\", \"resource-usage\"
    -> \"resource_usage\"\n    set $.source = replace(replace(replace($.stats!name,
    \" \", \"_\"), \"-\", \"_\"), \":\", \"_\");\n    \n    # whitelist metric sources\n
    \   if (not (\n        $.source == \"omhttp\" or \n        $.source == \"omkafka\"
    or \n        $.source == \"main_Q\" or \n        $.source == \"resource_usage\"
    or \n        $.source == \"metrics\" or \n        $.source == \"container_events_total\"
    or \n        $.source == \"imdocker\" or\n        $.source == \"imudp\"\n    ))
    then {\n        stop\n    }\n    set $.metric_prefix = \"rsyslog.impstats\" &
    \".\" & $.source;\n\n    # handle \"values\" case by looping through appropriate
    json object\n    # strlen seems to be the best way of checking if the field exists\n
    \   if (strlen($.stats!values) > 0) then {\n        set $.stats_loop = $.stats!values;\n
    \   } else {\n        set $.stats_loop = $.stats;\n    }\n\n    # build common
    tags \n    set $!metric_tags!device= \"<%=config.node%>\";\n    set $!metric_tags!datacenter
    = \"<%=config.include?(:kingdom) ? config.kingdom : 'mvp'%>\";\n    set $!metric_tags!superpod
    = \"NONE\";\n    set $!metric_tags!region = \"<%=config.region%>\";\n    set $!metric_tags!zone
    = \"<%=config.zone%>\";\n    set $!metric_tags!substrate = \"<%=config.include?(:substrate)
    ? config.substrate : 'gcp' %>\";\n    set $!metric_tags!account = \"<%=config.include?(:account_name)
    ? config.account_name : config.project_id %>\";\n    set $!metric_tags!io.kubernetes.cluster.name
    = \"<%=config.cluster%>\";\n\n    foreach ($.s in $.stats_loop) do {\n        #
    $.s looks like {\"key\" : <k>, \"value\" : <v>} when using foreach loop \n        #
    ignore special values that are not metric identifiers\n        if ($.s!key ==
    \"name\" or $.s!key == \"origin\") then {\n            # continue does not skip
    the rest of the loop, just a nop\n            continue\n        } else {\n            #
    bookkeeping\n            set $.inc = dyn_inc(\"metrics\", \"count\");\n            if
    ($.source == \"container_events_total\") then {\n              # use a fixed metrics
    name\n              set $.metric_full = $.metric_prefix;\n              set $!metric_array
    = \"[\" & wrap(replace($.metric_full, \".\", \"\\\",\\\"\"), \"\\\"\") & \"]\";\n
    \             # set tags for contaienr event count metrics\n              set
    $!metric_tags!io.kubernetes.pod.name = field($.s!key, 95, 1);\n              set
    $!metric_tags!io.kubernetes.pod.namespace = field($.s!key, 95, 2);\n              set
    $!metric_tags!io.kubernetes.container.name = field($.s!key, 95, 3);               \n
    \           } else {\n              # convert \"-\", \" \", \":\" to \"_\"\n              set
    $.metric = replace(replace(replace($.s!key, \" \", \"_\"), \"-\", \"_\"), \":\",
    \"_\");\n              # build dot deliminated metric string\n              set
    $.metric_full = $.metric_prefix & \".\" & $.metric;\n              # build array\n
    \             # 1. replace \".\" with \"\\\",\\\"\", \"my.metric\" -> \"my\\\",\\\"metric\"\n
    \             # 2. wrap result in escaped quotes, \"my\\\",\\\"metric\" -> \"\\\"my\\\",\\\"metric\\\"\"\n
    \             # 3. wrap in square brackets, \"\\\"my\\\",\\\"metric\\\"\" -> \"[\\\"my\\\",\\\"metric\\\"]\"\n
    \             set $!metric_array = \"[\" & wrap(replace($.metric_full, \".\",
    \"\\\",\\\"\"), \"\\\"\") & \"]\";\n\n              # set tags for rsyslog metrics\n
    \             set $!metric_tags!io.kubernetes.pod.name = \"<%=config.pod_name%>\";\n
    \             set $!metric_tags!io.kubernetes.pod.namespace = \"<%=config.pod_namespace%>\";\n
    \             set $!metric_tags!io.kubernetes.container.name = \"rsyslog\";\n
    \           }\n\n            # set metric value\n            set $!metric_value
    = $.s!value;\n            \n            # send it!\n            action(\n                name=\"action_funnel_omhttp\"\n
    \               type=\"omhttp\"\n                template=\"tpl_funnel\"\n                server=\"ajnafunneldirecttls.funnel.localhost.mesh.force.com\"\n
    \               serverport=\"5442\"\n                restpath=\"funnel/v1/publishBatch?avroSchemaFingerprint=AVG7NnlcHNdk4t_zn2JBnQ\"\n
    \               usehttps=\"off\"\n                batch=\"on\"\n                batch.maxsize=\"300\"\n
    \               batch.maxbytes=\"1000000\" # ~1Mb\n                batch.format=\"jsonarray\"\n
    \               compress=\"on\"\n                queue.type=\"LinkedList\"\n                queue.discardseverity=\"5\"\n
    \               queue.size=\"1000\"\n                queue.discardmark=\"900\"\n
    \               queue.lightdelaymark=\"1000\"\n                queue.fulldelaymark=\"1000\"\n
    \           )\n        }\n    }\n}\n"
  container.conf.erb: |
    <%# INPUT DEFINITIONS %>
    <%# Collect log files in /var/log/container %>
    input(
      type="imfile"
      File="/var/log/containers/*.log"
      PersistStateInterval="500"
      Tag="kubernetes"
      ruleset="kubernetes_dockercontainers_ruleset"
      addmetadata="on"
      escapelf="off"
      discardTruncatedMsg="on"
    )

    dyn_stats(name="container_events_total" resettable="off")

    <%# ------- Start of definition of schema templates ------- %>

    <%# Align universal schema envelope %>
    template(name="tpl_containers_log" type="list") {
      constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"event-envelope:1\",\"data\":{")
      constant(value="\"event\":")
      property(name="$!event")
      constant(value=",")
      property(name="$!hostname" format="jsonfr")
      constant(value=",")
      property(name="$!logdata!time" outname="event_timestamp" format="jsonfr")
      constant(value=",")
      property(name="timegenerated" outname="agent_timestamp" dateFormat="rfc3339" date.inUTC="on" format="jsonfr")
      constant(value=",")
      property(name="$!owner" outname="owner" format="jsonfr")
      constant(value=",\"annotations\": ")
      property(name="$!annotations")
      constant(value="}}\n")
    }

    <%# kubernetes container logs event %>
    template(name="kubernetes_event" type="list") {
      constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"kubernetes:1\",\"data\":{")
      property(name="$!logdata!log" outname="message" format="jsonf")
      constant(value=",")
      property(name="$!severity" outname="severity" format="jsonfr")
      constant(value="}}")
    }

    <%# rsyslog base annotations %>
    template(name = "kubernetes_annotation_rsyslog_base" type="list") {
      constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"rsyslog-base:1\",\"data\":{")
      constant(value="\"source\": \"<%=config.account_name %>\"")
      constant(value=",\"source_type\": \"container\"")
      constant(value=",")
      property(name="$!datacenter" outname="dc" format="jsonfr")
      constant(value=",")
      property(name="$!substrate" outname="substrate" format="jsonfr")
      constant(value=",")
      property(name="$!account" outname="account" format="jsonfr")
      constant(value=",")
      property(name="$!region" outname="region" format="jsonfr")
      constant(value=",")
      property(name="$!zone" outname="zone" format="jsonfr")
      constant(value=",")
      constant(value="\"index\": \"true\"")
      constant(value="}}")
    }

    <%# container logs anotations %>
    template(name = "kubernetes_annotation_kubernetes_container" type="list") {
      constant(value = "{\"schema_type\":\"json-schema\",\"schema_id\":\"kubernetes-container:1\",\"data\":")
      property(name = "$!kubernetes_container_data")
      constant(value = "}")
    }

    ruleset(name = "kubernetes_dockercontainers_ruleset") {
      <%# mmjsonparse to parse log message %>
      action(type="mmjsonparse" cookie="" container="$!logdata")

      set $!hostname = "<%=config.node%>";
      set $!owner = "none";

      if $!logdata!stream == 'stderr' then {
        set $!severity = "error";
      } else {
        set $!severity = "info";
      }

      <%# ------------ parsing kubernetes container annotation information -------------%>
      <%# retrieve file name from /var/log/containers/kube-proxy-gke-gao-collection-poc-larger-pool-7372f548-5v3r_kube-system_kube-proxy-7a7cad04f5245c7d12f05e380b9f3a77098d01ff36184529c245e57463c3686a.log %>
      set $.file_name = field($!metadata!filename, 47, 5);

      <%# [POD name]_[namespace]_[container-name-container-UID].log %>
      <%# kube-dns-788979dc8f-q7zzr_kube-system_prometheus-to-sd-3ff752152adaa93096aaf558cdc78c270dd0e47daebae928ee5a94628ff82a63.log %>
      <%# rsyslog-daemonset-bsnxr_sam-system_config-gen-container-050479f11abc5957e7b46cc6e28c5843ffa400703d9a9f0897325ad4965ccd1f.log %>
      set $!kubernetes_container_data!pod = field($.file_name, 95, 1);
      set $!kubernetes_container_data!namespace = field($.file_name, 95, 2);

      <%# [container-name-container-UID].log %>
      <%# prometheus-to-sd-3ff752152adaa93096aaf558cdc78c270dd0e47daebae928ee5a94628ff82a63.log %>
      set $.container_info = field(field($.file_name, 95, 3), 46, 1);
      set $!kubernetes_container_data!container_name = re_extract($.container_info, "([a-z0-9][-a-z0-9]*?)-[a-z0-9]*", 0, 1, $.container_info);
      set $!kubernetes_container_data!cluster = "<%=config.cluster%>";


      <%# forces the annotation to be indexed in splunk %>
      set $!kubernetes_container_data!index = "true";

      <%# ------------ end of parsing kubernetes container annotations ----------------%>


      <%# container logs event %>
      set $!event = exec_template("kubernetes_event");

      <%# kubernetes app log annotation array %>
      set $!datacenter = "<%=config.include?(:kingdom) ? config.kingdom : 'mvp'%>";
      set $!substrate = "<%=config.include?(:substrate) ? config.substrate : 'gcp' %>";
      set $!account = "<%=config.account_name %>";
      set $!region = "<%=config.region%>";
      set $!zone = "<%=config.zone%>";

      set $!annotations = "[" & exec_template("kubernetes_annotation_kubernetes_container") & ", " & exec_template("kubernetes_annotation_rsyslog_base") & "]";

      <%# increase event count %>
      set $.inc = dyn_inc("container_events_total", $!kubernetes_container_data!pod & "_" & $!kubernetes_container_data!namespace & "_" & $!kubernetes_container_data!container_name);

      <%# action(
        name="syslog_file_action"
        type="omfile"
        file="/var/log/kubernetes_dockercontainers_ruleset.log"
        template="tpl_containers_log"
      ) %>

      <%# Output action %>
      action(
        type="omkafka"
        name="kafka_kubernetes_kafka_action"
        broker="<%= config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL').nil? ? config.broker_vip : config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL')%>"
        template="tpl_containers_log"
        topic= "<%= config.kafka_topic %>"
        keepFailedMessages="on"
        partitions.auto="on"
        resubmitOnFailure="off"
        reopenonhup="on"
        action.resumeRetryCount="-1"
        confParam=[
          "batch.num.messages=10000",
          "client.id=collections.rsyslog.syslog",
          "compression.codec=gzip",
          "max.in.flight.requests.per.connection=2",
          "message.max.bytes=1000000",
          "queue.buffering.max.ms=5000",
          "retries=2",
          "retry.backoff.ms=100",
          "socket.keepalive.enable=true",
          "security.protocol=ssl",
          "ssl.ca.location=/cert1/ca/cacerts.pem",
          "ssl.certificate.location=/cert1/client/certificates/client.pem",
          "ssl.key.location=/cert1/client/keys/client-key.pem"
        ]
        topicConfParam=[
          "acks=-1"
        ]
      ) & stop

    }
    <%# ---- / End of definition for docker containers tenant ---- %>
  core.conf.erb: "<%# INPUT DEFINITIONS %>\ninput(\n  type=\"imfile\"\n  File=\"<%=config.file_path%>\"\n
    \ PersistStateInterval=\"50000\"\n  startmsg.regex=\"^([[:alnum:]]{1,})`[[:digit:]]{14}.[[:digit:]]{3}`\"\n
    \ readTimeout = \"5\"\n  Tag=\"core\"\n  ruleset=\"ruleset_core\"\n  addmetadata=\"on\"\n
    \ escapelf=\"off\"\n  discardTruncatedMsg=\"on\"\n)\n\n<%# Output Template%>\ntemplate(name
    = \"tpl_core\" type=\"list\") {\n  constant(value=\"{\\\"@version\\\": \\\"20\\\"\")\n
    \ constant(value=\",\\\"type\\\": \\\"core\\\"\")\n  constant(value=\",\")\n  property(name=\"$!host\"
    outname=\"host\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!pod\"
    outname=\"pod\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!datacenter\"
    outname=\"dc\" format=\"jsonfr\")\n  constant(value=\",\\\"superpod\\\": \\\"NONE\\\"\")\n
    \ constant(value=\",\")\n  property(name=\"msg\" outname=\"message\" format=\"jsonf\")\n
    \ constant(value=\",\")\n  property(name=\"$!metadata!filename\" outname=\"path\"
    format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!ts_generated\"
    outname=\"timestamp_produce\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!ts_raw\"
    outname=\"raw_timestamp\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!log_record_type\"
    outname=\"log_record_type\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!uuid\"
    outname=\"uuid\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!appversion\"
    outname=\"appversion\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!apptype\"
    outname=\"apptype\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!filedate\"
    outname=\"filedate\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!role\"
    outname=\"role\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!substrate\"
    outname=\"substrate\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!account\"
    outname=\"account\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!region\"
    outname=\"region\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"$!zone\"
    outname=\"zone\" format=\"jsonfr\")\n  constant(value=\", \\\"latency\\\": 0}\\n\")\n}\n\n#
    20171103184919.875 --> 2017-11-03T18:49:19.875Z\ntemplate(name=\"tpl_origin_ts\"
    type=\"list\") {\n  property(name=\"$!ts_raw\" position.from=\"1\" position.to=\"4\")\n
    \ constant(value=\"-\")\n  property(name=\"$!ts_raw\" position.from=\"5\" position.to=\"6\")\n
    \ constant(value=\"-\")\n  property(name=\"$!ts_raw\" position.from=\"7\" position.to=\"8\")\n
    \ constant(value=\"T\")\n  property(name=\"$!ts_raw\" position.from=\"9\" position.to=\"10\")\n
    \ constant(value=\":\")\n  property(name=\"$!ts_raw\" position.from=\"11\" position.to=\"12\")\n
    \ constant(value=\":\")\n  property(name=\"$!ts_raw\" position.from=\"13\" position.to=\"18\")\n
    \ constant(value=\"Z\")\n}\n\n# 2017-12-14T08:01:17.267119+00:00 -> 2017-12-14T08:01:17.267Z\ntemplate(name=\"tpl_generated_ts\"
    type=\"list\") {\n  property(name=\"timegenerated\" dateFormat=\"rfc3339\" position.from=\"1\"
    position.to=\"23\")\n  constant(value=\"Z\")\n}\n\n<%# RULESET DEFINITION %>\nruleset(name=\"ruleset_core\")
    {\n\n  <%# Template Spec %>\n  set $!log_record_type = field($msg, 96, 1);\n  set
    $!ts_raw = field($msg, 96, 2);\n  set $!ts = exec_template(\"tpl_origin_ts\");\n
    \ set $!ts_generated = exec_template(\"tpl_generated_ts\");\n  # filename - mist61.sfdc.debug-perf-core-6b86b5c8b7-7r6f7.app.20180907.214.gmt.log\n
    \ set $!filename = field($!metadata!filename, 47, <%=config.file_path.split('/').size%>);\n
    \ set $!datacenter = \"<%=config.include?(:kingdom) ? config.kingdom : 'mvp'%>\";\n
    \ set $!substrate = \"<%=config.include?(:substrate) ? config.substrate : 'gcp'
    %>\";\n  set $!account = \"<%=config.include?(:account_name) ? config.account_name
    : config.project_id %>\";\n  set $!region = \"<%=config.region%>\";\n  set $!zone
    = \"<%=config.zone%>\";\n  set $!host = field($!filename, 46, 3);\n  set $!pod
    = field($!host, 45, 1);\n  set $!apptype = field($!filename, 46, 2);\n  set $!role
    = field($!filename, 46, 4);\n  set $!filedate = field($!filename, 46, 5);\n  set
    $!appversion = field($!filename, 46, 6);\n  set $!uuid = $!ts_raw & field($msg,
    96, 16) & field($!host, 45, 4) & \"-\" & field($!host, 45, 5);\n  \n  <%# Output
    action %>\n  action(\n    type=\"omkafka\"\n    name=\"kafka_core\"\n    broker=\"<%=
    config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL').nil?
    ? config.broker_vip : config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL')%>\"\n
    \   template=\"tpl_core\"\n    topic=\"<%=config.kafka_topic%>\"\n    partitions.auto=\"on\"\n
    \   resubmitOnFailure=\"on\"\n    reopenonhup=\"on\"\n    action.resumeRetryCount=\"-1\"\n
    \   confParam=[\n      \"batch.num.messages=10000\",\n      \"compression.codec=gzip\",\n
    \     \"max.in.flight.requests.per.connection=2\",\n      \"message.max.bytes=1000000\",\n
    \     \"queue.buffering.max.ms=5000\",\n      \"retries=86400\",\n      \"retry.backoff.ms=1000\",\n
    \     \"socket.keepalive.enable=true\",\n      \"security.protocol=ssl\",\n      \"ssl.ca.location=/cert1/ca/cacerts.pem\",\n
    \     \"ssl.certificate.location=/cert1/client/certificates/client.pem\",\n      \"ssl.key.location=/cert1/client/keys/client-key.pem\"\n
    \   ]\n    topicConfParam=[\n      \"acks=-1\"\n    ]\n  )\n}\n\n<%# END OF FILE
    %>"
  general.conf.erb: |-
    input(
      type="imfile"
      File="<%=config.file_path%>"
      PersistStateInterval="50000"
    <%- if config.include? :start_regex -%>
      startmsg.regex="<%=config.start_regex%>"
      readTimeout="5"
    <%- else -%>
      readMode="0"
    <%- end -%>
      Tag="<%=config.log_type%>"
      ruleset="ruleset_<%=config.log_type%>"
      addmetadata="on"
      escapelf="off"
      discardTruncatedMsg="on"
    )

    template(name="tpl_<%=config.log_type%>" type="list") {
      constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"event-flatten:1\",\"data\":{")
      property(name="msg" outname="message" format="jsonf")
      constant(value=",")
      property(name="$!source_type" outname="source_type" format="jsonfr")
      constant(value=",")
      property(name="$!datacenter" outname="dc" format="jsonfr")
      constant(value=",")
      property(name="$!superpod" outname="superpod" format="jsonfr")
      constant(value=",")
      property(name="$!metadata!filename" outname="source" format="jsonfr")
      constant(value=",")
      property(name="$!hostname" format="jsonfr")
      constant(value=",")
      property(name="timegenerated" outname="agent_timestamp" dateFormat="rfc3339" date.inUTC="on" format="jsonfr")
      constant(value=",")
      property(name="$!owner" outname="owner" format="jsonfr")
      constant(value=",")
      property(name="$!substrate" outname="substrate" format="jsonfr")
      constant(value=",")
      property(name="$!account" outname="account" format="jsonfr")
      constant(value=",")
      property(name="$!region" outname="region" format="jsonfr")
      constant(value=",")
      property(name="$!zone" outname="zone" format="jsonfr")
      constant(value="}}\n")
    }

    ruleset(name="ruleset_<%=config.log_type%>") {

      <%# Template Spec %>
      set $!datacenter = "<%=config.include?(:kingdom) ? config.kingdom : 'mvp'%>";
      set $!substrate = "<%=config.include?(:substrate) ? config.substrate : 'gcp' %>";
      set $!account = "<%=config.include?(:account_name) ? config.account_name : config.project_id %>";
      set $!region = "<%=config.region%>";
      set $!zone = "<%=config.zone%>";
      set $!superpod = "NONE";
      set $!owner = "<%= config.owner %>";
      set $!source_type = "<%= [config.owner, config.log_type].join(':') %>";
      <%- if config.hostname_parse == "true" -%>
      set $!filename = field($!metadata!filename, 47, <%=config.file_path.split('/').size%>);
      set $!hostname = field($!filename, 46, 3);
      <%- else -%>
      set $!hostname = "<%=config.node%>";
      <%- end -%>

      <%# Output action %>
      action(
        type="omkafka"
        name="kafka_<%= config.log_type %>"
        broker="<%= config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL').nil? ? config.broker_vip : config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL')%>"
        template="tpl_<%= config.log_type %>"
        topic="<%= config.kafka_topic %>"
        partitions.auto="on"
        resubmitOnFailure="on"
        reopenonhup="on"
        action.resumeRetryCount="-1"
        confParam=[
          "batch.num.messages=10000",
          "compression.codec=gzip",
          "max.in.flight.requests.per.connection=2",
          "message.max.bytes=1000000",
          "queue.buffering.max.ms=5000",
          "retries=3",
          "retry.backoff.ms=1000",
          "socket.keepalive.enable=true",
          "security.protocol=ssl",
          "ssl.ca.location=/cert1/ca/cacerts.pem",
          "ssl.certificate.location=/cert1/client/certificates/client.pem",
          "ssl.key.location=/cert1/client/keys/client-key.pem"
        ]
        topicConfParam=[
          "acks=-1"
        ]
      )
    }

    <%# END OF FILE %>
  hostname_parse: "false"
  journal.conf.erb: "module(load=\"imjournal\" StateFile=\"/var/spool/rsyslog/imjournal.state\")\n\n<%#
    syslog related schema annotations %>\ntemplate(name = \"syslog_annotation\" type=\"list\")
    {\n  constant(value=\"{\\\"schema_type\\\":\\\"json-schema\\\",\\\"schema_id\\\":\\\"syslog-base:1\\\",\\\"data\\\":{\")\n
    \ property(name=\"uuid\" outname=\"uuid\" format=\"jsonfr\")\n  constant(value=\",\\\"environment\\\":
    \\\"TechOps\\\"\")\n  constant(value=\",\")\n  property(name=\"programname\" outname=\"source\"
    format=\"jsonfr\")\n  constant(value=\",\\\"source_type\\\": \\\"syslog\\\"\")\n
    \ constant(value=\",\\\"index\\\": \\\"true\\\"\")\n  constant(value=\",\")\n
    \ property(name=\"$!datacenter\" outname=\"dc\" format=\"jsonfr\")\n  constant(value=\",\")\n
    \ property(name=\"$!substrate\" outname=\"substrate\" format=\"jsonfr\")\n  constant(value=\",\")\n
    \ property(name=\"$!account\" outname=\"account\" format=\"jsonfr\")\n  constant(value=\",\")\n
    \ property(name=\"$!region\" outname=\"region\" format=\"jsonfr\")\n  constant(value=\",\")\n
    \ property(name=\"$!zone\" outname=\"zone\" format=\"jsonfr\")\n  constant(value=\"}}\")\n}\n\n<%#
    Universal schema for stdout and stderr streaming  %>\ntemplate(name=\"tpl_syslog\"
    type=\"list\") {\n  constant(value=\"{\\\"schema_type\\\":\\\"json-schema\\\",\\\"schema_id\\\":\\\"event-envelope:1\\\",\\\"data\\\":{\")\n
    \ constant(value=\"\\\"event\\\":\")\n  property(name=\"$!event\")\n  constant(value=\",\")\n
    \ property(name=\"$!hostname\" format=\"jsonfr\")\n  constant(value=\",\")\n  property(name=\"timegenerated\"
    outname=\"event_timestamp\" dateFormat=\"rfc3339\" date.inUTC=\"on\" format=\"jsonfr\")\n
    \ constant(value=\",\")\n  property(name=\"timegenerated\" outname=\"agent_timestamp\"
    dateFormat=\"rfc3339\" date.inUTC=\"on\" format=\"jsonfr\")\n  constant(value=\",\")\n
    \ property(name=\"$!owner\" outname=\"owner\" format=\"jsonfr\")\n  constant(value=\",\\\"annotations\\\":
    \")\n  property(name=\"$!annotations\")\n  constant(value=\"}}\\n\")\n}\n\n\n<%#
    RULESET DEFINITION %>\nruleset(name=\"ruleset_imjounal_syslog\" queue.type=\"LinkedList\"
    queue.size=\"10000\" queue.discardmark=\"9000\" queue.lightdelaymark=\"10000\"
    queue.fulldelaymark=\"10000\" queue.discardseverity=\"5\") {\n\n  <%# # Template
    Spec %>\n  set $!hostname = \"<%=config.node%>\";\n  set $!event!schema_type =
    \"json-schema\";\n  set $!event!schema_id = \"syslog:1\";\n  set $!event!data!message
    = $msg;\n  set $!owner = \"rsyslog\";\n  set $!event!data!facility = $syslogfacility-text;\n
    \ set $!event!data!severity = $syslogseverity-text;\n  set $!event!data!priority
    = $syslogpriority-text;\n  \n  set $!datacenter = \"<%=config.include?(:kingdom)
    ? config.kingdom : 'mvp'%>\";\n  set $!substrate = \"<%=config.include?(:substrate)
    ? config.substrate : 'gcp' %>\";\n  set $!account = \"<%=config.include?(:account_name)
    ? config.account_name : config.project_id %>\";\n  set $!region = \"<%=config.region%>\";\n
    \ set $!zone = \"<%=config.zone%>\";\n  set $!annotations = \"[\" & exec_template(\"syslog_annotation\")
    & \"]\";\n\n  <%# debugging %>\n  <%# action(name=\"imjournal_syslog\"\n    type=\"omfile\"\n
    \   template=\"tpl_syslog\"\n    File=\"/var/log/imjournal_syslog.log\"\n  ) %>\n\n
    \ <%# # Output action %>\n  action(\n    type=\"omkafka\"\n    name=\"kafka_imjournal_syslog\"\n
    \   broker=\"<%= config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL').nil?
    ? config.broker_vip : config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL')%>\"\n
    \   template=\"tpl_syslog\"\n    topic=\"<%=config.kafka_topic%>\"\n    partitions.auto=\"on\"\n
    \   resubmitOnFailure=\"off\"\n    reopenonhup=\"on\"\n    action.resumeRetryCount=\"0\"\n
    \   confParam=[\n      \"batch.num.messages=10000\",\n      \"client.id=collections.rsyslog.syslog\",\n
    \     \"compression.codec=gzip\",\n      \"max.in.flight.requests.per.connection=2\",\n
    \     \"message.max.bytes=1000000\",\n      \"queue.buffering.max.ms=5000\",\n
    \     \"retries=2\",\n      \"retry.backoff.ms=100\",\n      \"socket.keepalive.enable=true\",\n
    \     \"security.protocol=ssl\",\n      \"ssl.ca.location=/cert1/ca/cacerts.pem\",\n
    \     \"ssl.certificate.location=/cert1/client/certificates/client.pem\",\n      \"ssl.key.location=/cert1/client/keys/client-key.pem\"\n
    \   ]\n    topicConfParam=[\n      \"acks=-1\"\n    ]\n  )\n}\n\n<%# process imjournal
    logs %>\nif $inputname == 'imjournal' then {\n    call ruleset_imjounal_syslog\n}\n\n"
  manifests.yaml: |-
    templates:
      - input: base.conf.erb
        output: /etc/rsyslog.d/00-base.conf
      - input: container.conf.erb
        output: /etc/rsyslog.d/40-container.conf
      - input: journal.conf.erb
        output: /etc/rsyslog.d/30-journal.conf
  rsyslog.conf: |-
    global (
      workdirectory = "/var/spool/rsyslog"
      maxMessageSize = "900k"
    )

    $IncludeConfig /etc/rsyslog.d/*.conf
kind: ConfigMap
metadata:
  creationTimestamp: null
  labels:
    pcn: deploy
  name: rsyslog-configmap
  namespace: sam-system
