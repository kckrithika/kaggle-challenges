input(
    type="imudp"
    port="<%= config.listen_port %>"
    ruleset="rs_omhttp_funnel"
)

template(name="tpl_echo" type="string" string="%rawmsg%")

ruleset(name="rs_omhttp_funnel" queue.type="LinkedList" queue.size="5000" queue.lightdelaymark="3000" queue.fulldelaymark="4000") {

    action(
        name="action_funnel_forward"
        type="omhttp"
        template="tpl_echo"

        server="<%= config.funnel_vip %>"
        serverport="<%= config.funnel_port %>"
        restpath="funnel/v1/publishBatch?avroSchemaFingerprint=AVG7NnlcHNdk4t_zn2JBnQ"
        usehttps="<%= config.funnel_https %>"

        batch="on"
        batch.maxsize="300"
        batch.maxbytes="1000000" # ~1Mb
        batch.format="jsonarray"

        compress="on"
        retry="on"
        retry.ruleset="rs_omhttp_funnel_retry" # Retry once
    )
}

ruleset(name="rs_omhttp_funnel_retry" queue.type="LinkedList" queue.size="5000" queue.lightdelaymark="3000" queue.fulldelaymark="4000") {
    action(
        name="action_funnel_forward_retry"
        type="omhttp"
        template="tpl_echo"

        server="<%= config.funnel_vip %>"
        serverport="<%= config.funnel_port %>"
        restpath="funnel/v1/publishBatch?avroSchemaFingerprint=AVG7NnlcHNdk4t_zn2JBnQ"
        usehttps="<%= config.funnel_https %>"

        batch="on"
        batch.maxsize="300"
        batch.maxbytes="1000000" # ~1Mb
        batch.format="jsonarray"

        compress="on"
        retry="off"
    )
}
