<%# INPUT DEFINITIONS %>
input(
  type="imfile"
  File="/home/sfdc/logs/solr/solr/*.gmt.log"
  PersistStateInterval="50000"
  Tag="solr"
  ruleset="ruleset_solr"
  startmsg.regex="^([[:alnum:]]{1,})`[[:digit:]]{14}.[[:digit:]]{3}`"
  readTimeout = "5"
  addmetadata="on"
  escapelf="off"
  discardTruncatedMsg="on"
)

<%# Output Template%>
template(name="tpl_solr" type="list") {
  constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"event-flatten:1\",\"data\":{")
  property(name="msg" outname="message" format="jsonf")
  constant(value=",")
  property(name="$!source_type" outname="source_type" format="jsonfr")
  constant(value=",")
  property(name="$!datacenter" outname="dc" format="jsonfr")
  constant(value=",")
  property(name="$!superpod" outname="superpod" format="jsonfr")
  constant(value=",")
  property(name="$!pod" outname="pod" format="jsonfr")
  constant(value=",")
  property(name="$!metadata!filename" outname="source" format="jsonfr")
  constant(value=",")
  property(name="$!hostname" format="jsonfr")
  constant(value=",")
  property(name="$!node" format="jsonfr")  
  constant(value=",")
  property(name="timegenerated" outname="agent_timestamp" dateFormat="rfc3339" date.inUTC="on" format="jsonfr")
  constant(value=",")
  property(name="$!owner" outname="owner" format="jsonfr")
  constant(value="}}\n")
}

<%# RULESET DEFINITION %>
ruleset(name="ruleset_solr" queue.type="LinkedList" queue.size="5000" queue.lightdelaymark="3000" queue.fulldelaymark="4000") {

  <%# Template Spec %>
  set $!datacenter = "<%= config.cluster %>";
  set $!superpod = "NONE";
  set $!pod = "<%= config.node %>";
  set $!owner = "Search";
  set $!source_type = "solr6";

  <%# Output action %>
  action(
    type="omkafka"
    name="kafka_solr"
    broker= "<%= config.broker_vip %>"
    template="tpl_solr"
    topic= "<%= config.kafka_topic %>"
    partitions.auto="on"
    resubmitOnFailure="off"
    reopenonhup="on"
    action.resumeRetryCount="-1"
    confParam=[
      "batch.num.messages=10000",
      "client.id=collections.rsyslog.test",
      "compression.codec=gzip",
      "max.in.flight.requests.per.connection=2",
      "message.max.bytes=1000000",
      "queue.buffering.max.ms=5000",
      "retries=86400",
      "retry.backoff.ms=1000",
      "socket.keepalive.enable=true",
      "security.protocol=ssl",
      "ssl.ca.location=/etc/pki_service/ca/cacerts.pem",
      "ssl.certificate.location=/etc/pki_service/root/rsyslog_agent/certificates/rsyslog_agent.pem",
      "ssl.key.location=/etc/pki_service/root/rsyslog_agent/keys/rsyslog_agent-key.pem"
    ]
    topicConfParam=[
      "acks=-1"
    ]
  )
}
