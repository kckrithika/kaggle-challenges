<%# INPUT DEFINITIONS %>
input(
  type="imfile"
  File="/home/sfdc/logs/jvm/*.jvmgc.log_*"
  PersistStateInterval="50000"
  Tag="casam_jvmgc"
  ruleset="ruleset_casam_jvmgc"
  startmsg.regex="^([[:digit:]]{4}-(0[1-9]|1[0-2])-(0?[1-9]|[12][[:digit:]]|3[01]))([[:space:]]|T)(([01][[:digit:]]|2[0-3]):[0-5][[:digit:]]:([0-5][[:digit:]]|6[01]))[,|\\.][[:digit:]]{3}"
  readTimeout = "5"  
  addmetadata="on"
  escapelf="off"
  discardTruncatedMsg="on"
)

<%# Output Template%>
template(name="tpl_casam_jvmgc" type="list") {
  constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"event-flatten:1\",\"data\":{")
  property(name="msg" outname="message" format="jsonf")
  constant(value=",")
  property(name="$!source_type" outname="source_type" format="jsonfr")
  constant(value=",")
  property(name="$!datacenter" outname="dc" format="jsonfr")
  constant(value=",")
  property(name="$!superpod" outname="superpod" format="jsonfr")
  constant(value=",")
  property(name="$!pod" outname="pod" format="jsonfr")
  constant(value=",")
  property(name="$!metadata!filename" outname="source" format="jsonfr")
  constant(value=",")
  property(name="$!hostname" format="jsonfr")
  constant(value=",")
  property(name="$!node" format="jsonfr")  
  constant(value=",")
  property(name="timegenerated" outname="agent_timestamp" dateFormat="rfc3339" date.inUTC="on" format="jsonfr")
  constant(value=",")
  property(name="$!owner" outname="owner" format="jsonfr")
  constant(value="}}\n")
}

<%# RULESET DEFINITION %>
ruleset(name="ruleset_casam_jvmgc") {

  <%# Template Spec %>
  set $!datacenter = "<%= config.cluster%>";
  set $!superpod = "NONE";
  set $!pod = "<%= config.node %>";
  set $!owner = "CASAM";
  set $!source_type = "casam_jvmgclog";

  <%# omfile for debugging %>
  <%# action(name="file_casam_jvmgc"
    type="omfile"
    template="tpl_casam_jvmgc"
    File="/var/log/rsyslog/casam_jvmgc.log"
  ) %>

  <%# Output action %>
  action(
    type="omkafka"
    name="kafka_casam_jvmgc"
    broker="<%= config.broker_vip %>"
    template="tpl_casam_jvmgc"
    topic="<%= config.kafka_topic %>"
    partitions.auto="on"
    resubmitOnFailure="off"
    reopenonhup="on"
    action.resumeRetryCount="-1"
    confParam=[
      "batch.num.messages=10000",
      "compression.codec=gzip",
      "max.in.flight.requests.per.connection=2",
      "message.max.bytes=1000000",
      "queue.buffering.max.ms=5000",
      "retries=86400",
      "retry.backoff.ms=1000",
      "socket.keepalive.enable=true",
      "security.protocol=ssl",
      "ssl.ca.location=/cert1/ca/cacerts.pem",
      "ssl.certificate.location=/cert1/client/certificates/client.pem",
      "ssl.key.location=/cert1/client/keys/client-key.pem"
    ]
    topicConfParam=[
      "acks=-1"
    ]
  )
}

<%# END OF FILE %>