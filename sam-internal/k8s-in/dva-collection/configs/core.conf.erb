<%# INPUT DEFINITIONS %>
input(
  type="imfile"
  File="/home/sfdc/logs/sfdc/*.gmt.log"
  PersistStateInterval="50000"
  startmsg.regex="^([[:alnum:]]{1,})`[[:digit:]]{14}.[[:digit:]]{3}`"
  readTimeout = "5"
  Tag="core"
  ruleset="ruleset_core"
  addmetadata="on"
  escapelf="off"
  discardTruncatedMsg="on"
)

<%# Output Template%>
template(name = "tpl_core" type="list") {
  constant(value="{\"@version\": \"20\"")
  constant(value=",\"type\": \"core\"")
  constant(value=",")
  property(name="$!host" outname="host" format="jsonfr")
  constant(value=",")
  property(name="$!pod" outname="pod" format="jsonfr")
  constant(value=",")
  property(name="$!datacenter" outname="dc" format="jsonfr")
  constant(value=",\"superpod\": \"NONE\"")
  constant(value=",")
  property(name="msg" outname="message" format="jsonf")
  constant(value=",")
  property(name="$!metadata!filename" outname="path" format="jsonfr")
  constant(value=",")
  property(name="$!ts_generated" outname="timestamp_produce" format="jsonfr")
  constant(value=",")
  property(name="$!ts_raw" outname="raw_timestamp" format="jsonfr")
  constant(value=",")
  property(name="$!log_record_type" outname="log_record_type" format="jsonfr")
  constant(value=",")
  property(name="$!uuid" outname="uuid" format="jsonfr")
  constant(value=",")
  property(name="$!appversion" outname="appversion" format="jsonfr")
  constant(value=",")
  property(name="$!apptype" outname="apptype" format="jsonfr")
  constant(value=",")
  property(name="$!filedate" outname="filedate" format="jsonfr")
  constant(value=",")
  property(name="$!role" outname="role" format="jsonfr")
  constant(value=",")
  property(name="$!substrate" outname="dc" format="jsonfr")
  constant(value=",")
  property(name="$!account" outname="dc" format="jsonfr")
  constant(value=",\"region\": \"<%=config.region%>\"")
  constant(value=",\"zone\": \"<%=config.zone%>\"")
  constant(value=", \"latency\": 0}\n")
}

# 20171103184919.875 --> 2017-11-03T18:49:19.875Z
template(name="tpl_origin_ts" type="list") {
  property(name="$!ts_raw" position.from="1" position.to="4")
  constant(value="-")
  property(name="$!ts_raw" position.from="5" position.to="6")
  constant(value="-")
  property(name="$!ts_raw" position.from="7" position.to="8")
  constant(value="T")
  property(name="$!ts_raw" position.from="9" position.to="10")
  constant(value=":")
  property(name="$!ts_raw" position.from="11" position.to="12")
  constant(value=":")
  property(name="$!ts_raw" position.from="13" position.to="18")
  constant(value="Z")
}

# 2017-12-14T08:01:17.267119+00:00 -> 2017-12-14T08:01:17.267Z
template(name="tpl_generated_ts" type="list") {
  property(name="timegenerated" dateFormat="rfc3339" position.from="1" position.to="23")
  constant(value="Z")
}

<%# RULESET DEFINITION %>
ruleset(name="ruleset_core") {

  <%# Template Spec %>
  set $!log_record_type = field($msg, 96, 1);
  set $!ts_raw = field($msg, 96, 2);
  set $!ts = exec_template("tpl_origin_ts");
  set $!ts_generated = exec_template("tpl_generated_ts");
  # filename - mist61.sfdc.debug-perf-core-6b86b5c8b7-7r6f7.app.20180907.214.gmt.log
  set $!filename = field($!metadata!filename, 47, 5);
  set $!datacenter = "<%=config.include?(:kingdom) ? config.kingdom : 'mvp'%>";
  set $!substrate = "<%=config.include?(:substrate) ? config.substrate : 'gcp' %>";
  set $!account = "<%=config.include?(:account_name) ? config.account_name : config.project_id %>";
  set $!host = field($!filename, 46, 3);
  set $!pod = field($!host, 45, 1);
  set $!apptype = field($!filename, 46, 2);
  set $!role = field($!filename, 46, 4);
  set $!filedate = field($!filename, 46, 5);
  set $!appversion = field($!filename, 46, 6);
  set $!uuid = $!ts_raw & field($msg, 96, 16) & field($!host, 45, 4) & "-" & field($!host, 45, 5);
  
  <%# Output action %>
  action(
    type="omkafka"
    name="kafka_core"
    broker="<%=config.broker_vip%>"
    template="tpl_core"
    topic="<%=config.kafka_topic%>"
    partitions.auto="on"
    resubmitOnFailure="on"
    reopenonhup="on"
    action.resumeRetryCount="-1"
    confParam=[
      "batch.num.messages=10000",
      "compression.codec=gzip",
      "max.in.flight.requests.per.connection=2",
      "message.max.bytes=1000000",
      "queue.buffering.max.ms=5000",
      "retries=86400",
      "retry.backoff.ms=1000",
      "socket.keepalive.enable=true",
      "security.protocol=ssl",
      "ssl.ca.location=/cert1/ca/cacerts.pem",
      "ssl.certificate.location=/cert1/client/certificates/client.pem",
      "ssl.key.location=/cert1/client/keys/client-key.pem"
    ]
    topicConfParam=[
      "acks=-1"
    ]
  )
}

<%# END OF FILE %>