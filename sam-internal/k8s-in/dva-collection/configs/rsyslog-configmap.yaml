apiVersion: v1
data:
  casam-config: |-
    $DirCreateMode 0755
    $Umask 0022
    $DebugLevel 0


    # Use default timestamp format
    $ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

    global (
      workdirectory = "/usr/shared/data/rsyslog"
      preserveFQDN = "on"
    )

    #### module loads all happen here ####
    module(load = "imfile")
    module(load = "omkafka")
    module(load = "builtin:omfile")


    # INPUT DEFINITIONS
    input(
      type="imfile"
      File="/usr/shared/data/*.app.*.gmt.log"
      PersistStateInterval="50000"
      startmsg.regex="^([[:alnum:]]{1,})`[[:digit:]]{14}.[[:digit:]]{3}`"
      readTimeout = "5"
      Tag="core"
      ruleset="ruleset_core"
      addmetadata="on"
      escapelf="off"
      discardTruncatedMsg="on"
    )

    template(name = "tpl_casam" type="list") {
      constant(value="{\"@version\": \"1\"")
      constant(value=",\"type\": \"core\"")
      constant(value=",")
      property(name="hostname" outname="host" format="jsonfr")
      constant(value=",")
      property(name="$!pod" outname="pod" format="jsonfr")
      constant(value=",")
      property(name="$!datacenter" outname="dc" format="jsonfr")
      constant(value=",")
      property(name="$!superpod" outname="sp" format="jsonfr")
      constant(value=",")
      property(name="msg" outname="message" format="jsonfr")
      constant(value=",")
      property(name="$!file_path" outname="path" format="jsonfr")
      constant(value=",")
      property(name="$!ts_generated" outname="timestamp_produce" format="jsonfr")
      constant(value=",")
      property(name="$!ts" outname="raw_timestamp" format="jsonfr")
      constant(value=",")
      property(name="$!env" outname="env" format="jsonfr")
      constant(value=",")
      property(name="$!appversion" outname="appverion" format="jsonfr")
      constant(value=",")
      property(name="$!role" outname="role" format="jsonfr")
      constant(value=",")
      property(name="$!log_record_type" outname="log_record_type" format="jsonfr")
      constant(value=",")
      property(name="$!uuid" outname="uuid" format="jsonfr")
      constant(value=", \"latency\": 0}\n")
    }

    # 20171103184919.875 --> 2017-11-03T18:49:19.875Z
    template(name="tpl_origin_ts" type="list") {
      property(name="$!ts_raw" position.from="1" position.to="4")
      constant(value="-")
      property(name="$!ts_raw" position.from="5" position.to="6")
      constant(value="-")
      property(name="$!ts_raw" position.from="7" position.to="8")
      constant(value="T")
      property(name="$!ts_raw" position.from="9" position.to="10")
      constant(value=":")
      property(name="$!ts_raw" position.from="11" position.to="12")
      constant(value=":")
      property(name="$!ts_raw" position.from="13" position.to="18")
      constant(value="Z")
    }

    # 2017-12-14T08:01:17.267119+00:00 -> 2017-12-14T08:01:17.267Z
    template(name="tpl_generated_ts" type="list") {
      property(name="timegenerated" dateFormat="rfc3339" position.from="1" position.to="23")
      constant(value="Z")
    }

    ruleset(name="ruleset_core") {

      # Template Spec
      set $!log_record_type = field($msg, 96, 1);

      # timestamp related
      set $!ts_raw = field($msg, 96, 2);
      set $!ts = exec_template("tpl_origin_ts");
      set $!ts_generated = exec_template("tpl_generated_ts");

      set $!file_name = field($!metadata!filename, 47, 5);
      set $!file_path = "/home/sfdc/logs/sfdc/" & $!file_name;

      set $!host = "gke-gao-collection-poc-larger-pool-7372f548-x4mk";
      set $!pod = "casam";
      set $!datacenter = "gke";
      set $!superpod = "NONE";
      set $!uuid = $!ts_raw & field($msg, 96, 16) & $!host;

      # new fields
      set $!env = "gke";
      set $!appversion = "220";
      set $!role = "app";

      # omfile for debugging
      action(name="file_casam"
             type="omfile"
             template="tpl_casam"
             File="/usr/data/shared/rsyslog/output.log"
            )

      # Output action
      action(
        type="omkafka"
        name="kafka_casam"
        broker=[""]
        template="tpl_casam"
        topic="gke_test"
        partitions.auto="on"
        resubmitOnFailure="on"
        reopenonhup="on"
        action.resumeRetryCount="-1"
        errorFile="/var/log/rsyslog/kafka_error_casam.log"
        confParam=[
          "batch.num.messages=10000",
          "compression.codec=gzip",
          "max.in.flight.requests.per.connection=2",
          "message.max.bytes=1000000",
          "queue.buffering.max.ms=5000",
          "retries=86400",
          "retry.backoff.ms=1000",
          "socket.keepalive.enable=true"
        ]
        topicConfParam=[
          "acks=-1"
        ]
      )
    }
kind: ConfigMap
metadata:
  creationTimestamp: 2019-01-23T00:33:42Z
  name: rsyslog-configmap
  namespace: default
  resourceVersion: "3054683"
  selfLink: /api/v1/namespaces/default/configmaps/rsyslog-configmap
  uid: 88ff9145-1ea6-11e9-baf7-42010a8a0003
