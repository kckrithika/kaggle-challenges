<%# INPUT DEFINITIONS %>
<%# Collect log files in /var/log/container %>
input(
  type="imfile"
  File="/var/log/containers/*.log"
  PersistStateInterval="500"
  Tag="kubernetes"
  ruleset="kubernetes_dockercontainers_ruleset"
  addmetadata="on"
  escapelf="off"
  discardTruncatedMsg="on"
)

dyn_stats(name="container_events_total" resettable="off")

<%# ------- Start of definition of schema templates ------- %>

<%# Align universal schema envelope %>
template(name="tpl_containers_log" type="list") {
  constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"event-envelope:1\",\"data\":{")
  constant(value="\"event\":")
  property(name="$!event")
  constant(value=",")
  property(name="$!hostname" format="jsonfr")
  constant(value=",")
  property(name="$!logdata!time" outname="event_timestamp" format="jsonfr")
  constant(value=",")
  property(name="timegenerated" outname="agent_timestamp" dateFormat="rfc3339" date.inUTC="on" format="jsonfr")
  constant(value=",")
  property(name="$!owner" outname="owner" format="jsonfr")
  constant(value=",\"annotations\": ")
  property(name="$!annotations")
  constant(value="}}\n")
}

<%# kubernetes container logs event %>
template(name="kubernetes_event" type="list") {
  constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"kubernetes:1\",\"data\":{")
  property(name="$!logdata!log" outname="message" format="jsonf")
  constant(value=",")
  property(name="$!severity" outname="severity" format="jsonfr")
  constant(value="}}")
}

<%# rsyslog base annotations %>
template(name = "kubernetes_annotation_rsyslog_base" type="list") {
  constant(value="{\"schema_type\":\"json-schema\",\"schema_id\":\"rsyslog-base:1\",\"data\":{")
  constant(value="\"source\": \"<%=config.account_name %>\"")
  constant(value=",\"source_type\": \"container\"")
  constant(value=",")
  property(name="$!datacenter" outname="dc" format="jsonfr")
  constant(value=",")
  property(name="$!substrate" outname="substrate" format="jsonfr")
  constant(value=",")
  property(name="$!account" outname="account" format="jsonfr")
  constant(value=",")
  property(name="$!region" outname="region" format="jsonfr")
  constant(value=",")
  property(name="$!zone" outname="zone" format="jsonfr")
  constant(value=",")
  constant(value="\"index\": \"true\"")
  constant(value="}}")
}

<%# container logs anotations %>
template(name = "kubernetes_annotation_kubernetes_container" type="list") {
  constant(value = "{\"schema_type\":\"json-schema\",\"schema_id\":\"kubernetes-container:1\",\"data\":")
  property(name = "$!kubernetes_container_data")
  constant(value = "}")
}

ruleset(name = "kubernetes_dockercontainers_ruleset") {
  <%# mmjsonparse to parse log message %>
  action(type="mmjsonparse" cookie="" container="$!logdata")

  set $!hostname = "<%=config.node%>";
  set $!owner = "none";

  if $!logdata!stream == 'stderr' then {
    set $!severity = "error";
  } else {
    set $!severity = "info";
  }

  <%# ------------ parsing kubernetes container annotation information -------------%>
  <%# retrieve file name from /var/log/containers/kube-proxy-gke-gao-collection-poc-larger-pool-7372f548-5v3r_kube-system_kube-proxy-7a7cad04f5245c7d12f05e380b9f3a77098d01ff36184529c245e57463c3686a.log %>
  set $.file_name = field($!metadata!filename, 47, 5);

  <%# [POD name]_[namespace]_[container-name-container-UID].log %>
  <%# kube-dns-788979dc8f-q7zzr_kube-system_prometheus-to-sd-3ff752152adaa93096aaf558cdc78c270dd0e47daebae928ee5a94628ff82a63.log %>
  <%# rsyslog-daemonset-bsnxr_sam-system_config-gen-container-050479f11abc5957e7b46cc6e28c5843ffa400703d9a9f0897325ad4965ccd1f.log %>
  set $!kubernetes_container_data!pod = field($.file_name, 95, 1);
  set $!kubernetes_container_data!namespace = field($.file_name, 95, 2);

  <%# [container-name-container-UID].log %>
  <%# prometheus-to-sd-3ff752152adaa93096aaf558cdc78c270dd0e47daebae928ee5a94628ff82a63.log %>
  set $.container_info = field(field($.file_name, 95, 3), 46, 1);
  set $!kubernetes_container_data!container_name = re_extract($.container_info, "([a-z0-9][-a-z0-9]*?)-[a-z0-9]*", 0, 1, $.container_info);
  set $!kubernetes_container_data!cluster = "<%=config.cluster%>";


  <%# forces the annotation to be indexed in splunk %>
  set $!kubernetes_container_data!index = "true";

  <%# ------------ end of parsing kubernetes container annotations ----------------%>


  <%# container logs event %>
  set $!event = exec_template("kubernetes_event");

  <%# kubernetes app log annotation array %>
  set $!datacenter = "<%=config.include?(:kingdom) ? config.kingdom : 'mvp'%>";
  set $!substrate = "<%=config.include?(:substrate) ? config.substrate : 'gcp' %>";
  set $!account = "<%=config.account_name %>";
  set $!region = "<%=config.region%>";
  set $!zone = "<%=config.zone%>";

  set $!annotations = "[" & exec_template("kubernetes_annotation_kubernetes_container") & ", " & exec_template("kubernetes_annotation_rsyslog_base") & "]";

  <%# increase event count %>
  set $.inc = dyn_inc("container_events_total", $!kubernetes_container_data!pod & "_" & $!kubernetes_container_data!namespace & "_" & $!kubernetes_container_data!container_name);

  <%# action(
    name="syslog_file_action"
    type="omfile"
    file="/var/log/kubernetes_dockercontainers_ruleset.log"
    template="tpl_containers_log"
  ) %>

  <%# Output action %>
  action(
    type="omkafka"
    name="kafka_kubernetes_kafka_action"
    broker="<%= config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL').nil? ? config.broker_vip : config.topology_lookup('ajnalocal1', 'ajna-kafka', 'BROKER_ENDPOINT_SSL')%>"
    template="tpl_containers_log"
    topic= "<%= config.kafka_topic %>"
    keepFailedMessages="on"
    partitions.auto="on"
    resubmitOnFailure="off"
    reopenonhup="on"
    action.resumeRetryCount="-1"
    confParam=[
      "batch.num.messages=10000",
      "client.id=collections.rsyslog.syslog",
      "compression.codec=gzip",
      "max.in.flight.requests.per.connection=2",
      "message.max.bytes=1000000",
      "queue.buffering.max.ms=5000",
      "retries=2",
      "retry.backoff.ms=100",
      "socket.keepalive.enable=true",
      "security.protocol=ssl",
      "ssl.ca.location=/cert1/ca/cacerts.pem",
      "ssl.certificate.location=/cert1/client/certificates/client.pem",
      "ssl.key.location=/cert1/client/keys/client-key.pem"
    ]
    topicConfParam=[
      "acks=-1"
    ]
  ) & stop

}
<%# ---- / End of definition for docker containers tenant ---- %>
