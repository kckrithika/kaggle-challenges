global
    maxconn 1024
    # TODO: where should logs go? Local syslog for now.
    # http://cbonte.github.io/haproxy-dconv/1.6/configuration.html#3.1-log
    log 127.0.0.1 syslog

defaults
    option tcplog
    option dontlognull
    option tcpka

frontend localhost
    bind *:5000
    mode http

    # Block secret access
    acl secrets url_reg /api/v1/secrets
    acl secrets_namespace url_reg /api/v1/namespaces/.*/secrets
    # The E2E test downloads this secret from sam-system namespace and uploads to the new
    # e2e namespce.  For now just allow this one secret through.
    # TODO: Remove this if we remove statufl ceph from E2E
    acl e2e_secret url_reg /api/v1/namespaces/.*/secrets/ceph-sec-user-rdi
    http-request deny if secrets or secrets_namespace !e2e_secret

    # Redirect API access to CI CRD so traffic goes through the validating proxy
    acl sam_api url_reg /apis/samcrd.salesforce.com/v1/namespaces/.*/samapps.*
    use_backend sam_api_proxy_server if sam_api

    timeout client 50s
    timeout client-fin 30s
    log global
    default_backend kubernetes-apiserver
    # Enable the sending of TCP keepalive packets on the client side
    option clitcpka

backend sam_api_proxy_server
    mode http
    timeout server 50s
    timeout connect 5s
    timeout tunnel  50s
    option httpchk HEAD /healthz HTTP/1.1\r\nHost:\ localhost
    default-server inter 5s fall 3 rise 2
    option srvtcpka
    # Nodeport for sam api proxy
    server proxy localhost:39872

backend kubernetes-apiserver
    mode http
    timeout server 50s
    timeout connect 5s
    timeout tunnel  50s
    option httpchk HEAD /healthz HTTP/1.1\r\nHost:\ localhost
    default-server inter 5s fall 3 rise 2
    option srvtcpka

    # Connect to local HAProxy, preferring the one on this host
    # TODO: The below host specific cert will be called hostcert-chain.pem and will work on any host
    # Change this after the filename is available through puppet.
    server proxy localhost:8000 ssl ca-file /etc/pki_service/ca/cabundle.pem crt %s
