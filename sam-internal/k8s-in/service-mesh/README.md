# Mesh Control Plane
## System requirements
Helm Version: 3.0.0 or higher
Kustomize Version: 3.2.1 or higher

## Istio Pilot Update, Upgrade & Deployment 
The [templates](./templates) directory contains Istio's k8s resources auto-generated from the [Istio helm charts](https://git.soma.salesforce.com/servicemesh/istio-helm-charts) using [Kustomize](https://github.com/kubernetes-sigs/kustomize/blob/master/README.md) and [Internal Istio Upgrade Tool](https://git.soma.salesforce.com/servicemesh/istio-upgrade). 

The [`kustomize`](./kustomize) directory contains Istio's kustomize base and overlays. The overlays contain embedded jsonnet variables that are later injected by SAM internal pipeline for each kingdom/estate.

The [`./upgrade.sh`](./upgrade.sh) script pulls Istio's helm charts from istio-helm-charts repo and runs [kustomize script](./kustomize/kustomize.sh). 

The kustomize script create the final [istio-init.yaml with embedded jsonnet variables](./kustomize/istio-init.yaml) & [istio.yaml with embedded jsonnet variables](./kustomize/istio.yaml).

The [`generate-istio-templates.sh`](./generate-istio-templates.sh) converts this single yaml which contains multiple Istio resources to separate jsonnet templates and populates them in [`templates/phase1/istio-init-autogenerated`](./templates/phase1/istio-init-autogenerated) directory.
 
k8s-in [`./build.sh`](../build.sh) converts the auto-generated jsonnet templates to yaml with SAM config values populated in place of the jsonnet variables.

**Notes:**
1. Files that end with **.TEMPLATE** suffix are not processed by the build script.

### Update/Upgrade and Deployment Steps (Skip steps as required based on the action)
All updates/upgrades should first be done in the [isito-helm-charts repo](https://git.soma.salesforce.com/servicemesh/istio-helm-charts).
Try optimizing use of helm value rather than creating an overlay.

1. If updating images, update in [istio-releases.json](./istio-releases.json).
1. If updating templates or configuration, update in istio-helm-charts repo first.
1. Any helm value that has a different value in 1P than from Falcon could be added as an helm value override in [upgrade script](./upgrade.sh).
1. If a config is not achievable by helm values, then it can be added to the [overlays](./kustomize/overlays).
1. Values that change per kingdom/estate are defined in [`istio-config.jsonnet`](./istio-config.jsonnet). These are used in overlays as `mcpIstioConfig.<name>` or `%(<name>)s`, where, `<name>` is the variable name.
1. Run [`./upgrade.sh`](./upgrade.sh) script to get the new templates from git and apply overlays to generated the final manifest file. If you need to run only the kustomize phase, then run [kustomize script](./kustomize/kustomize.sh).
1. Run [`./generate-istio-templates.sh`](./generate-istio-templates.sh) script. This will auto-generate jsonnet templates in [templates](./templates) directory.
1. Run [`./build.sh`](../build.sh) script in [`k8s-in` directory](../). This will generate the k8s yamls in [`k8s-out` directory](../../k8s-out) as per the estates.
1. If you would like to verify the generated k8s resource files, apply them directly to your local k8s cluster or to prd-samtest only. Ensure you are in the intended kubectl context.
1. Create PR for review.
1. Once the PR is authorized, the SAM TNRP pipeline should take care of the deployment. Use the links mentioned in [SAM Auto Deployer](https://git.soma.salesforce.com/sam/sam/wiki/Debugging-SAM-Auto-Deployer) to check the deployment progress and errors.
1. Verify Istio deployments and Istio test apps are running fine based on the steps mentioned below.

### Verification
Istio test apps are deployed in `prd-sam` in `service-mesh` namespace. Please ensure the apps are running as expected after any modifications. Once metrics support is added, we will add alerts for the same.
```
$ kubectl config use-context prd-sam
Switched to context "prd-sam".

$ kubectl -n mesh-control-plane get pods -o wide
NAME                                     READY     STATUS    RESTARTS   AGE       IP               NODE
istio-ingressgateway-584b455c6b-q27cw    2/2       Running   0          1d        10.251.130.103   shared0-samminiongater1-1-prd.eng.sfdc.net
istio-routing-webhook-58db4957fb-cv8bj   2/2       Running   2          3d        10.251.161.41    shared0-samkubeapi1-1-prd.eng.sfdc.net
istio-pilot-7b6946ff78-6447v             2/2       Running   0          18h       10.251.131.38    shared0-samminiongater2-4-prd.eng.sfdc.net
istio-sidecar-injector-f59875c8c-7kpm6   2/2       Running   0          1h        10.251.161.195   shared0-samkubeapi3-1-prd.eng.sfdc.net

$ kubectl -n service-mesh get pods | grep istio
istio-ordering-54945d5b49-br2p7                         4/4       Running                        0          3d
istio-ordering-mixed-istio-to-sherpa-7d6fd45bbb-d6khw   4/4       Running                        0          4d
istio-ordering-mixed-sherpa-to-istio-67fcb69f57-2g5tg   2/3       Running                        4          4d
istio-shipping-7bd9467875-6n9rz                         4/4       Running                        0          4d
istio-shipping-mixed-istio-to-sherpa-6ddb77b4d9-4jl6k   4/4       Running                        1          4d
istio-shipping-mixed-sherpa-to-istio-64f799c4dd-qt9bl   5/5       Running                        0          4d
```

The app definitions can be found in the [service-mesh team manifests](https://git.soma.salesforce.com/sam/manifests/tree/master/apps/team/service-mesh).

### Phased Deployments
1. All auto-generated and manually created/edited jsonnets should go into a sub-directory in [phase1](./templates/phase1) directory only. 
All subsequent phases are auto-created by the script [promote-istio-templates.sh](./promote-istio-templates.sh). 
This script accepts 'from' phase and 'to' phase as input arguments. 
It can be executed from any directory using relative path. 
Example:
```
# To promote istio templates from phase 1 to 2, run:
./promote-istio-templates.sh 1 2

# To promote istio templates from phase 2 to 3, run:
./promote-istio-templates.sh 2 3

``` 
It generates the phase directory under [templates](./templates) if required and auto-populates the jsonnets with the required phase filter. 

2. The phase filter is defined in [istio-phases.jsonnet](./istio-phases.jsonnet). The corresponding release image tags are defined in [istio-releases.json](./istio-releases.json) 

3. Once the script successfully completes, run [build.sh](../build.sh). 
*Important:* If you do not run `./build.sh` for all estates but for specific estates like `./build.sh prd/prd-samtest,prd/prd-sam,par/par-sam`, 
please ensure that you include all the estates that have jsonnet templates. Without it there is a risk of the jsonnet variables affecting other phase templates inadvertently. 
