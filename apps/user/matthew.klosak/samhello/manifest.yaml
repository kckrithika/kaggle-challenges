apiVersion: v1

system:
  notifications:
    email:
      - matthew.klosak@salesforce.com
  functions:
    - name: default
      count: 1
      annotations:
        "sherpa-injector.service-mesh/inject": "enabled"
      containers:
        #####################################################################################
        # Service Mesh / Envoy / Sherpa
        #####################################################################################
        - name: sherpa-envoy
          image: sfci/servicelibs/sherpa-envoy:1.0.8
          env:
            - name: SFDC_ENVIRONMENT
              value: "sam"
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          volumeMounts:
            - name: tls-client-cert
              mountPath: /client-certs
            - name: tls-server-cert
              mountPath: /server-certs
          ports:
            - containerPort: 7012
              name: http2-in
            - containerPort: 7014
              name: http1-in
            - containerPort: 7443
              name: http2-tls-in
            - containerPort: 7442
              name: http1-tls-in
            - containerPort: 15373
              name: sherpa-adm
          livenessProbe:
            exec:
              command:
                - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
                - "./bin/is-alive"
            initialDelaySeconds: 110
            periodSeconds: 5
        #####################################################################################
        # Service Beacon
        #####################################################################################
        - name: beacon
          image: sfci/servicelibs/beacon:7ad9e771192cd0b3e43393eea2e1e5c1de81dfda
          env:
            - name: SFDC_ENVIRONMENT
              value: "sam"
          volumeMounts:
            - mountPath: /log
              name: logvolbeacon
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          args:
            - -endpoint
            - $(FUNCTION_NAMESPACE)/$(FUNCTION):DATACENTER_ALLENV:7442
          livenessProbe:
            exec:
              command:
                - "/home/scone/is-alive.sh"
            initialDelaySeconds: 5
            periodSeconds: 5
        #####################################################################################
        # SAM Hello
        #####################################################################################
        - name: samhello
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/matthew.klosak/samhello:20190910 # golang app
          ports:
            - containerPort: 9090
          livenessProbe:
            httpGet:
              path: /
              port: 9090
      volumes:
        - name: tls-client-cert
          maddogCert:
            type: client
        - name: tls-server-cert
          maddogCert:
            type: server
  loadbalancers:
    - lbname: samhellolb
      function: default
      slbenabled: true
      ports:
        - port: 9090
          targetport: 9090
          lbtype: tcp
