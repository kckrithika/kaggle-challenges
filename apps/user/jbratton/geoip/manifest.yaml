apiVersion: v1

system:
  functions:
    - name: geoip-backend
      count: 3
      containers:
        - name: backend
          image: shared0-samcontrol1-1-prd.eng.sfdc.net:5000/geoip:dev
          ports:
            - name: b-port
              containerPort: 7020
            - name: b-man-port
              containerPort: 15372
        - name: backend-sherpa
          image: shared0-samcontrol1-1-prd.eng.sfdc.net:5000/sherpa:dev
          args: ["-s", "localhost"]
          ports:
            - name: b-admin-port
              containerPort: 7080
            - name: b-in-port
              containerPort: 7012
    - name: geoip-frontend
      count: 1
      containers:
        - name: frontend
          image: shared0-samcontrol1-1-prd.eng.sfdc.net:5000/geoip-demo:dev
          env:
            # Route geoip requests to frontend-sherpa's outgoing request port.
            - name: GRPC_ROUTING_GEOIP_HOST
              value: localhost
            - name: GRPC_ROUTING_GEOIP_PORT
              value: 7011
          ports:
            - name: f-port
              containerPort: 8080
            - name: f-man-port
              containerPort: 15373
        - name: frontend-sherpa
          image: shared0-samcontrol1-1-prd.eng.sfdc.net:5000/sherpa:dev
          # TODO: This destination and port is wrong. For the demo we'll manually edit the linkerd config to set up the right dtab entries.
          args: ["-d", "localhost", "-q", "7012"]
          orts:
            - name: f-admin-port
              containerPort: 7080
