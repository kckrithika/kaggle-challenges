apiVersion: v1

system:
  notifications:
    email:
      - gid_runtime@salesforce.com
  functions:
    - name: gid-runtime-service
      count: 1
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 0
          maxUnavailable: 1
      hostnetwork: false
      containers:
        #####################################################################################
        # Global Identity Loing and Runtime Service
        #####################################################################################
        - name: gid-runtime-service
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/coravivattanakul/gidkmssyne:v1
          imagePullPolicy: Always
          env:
            - name: server_use_forward_headers
              value: true
            - name: server_port
              value: 7022
            - name: management_server_port
              value: 15375
            - name: login_vip_url
              value: https://gidruntimelb.global-identity.xrd-sam.xrd.slb.sfdc.net
            - name: kms_caPath
              value: /certs/ca/cacerts.pem
            - name: kms_monitoredDirectory
              value: /certs/client
            - name: kms_serverUrl
              value: https://smsapi1-0-xrd.data.sfdc.net
          ports:
            - containerPort: 7022
            - containerPort: 15375
          livenessProbe:
            httpGet:
              path: /manage/info
              port: 15375
          volumeMounts:
            - mountPath: /certs
              name: client-cert
      #####################################################################################
      # Volumes Needed
      #####################################################################################
      volumes:
        - name: server-cert
          maddogCert:
            type: server
        - name: client-cert
          maddogCert:
            type: client
        - name: logvolsherpa
          hostPath:
            path: /home/sfdc-gid-runtime-sherpa/logs
        - name: logvolbeacon
          hostPath:
            path: /home/sfdc-gid-runtime-beacon/logs
  #####################################################################################
  # SLB
  #####################################################################################
  loadbalancers:
    - lbname: gidruntimelb
      function: gid-runtime-service
      slbEnabled: true
      ports:
        - port: 443
          targetport: 7022
          lbtype: http
          tls: true
          reencrypt: false
