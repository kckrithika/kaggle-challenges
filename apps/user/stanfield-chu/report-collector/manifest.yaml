---
  apiVersion: "v1"
  system: 
    functions: 
      - 
        containers: 
          - 
            args: 
              - "export ReportCollector_ajna_funnelHost=${SFDC_METRICS_SERVICE_HOST} ;\nexport ReportCollector_ajna_funnelPort=${SFDC_METRICS_SERVICE_PORT} ;\nexport ReportCollector_ajna_datacenter=${KINGDOM} ;\nexport ReportCollector_ajna_device=${ESTATE}.${FUNCTION_NAMESPACE}.${FUNCTION}.${FUNCTION_INSTANCE_NAME} ;\n${JAVA_HOME}/bin/java\n-Dlogback.configurationFile=${APP_DIR}/logback-docker.xml\n-Dvertx.disableFileCPResolving=true\n-Dvertx.logger-delegate-factory-class-name=io.vertx.core.logging.SLF4JLogDelegateFactory\n-Dvertx.metrics.options.enabled=true\n-Dvertx.metrics.options.registryName=vertx-registry\n-Dvertx.disableDnsResolver=true\n-Dlog_dir=${LOG_DIR}\n-Dinstance=${FUNCTION_INSTANCE_NAME}\n-jar ${JAR_PATH}\n"
            command: 
              - "/bin/sh"
              - "-c"
            env: 
              - 
                name: "DUMMY_UNUSED_ENV_VAR_FOR_POD_BOUNCE"
                value: 1
              - 
                name: "ReportCollector_redis_host"
                value: "$(REDISLB_SERVICE_HOST)"
              - 
                name: "ReportCollector_redis_port"
                value: "$(REDISLB_SERVICE_PORT)"
              - 
                name: "ReportCollector_redis_fullPathToAuthFile"
                value: "/var/secrets/redis/auth"
              - 
                name: "ReportCollector_app_https_enabled"
                value: true
              - 
                name: "ReportCollector_app_https_providerPort"
                value: 8443
              - 
                name: "ReportCollector_app_https_consumerPort"
                value: 8444
              - 
                name: "ReportCollector_app_https_clientAuth"
                value: "REQUEST"
              - 
                name: "ReportCollector_app_https_caCertificate"
                value: "/var/lib/report-collector/certificates/sfdc-internal-ca.crt"
              - 
                name: "ReportCollector_app_https_certificate"
                value: "/var/lib/report-collector/certificates/server/rc_server.crt"
              - 
                name: "ReportCollector_app_https_privateKey"
                value: "/var/lib/report-collector/certificates/server/rc_server.key"
              - 
                name: "ReportCollector_ajna_publishEnabled"
                value: false
              - 
                name: "ReportCollector_app_verticleCounts_ProviderEndpointVerticle"
                value: 10
              - 
                name: "ReportCollector_app_verticleCounts_ConsumerEndpointVerticle"
                value: 10
            image: "ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/stanfield.chu/report-collector:1.10.0-20180122-secScan"
            livenessProbe: 
              httpGet: 
                path: "/healthz"
                port: 8080
              initialDelaySeconds: 5
            name: "testreport-collector"
            ports: 
              - 
                containerPort: 8080
                name: "provider"
              - 
                containerPort: 8081
                name: "consumer"
              - 
                containerPort: 8082
                name: "admin"
              - 
                containerPort: 8443
                name: "provider-https"
              - 
                containerPort: 8444
                name: "consumer-https"
            volumeMounts: 
              - 
                mountPath: "/var/log/report-collector"
                name: "logvol"
              - 
                mountPath: "/var/lib/report-collector/certificates/server/"
                name: "servercertvol"
                readOnly: true
              - 
                mountPath: "/var/secrets/redis"
                name: "redisauthvol"
                readOnly: true
          - 
            args: 
              - "while sleep ${CLEANUP_PERIOD_SECONDS};\ndo\n    echo $(date) \"Processing\" $CLEANUP_FOLDER;\n    if [ ! -d \"$CLEANUP_FOLDER\" ]; then\n        echo $CLEANUP_FOLDER \" doesn''t exist\";\n        continue;\n    fi;\n\n    find $CLEANUP_FOLDER -name \"$CLEANUP_FILE_PATTERN\" -mmin +$CLEANUP_FILE_AGE_MINUTES -type f -print -delete;\ndone\n"
            command: 
              - "/bin/sh"
              - "-c"
            env: 
              - 
                name: "CLEANUP_FOLDER"
                value: "/var/log/report-collector"
              - 
                name: "CLEANUP_PERIOD_SECONDS"
                value: 1800
              - 
                name: "CLEANUP_FILE_PATTERN"
                value: "*tmp*"
              - 
                name: "CLEANUP_FILE_AGE_MINUTES"
                value: 30
            image: "ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/stanfield.chu/report-collector:1.10.0-20180122-secScan"
            livenessProbe: 
              exec: 
                command: 
                  - "echo"
                  - "always_healthy"
              initialDelaySeconds: 5
              periodSeconds: 30
            name: "csc-health-stale-log-cleaner"
            volumeMounts: 
              - 
                mountPath: "/var/log/report-collector"
                name: "logvol"
        count: 1
        name: "testreport-collector"
        volumes: 
          - 
            name: "servercertvol"
            secret: 
              secretName: "csc-rc-certificates"
          - 
            name: "redisauthvol"
            secret: 
              secretName: "csc-redis-auth-0"
          - 
            hostPath: 
              path: "/var/log/report-collector"
            name: "logvol"
      - 
        containers: 
          - 
            image: "tnrp/csc-health/redis-auth:3.2"
            livenessProbe: 
              initialDelaySeconds: 5
              tcpSocket: 
                port: 6379
            logs: 
              - 
                directory: "/var/log/redis"
            name: "redis"
            ports: 
              - 
                containerPort: 6379
            volumeMounts: 
              - 
                mountPath: "/var/secrets/redis"
                name: "redisauthvol"
                readOnly: true
        count: 1
        name: "redis"
        volumes: 
          - 
            name: "redisauthvol"
            secret: 
              secretName: "csc-redis-auth-0"
    loadbalancers: 
      - 
        function: "testreport-collector"
        lbname: "reportcollectorlb"
        nodeExposed: true
        ports: 
          - 
            port: 28080
            targetport: 8080
          - 
            port: 28081
            targetport: 8081
          - 
            port: 28082
            targetport: 8082
          - 
            port: 28443
            targetport: 8443
          - 
            port: 28444
            targetport: 8444
      - 
        function: "redis"
        lbname: "redislb"
        nodeExposed: true
        ports: 
          - 
            port: 26379
            targetport: 6379
    notifications: 
      email: 
        - "stanfield.chu@salesforce.com"

