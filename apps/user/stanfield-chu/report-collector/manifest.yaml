apiVersion: v1

system:
  notifications:
    email:
      - stanfield.chu@salesforce.com
  functions:
  - name: stans-report-collector
    count: 3
    volumes:
      - name: pki-server-cert
        maddogCert:
          type: server
      - name: redisauthvol
        secret:
          secretName: csc-redis-auth-0
      - name: logvol
        hostPath:
          path: /var/log/report-collector
    containers:
    - name: report-collectorha
      image: dva/report-collector:14
      ports:
      - name: admin
        containerPort: 8082
      - name: provider-https
        containerPort: 8443
      volumeMounts:
      - mountPath: /var/log/report-collector
        name: logvol
      - mountPath: /var/secrets/redis
        name: redisauthvol
        readOnly: true
      - mountPath: /serverCert
        name: pki-server-cert
        readOnly: true
      env:
      - name: DUMMY_UNUSED_ENV_VAR_FOR_POD_BOUNCE
        value: 0
      - name: ReportCollector_redis_host
        value: $(REDISLB_SERVICE_HOST)
      - name: ReportCollector_redis_port
        value: $(REDISLB_SERVICE_PORT)
      - name: ReportCollector_redis_fullPathToAuthFile
        value: /var/secrets/redis/auth
      - name: ReportCollector_app_https_enabled
        value: true
      - name: ReportCollector_app_https_providerPort
        value: 8443
      - name: ReportCollector_app_https_clientAuth
        value: REQUEST
      - name: ReportCollector_app_https_dynamicCertificateOptions_caCert
        value: /serverCert/ca.pem
      - name: ReportCollector_app_https_dynamicCertificateOptions_certificateDir
        value: /serverCert/server/
      - name: ReportCollector_app_https_supportDecompression
        value: true
      - name: ReportCollector_app_https_supportCompression
        value: true
      - name: ReportCollector_app_http_enabled
        value: false
      - name: ReportCollector_app_redisWriteCircuitBreaker_resetTimeout
        value: 10000
      - name: ReportCollector_app_serviceProtection_enabled
        value: true
      - name: ReportCollector_app_serviceProtection_publishPeriodMs
        value: 300000
      - name: ReportCollector_ajna_publishEnabled
        value: true
      - name: ReportCollector_app_verticleCounts_ProviderEndpointVerticle
        value: 10
      - name: ReportCollector_app_verticleCounts_ConsumerEndpointVerticle
        value: 0
      - name: ReportCollector_datastore
        value: redisIndex
      livenessProbe:
        httpGet:
          scheme: HTTPS
          path: /redisHealth
          port: 8443
        initialDelaySeconds: 10
        periodSeconds: 60
        timeoutSeconds: 15
        failureThreshold: 10
      command: ["/bin/sh", "-c"]
      args: ["
      export ReportCollector_ajna_funnelHost=${SFDC_METRICS_SERVICE_HOST} ;
      export ReportCollector_ajna_funnelPort=${SFDC_METRICS_SERVICE_PORT} ;
      export ReportCollector_ajna_datacenter=TEST ;
      export ReportCollector_ajna_device=stans-reportcollector.${FUNCTION_INSTANCE_NAME} ;
      ${JAVA_HOME}/bin/java
        -Dlogback.configurationFile=${APP_DIR}/logback-docker.xml
        -Dvertx.cacheDirBase=${CACHE_DIR}
        -Dvertx.logger-delegate-factory-class-name=io.vertx.core.logging.SLF4JLogDelegateFactory
        -Dvertx.metrics.options.enabled=true
        -Dvertx.metrics.options.registryName=vertx-registry
        -Dvertx.metrics.options.configPath=metric-options.json
        -Dvertx.disableDnsResolver=true
        -Dlog_dir=${LOG_DIR}
        -Dinstance=${FUNCTION_INSTANCE_NAME}
        -jar ${JAR_PATH}
      "]
    - name: csc-health-stale-log-cleaner
      image: dva/report-collector:14
      volumeMounts:
        - mountPath: /var/log/report-collector
          name: logvol
      env:
        - name: CLEANUP_FOLDER
          value: /var/log/report-collector
        - name: CLEANUP_PERIOD_SECONDS
          value: 1800
        - name: CLEANUP_FILE_PATTERN
          value: "*tmp*"
        - name: CLEANUP_FILE_AGE_MINUTES
          value: 30
      livenessProbe:
        exec:
          command:
          - echo
          - always_healthy
        initialDelaySeconds: 5
        periodSeconds: 30
      command: ["/bin/sh", "-c"]
      args: ['
          while sleep ${CLEANUP_PERIOD_SECONDS};
          do
              echo $(date) "Processing" $CLEANUP_FOLDER;
              if [ ! -d "$CLEANUP_FOLDER" ]; then
                  echo $CLEANUP_FOLDER " doesn''t exist";
                  continue;
              fi;

              find $CLEANUP_FOLDER -name "$CLEANUP_FILE_PATTERN" -mmin +$CLEANUP_FILE_AGE_MINUTES -type f -print -delete;
          done
      ']
  - name: stans-temp-store
    count: 1
    volumes:
      - name: pki-server-cert
        maddogCert:
          type: server
      - name: redisauthvol
        secret:
          secretName: csc-redis-auth-0
    containers:
    - name: stans-temp-store
      image: dva/report-collector:14
      ports:
      - name: provider-https
        containerPort: 8443
      - name: consumer-https
        containerPort: 8444
      volumeMounts:
      - mountPath: /serverCert
        name: pki-server-cert
        readOnly: true
      - mountPath: /var/secrets/redis
        name: redisauthvol
        readOnly: true
      env:
      - name: DUMMY_UNUSED_ENV_VAR_FOR_POD_BOUNCE
        value: 0
      - name: ReportCollector_datastore
        value: redisIndex
      - name: ReportCollector_redis_host
        value: $(REDISLB_SERVICE_HOST)
      - name: ReportCollector_redis_port
        value: $(REDISLB_SERVICE_PORT)
      - name: ReportCollector_redis_fullPathToAuthFile
        value: /var/secrets/redis/auth
      - name: ReportCollector_app_http_enabled
        value: false
      - name: ReportCollector_app_https_enabled
        value: true
      - name: ReportCollector_app_https_consumerPort
        value: 8444
      - name: ReportCollector_app_https_clientAuth
        value: REQUEST
      - name: ReportCollector_app_https_dynamicCertificateOptions_caCert
        value: /serverCert/ca.pem
      - name: ReportCollector_app_https_dynamicCertificateOptions_certificateDir
        value: /serverCert/server/
      - name: ReportCollector_app_https_supportCompression
        value: true
      - name: ReportCollector_app_redisWriteCircuitBreaker_resetTimeout
        value: 10000
      - name: ReportCollector_app_serviceProtection_enabled
        value: true
      - name: ReportCollector_app_serviceProtection_publishPeriodMs
        value: 300000
      - name: ReportCollector_ajna_publishEnabled
        value: true
      - name: ReportCollector_app_verticleCounts_ProviderEndpointVerticle
        value: 3
      - name: ReportCollector_app_verticleCounts_ConsumerEndpointVerticle
        value: 10
      - name: ReportCollector_cacheBuilder_enabled
        value: true
      - name: ReportCollector_cacheBuilder_defaultCacheBuilderParams_minDelay
        value: 300000
      - name: ReportCollector_cacheBuilder_cacheDir
        value: /var/cache/report-collector/consumer-cache/
      - name: ReportCollector_cacheBuilder_cacheBuilders
        value: |
             [
              { "filter": { "type": "watchdog", "providerId": "mom", "trusted": true },
                "maxDelay": 20000 },
              { "filter": { "type": "watchdog", "providerId": "grok.server_watchdog", "trusted": true },
                "maxDelay": 20000 },
              { "filter": { "type": "watchdog", "providerId": "sandman", "trusted": true },
                "maxDelay": 20000 },
              { "filter": { "type": "watchdog", "providerId": "netmgt.sandman", "trusted": true },
                "maxDelay": 20000 },
              { "filter": { "type": "watchdog", "providerId": "app.infrastructure-watchdog-cpt", "trusted": true },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "watchdog", "providerId": "cbatch.infrastructure-watchdog-cpt", "trusted": true },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "watchdog", "providerId": "dapp.infrastructure-watchdog-cpt", "trusted": true },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "watchdog", "providerId": "ffx.infrastructure-watchdog-cpt", "trusted": true },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "watchdog", "providerId": "health.infrastructure-watchdog-cpt", "trusted": true },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "watchdog", "providerId": "search.infrastructure-watchdog-cpt", "trusted": true },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "watchdog", "providerId": "*.infrastructure-watchdog-cpt", "trusted": true },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "watchdog", "providerId": "*.infrastructure-watchdog-CP-health", "trusted": true },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "watchdog", "providerId": "nagios-adapter", "trusted": false },
                "minDelay": 60000,
                "maxDelay": 120000 },
              { "filter": { "type": "observer", "providerId": "netmgt.nhal_client", "trusted": true },
                "maxDelay": 20000 },
              { "filter": { "type": "observer", "providerId": "netmgt.sandman", "trusted": true },
                "maxDelay": 20000 },
              { "filter": { "type": "observer", "providerId": "sandman", "trusted": true },
                "maxDelay": 20000 },
              { "filter": { "type": "observer", "providerId": "infrastructure-observer.system", "trusted": false },
                "minDelay": 600000,
                "maxDelay": 600000 },
              { "filter": { "type": "observer", "providerId": "infrastructure-observer.grok", "trusted": false },
                "minDelay": 600000,
                "maxDelay": 600000 },
              { "filter": { "providerId": "infrastructure-watchdog" },
                "minDelay": 200000,
                "maxDelay": 300000 },
              { "filter": { "providerId": "slwd" },
                "minDelay": 420000,
                "maxDelay": 840000 },
              { "filter": { "providerId": "racktastic" },
                "minDelay": 3600000,
                "maxDelay": 14400000 },
              { "filter": { "providerId": "service-config-agent" },
                "minDelay": 3600000,
                "maxDelay": 14400000 },
              { "filter": { "providerId": "infrastructure-observer.system" },
                "minDelay": 600000,
                "maxDelay": 600000 },
              { "filter": { "providerId": "infrastructure-observer.grok" },
                "minDelay": 600000,
                "maxDelay": 600000 },
              { "filter": { "providerId": "infrastructure-observer.custom" },
                "minDelay": 600000,
                "maxDelay": 600000 },
              { "filter": { "providerId": "infrastructure-observer.rps" },
                "minDelay": 600000,
                "maxDelay": 600000 },
              { "filter": { "providerId": "csc-health.cname-repcollavailwd", "trusted": true },
                "minDelay": 5000,
                "maxDelay": 5000 },
              { "filter": { "providerId": "csc-health.repcollavailwd", "trusted": true },
                "minDelay": 5000,
                "maxDelay": 5000 },
              { "filter": { "providerId": "samapp.user-stanfield-chu.stans-repcollavailwd", "trusted": true },
                "minDelay": 5000,
                "maxDelay": 5000 },
              { "filter": { "providerId": "health.report-collector-availability-watchdog", "trusted": true },
                "minDelay": 5000,
                "maxDelay": 5000 }
             ]

      livenessProbe:
        httpGet:
          scheme: HTTPS
          path: /redisHealth
          port: 8443
        initialDelaySeconds: 10
        periodSeconds: 60
        timeoutSeconds: 15
        failureThreshold: 10
      command: ["/bin/sh", "-c"]
      args: ["
      export ReportCollector_ajna_funnelHost=${SFDC_METRICS_SERVICE_HOST} ;
      export ReportCollector_ajna_funnelPort=${SFDC_METRICS_SERVICE_PORT} ;
      export ReportCollector_ajna_datacenter=TEST ;
      export ReportCollector_ajna_device=stans-tempstore.${FUNCTION_INSTANCE_NAME};

      ${JAVA_HOME}/bin/java
        -Dlogback.configurationFile=${APP_DIR}/logback-docker.xml
        -Dvertx.disableFileCPResolving=true
        -Dvertx.logger-delegate-factory-class-name=io.vertx.core.logging.SLF4JLogDelegateFactory
        -Dvertx.metrics.options.enabled=true
        -Dvertx.metrics.options.registryName=vertx-registry
        -Dvertx.disableDnsResolver=true
        -Dlog_dir=${LOG_DIR}
        -Dinstance=${FUNCTION_INSTANCE_NAME}
        -d64
        -Xmx40g
        -jar ${JAR_PATH}
      "]
  - name: redis
    count: 1
    volumes:
      - name: redisauthvol
        secret:
          secretName: csc-redis-auth-0
    containers:
    - name: redis
      image: dva/csc-health-redis-auth:1
      volumeMounts:
      - mountPath: /var/secrets/redis
        name: redisauthvol
        readOnly: true
      ports:
      - containerPort: 6379
      livenessProbe:
        tcpSocket:
          port: 6379
        initialDelaySeconds: 5
      env:
      - name: DUMMY_UNUSED_ENV_VAR_FOR_POD_BOUNCE
        value: 0

  loadbalancers:
  - lbname: stansreportcollectorlb
    function: stans-report-collector
    nodeExposed: true
    ports:
    - port: 28082
      targetport: 8082
    - port: 28443
      targetport: 8443
  - lbname: stanstempstorelb
    function: stans-temp-store
    nodeExposed: true
    ports:
    - port: 28444
      targetport: 8444
  - lbname: redislb
    function: redis
    nodeExposed: true
    ports:
      - port: 16379
        targetport: 6379
