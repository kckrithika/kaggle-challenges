apiVersion: v1

system:
  functions:
  - name: redis
    count: 2
    hostnetwork: true
    type: stateful-set
    lbname: ea-redis-lb
    terminationGracePeriodSeconds: 30
    containers:
    - name: redis
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/pmantha/redis:5.0.5
      resources:
        requests:
          memory: "1Gi"
          cpu: "1"
        limits:
          memory: "16Gi"
          cpu: "2"
      ports:
      - containerPort: 6379
      readinessProbe:
        tcpSocket:
          port: 6379
        initialDelaySeconds: 5
        periodSeconds: 10
      livenessProbe:
        tcpSocket:
          port: 6379
        failureThreshold: 3
        initialDelaySeconds: 5
        periodSeconds: 60
      volumeMounts:
        - name: datavol-redis
          mountPath: /data
    volumes: 
        - hostPath: 
            path: /data/ea/redis/data
          name: datavol-redis

  - name: cassandra
    type: stateful-set
    count: 3
    lbname: ea-cassandra-lb
    containers:
    - name: cassandra
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/pmantha/cassandra:v13
      imagePullPolicy: Always
      ports:
      - containerPort: 7000
        name: intra-node
      - containerPort: 7001
        name: tls-intra-node
      - containerPort: 7199
        name: jmx
      - containerPort: 9042
        name: cql
      resources:
        limits:
          cpu: "500m"
          memory: 1Gi
        requests:
          cpu: "500m"
          memory: 1Gi
      env:
        - name: MAX_HEAP_SIZE
          value: 512M
        - name: HEAP_NEWSIZE
          value: 100M
        - name: CASSANDRA_SEEDS
          value: "cassandra-0.cassandra.default.svc.cluster.local"
        - name: CASSANDRA_CLUSTER_NAME
          value: "K8Demo"
        - name: CASSANDRA_DC
          value: "DC1-K8Demo"
        - name: CASSANDRA_RACK
          value: "Rack1-K8Demo"
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
      livenessProbe:
        tcpSocket:
          port: 9042
        failureThreshold: 3
        initialDelaySeconds: 15
        periodSeconds: 15        
      readinessProbe:
        exec:
          command:
          - /bin/bash
          - -c
          - /ready-probe.sh
        initialDelaySeconds: 15
        timeoutSeconds: 5
      # These volume mounts are persistent. They are like inline claims,
      # but not exactly because the names need to match exactly one of
      # the stateful pod volumes.
      volumeMounts:
      - name: datavol-cassandra
        mountPath: /cassandra_data      
    volumes: 
        - hostPath: 
            path: /data/ea/cassandra/data
          name: datavol-cassandra
  loadbalancers: 
  - lbname: redis
    function: redis
    slbEnabled: true
    ports:
    - port: 6379
      targetport: 6379
      lbtype: tcp
  - lbname: cassandra
    function: cassandra
    slbenabled: true
    ports:
      - port: 9042
        targetport: 9042
        lbtype: tcp

