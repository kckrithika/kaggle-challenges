apiVersion: v1

system:
  functions:
  - name: sme-beacon
    count: 4
    volumes:
    - name: tls-client-cert
      maddogCert:
        type: client
    - name: tls-server-cert
      maddogCert:
        type: server
    containers:
    - name: search-model-executor
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/m-krishnan/smt-search-model-executor:no-announcement
      ports:
      - name: service-port
        containerPort: 7020
      - name: admin-port
        containerPort: 15372
      resources:
        limits: { cpu: 4, memory: "10Gi" }
        requests: { cpu: 4, memory: "4Gi" }
      livenessProbe:
        exec:
          command: ["./runcheck.sh", "5"]
        initialDelaySeconds: 60
        timeoutSeconds: 10
      readinessProbe:
        exec:
          command: ["./runcheck.sh", "5"]
        initialDelaySeconds: 60
        timeoutSeconds: 10
        periodSeconds: 60
    - name: beacon
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
      args:
      # mTLS port
      - -endpoint
      - samapp/m-krishnan/sme-beacon:DATACENTER_ALLENV:7443

      # Plaintext port
      - -endpoint
      - sme-beacon-plaintext:DATACENTER_ALLENV:7012
      livenessProbe:
        exec:
          command: ["/home/scone/is-alive.sh"]
        initialDelaySeconds: 5
    - name: sherpa-b
      image: sfci/servicelibs/sherpa:2.0.25
      ports:
      - name: sherpa-b-ptx
        containerPort: 7012
      - name: sherpa-b-tls
        containerPort: 7443
      - name: sherpa-b-adm
        containerPort: 7080
      livenessProbe:
        exec:
          command: ["./bin/is-alive"]
        initialDelaySeconds: 120
        periodSeconds: 5
      readinessProbe:
        exec:
          command: ["./bin/is-ready"]
        initialDelaySeconds: 110
        periodSeconds: 5
      volumeMounts:
      - name: tls-client-cert
        mountPath: /client-certs
      - name: tls-server-cert
        mountPath: /server-certs

  - name: sme-1
    count: 4
    containers:
    - name: search-model-executor
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/ssstestorganization/smt-search-model-executor:0.0-RC.4
      args:
      - --modelstore.repo.models=model_repository_root/models
      - --modelstore.repo.manifests=model_repository_root/datacenters/${KINGDOM}/sme-1
      env:
      - name: GRPC_ANNOUNCED_NAME
        value: sme-1
      ports:
      - name: service-port
        containerPort: 7020
      - name: admin-port
        containerPort: 15372
      resources:
        limits: { cpu: 4, memory: "10Gi" }
        requests: { cpu: 4, memory: "4Gi" }
      livenessProbe:
        exec:
          command: ["./runcheck.sh", "5"]
        initialDelaySeconds: 60
        timeoutSeconds: 10
      readinessProbe:
        exec:
          command: ["./runcheck.sh", "5"]
        initialDelaySeconds: 60
        timeoutSeconds: 10
        periodSeconds: 60
    - name: sherpa-b
      image: sfci/servicelibs/sherpa:2.0.25
      ports:
      - name: sherpa-b-in
        containerPort: 7012
      - name: sherpa-b-adm
        containerPort: 7080
      livenessProbe:
        exec:
          command: ["./bin/is-alive"]
        initialDelaySeconds: 120
        periodSeconds: 5
      readinessProbe:
        exec:
          command: ["./bin/is-ready"]
        initialDelaySeconds: 110
        periodSeconds: 5

