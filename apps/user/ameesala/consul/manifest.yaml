apiVersion: v1
system:
  functions:
  - name: consul
    count: 3
    type: stateful-set
    containers:
    - name: consul
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/ameesala/consul-off-am-alpine:ameesala-20190211-2
      args:
        - "agent"
        - "-advertise=$(FUNCTION_INSTANCE_IP)"
        - "-bind=0.0.0.0"
        - "-bootstrap-expect=3"
        - "-retry-join=consul-0"
        - "-retry-join=consul-1"
        - "-client=$(FUNCTION_INSTANCE_IP)"
        - "-datacenter=dc1"
        - "-data-dir=/consul/data"
        - "-domain=cluster.local"
        - "-server"
        - "-ui"
        - "-disable-host-node-id"
      ports:
      - containerPort: 8500
        name: http
      - containerPort: 8301
        name: serflan
      - containerPort: 8302
        name: serfwan
      - containerPort: 8300
        name: consulserver
      - containerPort: 8600
        name: consuldns
      livenessProbe:
        httpGet:
          path: /
          port: 8500
    lbname: consul-stateful-ilb
  loadbalancers:
  - lbname: consul-lb
    function: consul
    slbEnabled: true
    ports:
      - port: 8500
        targetport: 8500
        lbtype: http
