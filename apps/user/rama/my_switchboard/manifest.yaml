apiVersion: v1
system:
  functions:
  - name: switchboard
    serviceAccountName: service-mesh.route-update-service-service-account
    count: 1
    labels:
      app: my-switchboard
    containers:
    - name: my-switchboard
      image: sfci/servicelibs/switchboard:3ba7195ec2fd1c2ace95c502ae40acf5e56b34ae
      args:
      - --clusters.external-clusters[0]=ajnafunneldirect:HTTP1
      - --clusters.external-clusters[1]=spaasmesh:HTTP2
      - --routeupdates.use.k8s=true
      - --casam.default.namespace=service-mesh
      ports:
      - containerPort: 15372
      env:
      - name: SFDC_ENVIRONMENT
        value: stm
      - name: GRPC_SERVER_BIND_ENDPOINT
        value: tcp://0.0.0.0:7020
      - name: JVM_HEAP_MAX
        value: 4G
      - name: FAKE_ENV_VAR_INCREMENT_TO_TRIGGER_SAM_DEPLOY
        value: "1"
      resources:
        limits:
          cpu: "8"
          memory: 6Gi
        requests:
          cpu: "8"
          memory: 6Gi
      livenessProbe:
        httpGet:
          path: /manage/health
          port: 15372
        initialDelaySeconds: 20
        periodSeconds: 5
        timeoutSeconds: 4
      readinessProbe:
        httpGet:
          path: /manage/ready
          port: 15372
        # Switchboard won't become Ready until there was a successful scrape.
        # So we don't want to start touching the readiness probe until then.
        # Using 60+ seconds here will also allow us to slow down the gradual rollout 
        initialDelaySeconds: 60
        periodSeconds: 5
        timeoutSeconds: 4
      terminationMessagePolicy: FallbackToLogsOnError

