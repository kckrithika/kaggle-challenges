apiVersion: v1
system:
  functions:
    - name: gid-service-layer
      count: 1
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 0
          maxUnavailable: 1
      containers:
      #####################################################################################
      # Service Mesh / Envoy / Sherpa
      #####################################################################################
      - name: sherpa-gid-service
        image: sfci/servicelibs/sherpa-envoy:1.0.7
        env:
        - name: SFDC_ENVIRONMENT
          value: "stmfa"
        resources:
          limits: { cpu: "1", memory: "1Gi" }
          requests: { cpu: "1", memory: "1Gi" }
        volumeMounts:
        - name: client-cert
          mountPath: /client-certs
        - name: server-cert
          mountPath: /server-certs
        - mountPath: /log
          name: logvolsherpa
        ports:
        - containerPort: 7012
          name: sherpa-in
        - containerPort: 7014
          name: http1-in
        - containerPort: 7442
          name: http1-tls-in
        - containerPort: 15373
          name: sherpa-adm
        livenessProbe:
          exec:
            command:
            - "/home/sfdc-sherpa/bin/is-alive"
          initialDelaySeconds: 120
          periodSeconds: 5
        readinessProbe:
          exec:
            command:
            - "/home/sfdc-sherpa/bin/is-ready"
          initialDelaySeconds: 110
          periodSeconds: 5
      #####################################################################################
      # Service Beacon
      #####################################################################################
      - name: beacon-gid-service
        image: sfci/servicelibs/beacon:7ad9e771192cd0b3e43393eea2e1e5c1de81dfda
        imagePullPolicy: Always
        env:
        - name: SFDC_ENVIRONMENT
          value: "stmfa"
        volumeMounts:
        - mountPath: /log
          name: logvolbeacon
        resources:
          limits: { cpu: "1", memory: "1Gi" }
          requests: { cpu: "1", memory: "1Gi" }
        args:
          - -endpoint
          - $(FUNCTION_NAMESPACE)/$(FUNCTION):DATACENTER_ALLENV:7442
        livenessProbe:
          exec:
            command:
            - "/home/scone/is-alive.sh"
          initialDelaySeconds: 5
          periodSeconds: 5
      #####################################################################################
      # GiD service
      #####################################################################################
      - name: gid-service 
        image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/nfayazov/gid-service:latest
        imagePullPolicy: Always
        env:
          - name: server_port
            value: 7022
          - name: management_server_port
            value: 15371
          - name: ca_service_host
            value: 10.233.180.195
          - name: security_client_dynamickeystore_cadir
            value: /certs
          - name: security_client_dynamickeystore_monitoredDirectory
            value: /certs
        ports:
          - containerPort: 7022
          - containerPort: 15371
        livenessProbe:
          exec:
            command:
            - /bin/true
        volumeMounts:
          - name: server-cert
            mountPath: /certs
      #####################################################################################
      # Volumes Needed
      #####################################################################################
      volumes:
      - name: server-cert
        maddogCert:
          type: server
      - name: client-cert
        maddogCert:
          type: client
      - name: logvolsherpa
        hostPath:
          path: /home/sfdc-scone-hellodiscovery-sherpa/logs
      - name: logvolbeacon
        hostPath:
          path: /home/sfdc-scone-hellodiscovery-beacon/logs
  #####################################################################################
  # SLB
  #####################################################################################
  loadbalancers:
    - lbname: gidservicelb
      function: gid-service-layer
      slbEnabled: true
      ports:
        - port: 9090
          targetport: 7014
