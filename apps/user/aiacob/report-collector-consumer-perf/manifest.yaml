apiVersion: v1

system:
  notifications:
    email:
      - aiacob@salesforce.com
  functions:
  - name: andreis-locust-consumer-master
    count: 1
    volumes:
      - name: certvol
        secret:
          secretName: csc-rc-hack-certificates
    containers:
    - name: andreis-locust-consumer-master
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/aiacob/andreis-locust:201802081024
      resources:
        limits: { cpu: "1", memory: "2Gi" }
        requests: { cpu: "1", memory: "2Gi" }
      ports:
        - name: loc-master-ui
          containerPort: 8089
        - name: loc-master-w1
          containerPort: 5557
        - name: loc-master-w2
          containerPort: 5558
      volumeMounts:
      - mountPath: /var/lib/certs
        name: certvol
        readOnly: true
      env:
      - name: DUMMY_UNUSED_ENV_VAR_FOR_POD_BOUNCE
        value: 3
      - name: LOCUST_FUNCTION
        value: master
      - name: LOCUST_WEIGHT_GET_WATCHDOG_REPORTS
        value: 3
      - name: LOCUST_WEIGHT_GET_OBSERVER_REPORTS
        value: 3
      - name: LOCUST_WEIGHT_GET_ALL_REPORTS
        value: 1
      - name: LOCUST_RC_CONSUMER_PROTOCOL
        value: https
      - name: LOCUST_RC_CONSUMER_HOST
        value: $(ANDREISREPORTCOLLECTORLB_SERVICE_HOST)
      - name: LOCUST_RC_CONSUMER_PORT
        value: $(ANDREISREPORTCOLLECTORLB_SERVICE_PORT_TCP8449)
      - name: LOCUST_CLIENT_VERIFY
        value: /var/lib/certs/ca.crt
      - name: LOCUST_CLIENT_CERT
        value: /var/lib/certs/rc_client.crt
      - name: LOCUST_CLIENT_KEY
        value: /var/lib/certs/rc_client.key
      livenessProbe:
        exec:
          command:
          - "true"

  - name: andreis-locust-consumer-worker
    count: 5
    volumes:
      - name: certvol
        secret:
          secretName: csc-rc-hack-certificates
    containers:
    - name: locust-worker
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/aiacob/andreis-locust:201802081024
      resources:
        limits: { cpu: "1", memory: "2Gi" }
        requests: { cpu: "1", memory: "2Gi" }
      volumeMounts:
      - mountPath: /var/lib/certs
        name: certvol
        readOnly: true
      env:
      - name: LOCUST_FUNCTION
        value: worker
      - name: LOCUST_WEIGHT_GET_WATCHDOG_REPORTS
        value: 3
      - name: LOCUST_WEIGHT_GET_OBSERVER_REPORTS
        value: 3
      - name: LOCUST_WEIGHT_GET_ALL_REPORTS
        value: 1
      - name: LOCUST_RC_CONSUMER_PROTOCOL
        value: https
      - name: LOCUST_RC_CONSUMER_HOST
        value: $(ANDREISREPORTCOLLECTORLB_SERVICE_HOST)
      - name: LOCUST_RC_CONSUMER_PORT
        value: $(ANDREISREPORTCOLLECTORLB_SERVICE_PORT_TCP8449)
      - name: LOCUST_CLIENT_VERIFY
        value: /var/lib/certs/ca.crt
      - name: LOCUST_CLIENT_CERT
        value: /var/lib/certs/rc_client.crt
      - name: LOCUST_CLIENT_KEY
        value: /var/lib/certs/rc_client.key
      - name: LOCUST_MASTER_HOST
        value: $(ANDREISLOCUSTMASTERCONSUMERLB_SERVICE_HOST)
      - name: LOCUST_MASTER_PORT
        value: $(ANDREISLOCUSTMASTERCONSUMERLB_SERVICE_PORT_TCP5559)
      livenessProbe:
        exec:
          command:
          - "true"

  loadbalancers:
    - lbname: andreislocustmasterconsumerlb
      function: andreis-locust-consumer-master
      ports:
        - port: 8090
          targetPort: 8089
          name: loc-master-ui
        - port: 5559
          targetPort: 5557
          name: loc-master-w1
        - port: 5560
          targetPort: 5558
          name: loc-master-w2
