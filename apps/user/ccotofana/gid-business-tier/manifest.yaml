# Manifest for path-based proxying to multiple containers in same kpod.
#
# Next step is for path-based proxying to containers in a different kpod. 
# 
# Misc manifest.yaml notes below
# ====
#
# The value for function.name is subject to Kubernetes naming requirements for DNS_LABELs. 
# It must be 64 or fewer characters long. Stated as a regular expression, this is [a-z0-9]([-a-z0-9]*[a-z0-9]). 
# Note that only lower cased alpha characters are permitted, and the name must start with an alphanumeric character.
#
# https://confluence.internal.salesforce.com/display/SAM/Set+Up+SAM+Network+Options#SetUpSAMNetworkOptions-LoadBalanced
#
# Because you can have multiple functions specified in your SAM manifest, you need to make sure that you have specified non-conflicting
# container and lbnames, non-conflicting port numbers for containers, and non-conflicting port numbers between containers and services. 
#
# If you specify nodeExposed in the loadbalancers section, you cannot specify hostnetwork in the function section.
#
# With nodeExposed set to true, make sure if you specify port values between 1025 and 31999.
# Other ports are reserved for unix (0-1024) and SAM (32000-40000). If you specify a reserved port number, your validation will fail.
# If for some reason you need port 80, specify 8080 instead.
#
# If you do not specify either nodeExposed nor hostnetwork, there is no predictable endpoint. 
# Kubernetes defines a random node port (between 30000 and 40000) when the service is created.
# Once created, you can use it to connect to your container. (See How to Find the Endpoint of a SAM-deployed App).
#
apiVersion: v1
system:
  functions:
  - name: revpathproxytestone
    count: 1

    # Using host networking like CA (no slb)... but do we need to?
    #hostnetwork: true

    containers:
    - name: revpathproxy
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/ccotofana/nginx-revpathproxy:localhost
      ports:
      - containerPort: 9090
      livenessProbe:
        httpGet:
          path: /
          port: 9090
        initialDelaySeconds: 15
        timeoutSeconds: 5

    - name: appone
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/ccotofana/samhello:one 
      ports:
      - containerPort: 9091
      livenessProbe:
        httpGet:
          path: /
          port: 9091

    - name: apptwo
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/ccotofana/samhello:two 
      ports:
      - containerPort: 9092
      livenessProbe:
        httpGet:
          path: /
          port: 9092

  loadbalancers:
  - lbname: revpathproxytestonelb
    function: revpathproxytestone
    nodeExposed: true
    ports:
      - port: 10090
        targetport: 9090

