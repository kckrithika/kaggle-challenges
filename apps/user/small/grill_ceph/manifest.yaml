apiVersion: v1

system:
  functions:
  - name: stateful-grill-ceph
    type: stateful-set
    count: 2
    containers:
    - name: stateful-small
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/small/ceph-test:ceph-v1
      livenessProbe:
        httpGet:
          path: /
          port: 9098
      readinessProbe:
        httpGet:
          path: /metrics
          port: 8080
    - name: sfms
      image: ops0-artifactrepo2-0-prd.data.sfdc.net/docker-release-candidate/tnrp/storagecloud/sfms:latest-0000115-5cf2ec86
      livenessProbe:
        exec:
         command:
         - cat
         - /tmp/healthy
      command:
        - /bin/grill_ceph
        - /opt/sfms/bin/sfms
      ports:
      - containerPort: 9099
        name: web
      volumeMounts:
      - mountPath: /rbd/html
        name: www
      - mountPath: /var/log
        name: container-log-vol
      - mountPath: /var/log-mounted
        name: host-log-vol
      args:
      - -j
      - prometheus
      env:
      - name: SFDC_FUNNEL_VIP
        value: ajna0-funnel1-0-prd.data.sfdc.net:80
      - name: MC_KINGDOM
        value: prd
      - name: MC_ESTATE
        value: prd-sam_storage
      - name: MC_NAME
        value: grill_ceph
      - name: MC_NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
      - name: MC_NODE
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
      - name: MC_DEVICE
        valueFrom:
          fieldRef:
            fieldPath: metadata.name
    lbname: stateful-lb1
    terminationGracePeriodSeconds: 33
    volumeClaimTemplates:
    - name: www
      storageClassName: small-hdd-pool
      storageSizeRequest: 500Gi
    - name: container-log-vol
      storageSizeRequest: 50Gi
    - name: host-log-vol
      storageSizeRequest: 50Gi
  loadbalancers:
  - lbname: cephlb
    function: stateful-grill-ceph
    slbenabled: true
    ports:
      - port: 9099
        targetport: 9099
    initContainers:
    - command:
      - sh
      - -c
      - /entrypoint.sh -g 7337 -u 7337 -s sfdc -l fds
      env:
      - name: KUBEVAR_POD_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.name
      - name: KUBEVAR_POD_NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
      image: ops0-artifactrepo2-0-prd.data.sfdc.net/docker-release-candidate/tnrp/storagecloud/loginitcontainer:base-0000326-f0e05b8b
      name: log-init
      securityContext:
        privileged: true
      volumeMounts:
      - mountPath: /var/log
        name: container-log-vol
      - mountPath: /var/log-mounted
        name: host-log-vol
    nodeSelector:
      master: "true"
    volumes:
    - emptyDir: {}
      name: container-log-vol
    - hostPath:
        path: /var/log
      name: host-log-vol
    - hostPath:
        path: /etc/pki_service
      name: maddog-certs
    - hostPath:
        path: /data/certs
      name: certs
    - hostPath:
        path: /etc/kubernetes
      name: kubeconfig
