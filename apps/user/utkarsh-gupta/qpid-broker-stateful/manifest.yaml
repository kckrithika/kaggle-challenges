apiVersion: v1

system:
  notifications:
    email:
      - utkarsh.gupta@salesforce.com
  functions:
    - name: qpid-broker-mq
      type: stateful-set
      count: 3
      lbname: qpid-broker-mq-lb
      containers:
        - name: sherpa
          image: sfci/servicelibs/sherpa-envoy:1.0.7
          ports:
            - containerPort: 7443
              name: http2-tls-in
            - containerPort: 15373
              name: sherpa-adm
          livenessProbe:
            exec:
              command: ["./bin/is-alive"]
            initialDelaySeconds: 60
            periodSeconds: 5
          readinessProbe:
            exec:
              command: ["./bin/is-ready"]
            initialDelaySeconds: 50
            periodSeconds: 5
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: ENVOY_DEBUG_OPTIONS
              value: --log-level trace --log-path /home/sfdc-sherpa/envoy.log
          volumeMounts:
          - name: sherpaclientcert
            mountPath: /client-certs
          - name: sherpaservercert
            mountPath: /server-certs
          - name: sherpa-log-volume
            mountPath: /log
        - name: qpid
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/utkarsh-gupta/qpid-broker-runtime:latest
          env:
            - name: HTTP_PORT
              value: 7022
            - name: QPID_JAVA_HEAPSZ
              value: 4g
            - name: BASE_AMQP_PORT
              value: 3030
            - name: CALCULATE_AMQP_PORT_INST
              value: 1
            - name: SFDC_ENVIRONMENT
              value: sam 
          resources:
            limits: { cpu: "4", memory: "5G" }
            requests: { cpu: "4", memory: "5G" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 12
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/qpid
              name: logvol
        - name: beacon
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
          command: ["/bin/sh", "-c"]
          args:
            - "export instNumber=${FUNCTION_INSTANCE_NAME: -1};
              export prefix=$(( instNumber + 3 ));
              export port=$(( 3000 + instNumber * 3 ));
              export httpPath=$FUNCTION_NAMESPACE/$FUNCTION_INSTANCE_NAME:POD:7442;
              export amqpPath=$FUNCTION_NAMESPACE/${FUNCTION_INSTANCE_NAME:0:-2}-$prefix:POD:$port;
              /usr/bin/java -jar /home/scone/service.jar -endpoint $amqpPath -endpoint $httpPath;"
            # -endpoint
            # samapp/$(FUNCTION_NAMESPACE)/$(FUNCTION)-http:DATACENTER_ALLENV:7014
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: HTTPX
              value: 7442
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                # "/home/scone/is-alive.sh"
                - "/bin/true"
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          volumeMounts:
            - mountPath: /home/scone/logs
              name: beacon-log-volume
      volumes:
        - name: logvol
          hostpath:
            path: /var/log/qpid
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs
