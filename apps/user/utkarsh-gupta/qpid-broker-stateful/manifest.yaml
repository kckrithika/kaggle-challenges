apiVersion: v1

system:
  notifications:
    email:
      - utkarsh.gupta@salesforce.com
  functions:
    - name: qpid-broker-mq
      type: stateful-set
      count: 3
      lbname: qpid-broker-mq-lb
      annotations:
          "sherpa-injector.service-mesh/inject": "enabled"
      containers:
        - name: qpid-broker-runtime
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/utkarsh-gupta/qpid-broker-runtime:latest
          env:
            - name: HTTP_PORT
              value: 7022
            - name: QPID_JAVA_HEAPSZ
              value: 4g
            - name: BASE_AMQP_PORT
              value: 6000
            - name: CALCULATE_AMQP_PORT_INST
              value: 1
            - name: SFDC_ENVIRONMENT
              value: sam 
          resources:
            limits: { cpu: "4", memory: "5G" }
            requests: { cpu: "4", memory: "5G" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 11
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/qpid
              name: logvol
        - name: beacon
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
          command: ["/bin/sh"]
          args: ["-c", "instNumber=${FUNCTION_INSTANCE_NAME: -1}; prefix=$(( instnumber + 3 )); export c2=qpid-$instNumber; export c1=qpid-$prefix; port=$(( 5999 + instNumber * 3 ));/usr/bin/java -jar /home/scone/service.jar -endpoint samapp/user-utkarsh-gupta/${c1}:POD:${port} -endpoint samapp/user-utkarsh-gupta/${c2}:POD:$HTTPX"]
            # -endpoint
            # samapp/$(FUNCTION_NAMESPACE)/$(FUNCTION)-http:DATACENTER_ALLENV:7014
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: HTTPX
              value: 7442
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                # "/home/scone/is-alive.sh"
                - "/bin/true"
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          volumeMounts:
            - mountPath: /home/scone/logs
              name: beacon-log-volume
      volumes:
        - name: logvol
          hostpath:
            path: /var/log/qpid
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs
