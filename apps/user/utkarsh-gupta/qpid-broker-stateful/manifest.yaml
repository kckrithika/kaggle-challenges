apiVersion: v1

system:
  notifications:
    email:
      - utkarsh.gupta@salesforce.com
  functions:
    - name: qpid-broker-mq
      count: 1
      containers:
        - name: qpid-broker-runtime
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/utkarsh-gupta/qpid-broker-runtime:latest
          ports:
            - name: amqp-port
              containerPort: 2001
              hostPort: 1002
            - name: http-port
              containerPort: 7022
              hostPort: 1003
          env:
            - name: AMQP_PORT
              value: 2001
            - name: HTTP_PORT
              value: 7022
            - name: QPID_JAVA_HEAPSZ
              value: 4g
            - name: SFDC_ENVIRONMENT
              value: sam 
          resources:
            limits: { cpu: "4", memory: "5G" }
            requests: { cpu: "4", memory: "5G" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 11
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/qpid
              name: logvol

        - name: sherpa-qpid
          # https://sconelibci.dop.sfdc.net/job/servicelibs/job/sherpa-envoy/job/master/73
          image: sfci/servicelibs/sherpa-envoy:1.0.5
          # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
          ports:
          - containerPort: 15373
            name: sherpa-adm
          - containerPort: 2000
            name: tcp-in
          - containerPort: 7014
            name: http1-in
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          env:
            - name: SFDC_ENVIRONMENT
              value: sam
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            periodSeconds: 5
          # Mount volumes with certificates. The paths here match the defaults assumed by sherpa
          volumeMounts:
          - name: sherpaclientcert
            mountPath: /client-certs
          - name: sherpaservercert
            mountPath: /server-certs
          - name: sherpa-log-volume
            mountPath: /log

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/qpid
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs
