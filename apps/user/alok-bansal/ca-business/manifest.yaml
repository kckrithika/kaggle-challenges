apiVersion: v1
system:
  functions:
    - name: ca-business-layer
      count: 1
      containers:
        #####################################################################################
        # NGINX Rev Proxy
        #####################################################################################
        - name: nginx-rev-proxy
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/gid/gid-nginx:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8085
          livenessProbe:
            httpGet:
              path: /health
              port: 8085
            initialDelaySeconds: 15
            timeoutSeconds: 10
            periodSeconds: 30
          volumeMounts:
            - mountPath: /var/cache/nginx/client_temp
              name: cache-volume
        #####################################################################################
        # GID service
        #####################################################################################
        - name: gid-service
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/gid/gid-service:latest
          imagePullPolicy: Always
          env:
            - name: server_port
              value: 8081
            - name: management_server_port
              value: 15371
            - name: ca_service_host
              value: 10.233.180.195
            - name: security_client_dynamickeystore_cadir
              value: /certs
            - name: security_client_dynamickeystore_monitoredDirectory
              value: /certs
          ports:
            - containerPort: 8081
            - containerPort: 15371
          livenessProbe:
            httpGet:
              path: /manage/health
              port: 15375
          volumeMounts:
            - name: server-cert
              mountPath: /certs
        #####################################################################################
        # C2C service
        #####################################################################################
        - name: c2c-service
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/gid/c2c-service:latest
          imagePullPolicy: Always
          env:
            - name: server_port
              value: 8082
            - name: management_server_port
              value: 15372
            - name: c2c_common_gdotBasePath
              value: http://127.0.0.1:8090/scim
            - name: GDOT_URL
              value: http://127.0.0.1:8090/scim
          ports:
            - containerPort: 8082
            - containerPort: 15372
          livenessProbe:
            httpGet:
              path: /manage/info
              port: 15372
          volumeMounts:
            - name: server-cert
              mountPath: /certs
        #####################################################################################
        # Entity API
        #####################################################################################
        - name: cloudatlas-service
          image: sfci/cloud-atlas/cloudatlas/cloudatlas-service:2.22split2
          imagePullPolicy: Always
          command: ["java", "-jar", "cloudatlas-service.jar"]
          env:
            - name: server_port
              value: 8083
            - name: management_server_port
              value: 15373
            - name: cloudatlas_http_server_port_servicemesh
              value: 7080
          volumeMounts:
            - mountPath: /log
              name: logvol
            - mountPath: /certs
              name: server-cert
            - mountPath: /clientcerts
              name: client-cert
          ports:
            - containerPort: 7080
            - containerPort: 8083
            - containerPort: 15373
          livenessProbe:
            exec:
              command:
                - /bin/true
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            exec:
              command:
                - /bin/true
            initialDelaySeconds: 60
            periodSeconds: 5
            failureThreshold: 120
      #####################################################################################
      # Volumes Needed
      #####################################################################################
      volumes:
        - name: cache-volume
          emptyDir: {}
        - name: logvol
          emptyDir: {}
        - name: server-cert
          maddogCert:
            type: server
        - name: client-cert
          maddogCert:
            type: client
  #####################################################################################
  # SLB
  #####################################################################################
  loadbalancers:
    - lbname: cabusinesslb
      function: ca-business-layer
      slbEnabled: true
      ports:
        - port: 7022
          targetport: 8085