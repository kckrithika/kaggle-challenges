apiVersion: v1
system:
  functions:
  - name: consul-ns
    count: 3
    type: stateful-set
    containers:
    - name: consul-ns
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/nishant.sinha/consul-cluster-sample:consul-cluster-ns-20191501
      args:
        - "agent"
        - "-advertise=$(FUNCTION_INSTANCE_IP)"
        - "-bind=0.0.0.0"
        - "-bootstrap-expect=3"
        - "-retry-join=consul-0.consul-ns-stateful-ilb.$(FUNCTION_NAMESPACE).svc"
        - "-retry-join=consul-1.consul-ns-stateful-ilb.$(FUNCTION_NAMESPACE).svc"
        - "-retry-join=consul-2.consul-ns-stateful-ilb.$(FUNCTION_NAMESPACE).svc"
        - "-client=$(FUNCTION_INSTANCE_IP)"
        - "-datacenter=dc1"
        - "-data-dir=/consul/data"
        - "-domain=cluster.local"
        - "-server"
        - "-ui"
        - "-disable-host-node-id"
      ports:
      - containerPort: 8500
        name: http
      - containerPort: 8301
        name: serflan
      - containerPort: 8302
        name: serfwan
      - containerPort: 8300
        name: consulserver
      - containerPort: 8600
        name: consuldns
      livenessProbe:
        httpGet:
          path: /
          port: 8500
    lbname: consul-ns-stateful-ilb
  loadbalancers:
  - function: consul-ns
    lbname: consul-ns-lb
    slbEnabled: true
    ports:
      - port: 8500
        targetport: 8500
        lbtype: http
