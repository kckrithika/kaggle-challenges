apiVersion: v1
 
system:
  functions:
  - name: guiapi-db
    # number of instances ("kpods") to deploy and run
    count: 1
    
    # Docker image(s) that make up one instance of the service
    containers:
    - name: guiapi-db
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/anudeept/mgmtapi:maria10.3.11
      command: ["/docker-entrypoint.sh"]
      resources:
        requests:
          memory: 1.5Gi
          cpu: 750m
        limits:
          memory: 1.75Gi
          cpu: 1
      args:
        - "mysqld"
        - "--ignore-db-dir=lost+found"
        - "--character-set-server=utf8mb4"
        - "--collation-server=utf8mb4_bin"
        - "--max_allowed_packet=250M"
        - log.stdout.enabled=true
        - log.stdout.json=false
      # set container environment variables
      env:
      - name: SHELL
        value: "/bin/bash"
      - name: MYSQL_ROOT_PASSWORD
        value: "rootPassword"
      - name: MYSQL_ROOT
        value: "root"
      - name: MYSQL_USER
        value: "ddnuser"
      - name: MYSQL_DATABASE
        value: "ddnprod"
      - name: MYSQL_PASSWORD
        value: "ddnpassword"
      - name: max_allowed_packet
        value: "1073741824"
        
      ports:
      - containerPort: 3310
      livenessProbe:
        exec:
          command: ["mysqladmin", "status", "-h", "127.0.0.1", "-u", "$MYSQL_ROOT", "-p","$MYSQL_ROOT_PASSWORD"]
        initialDelaySeconds: 60
        timeoutSeconds: 10 
      volumeMounts:
      - mountPath: /var/lib/mysql
        name: mgmtdbservice
      # - mountPath: /mysql-secrets/
      #   name: mysql-credentials
        readOnly: true
    volumes:
    - name: mgmtdbservice
      hostPath:
        path: /home/sfdc-guiapi-db/guiapi/data
    - name: mysql-credentials
      k4aSecret:
        secretName: mysql-secrets
  loadbalancers:
  - lbname: guiapi-db-lb
    function: guiapi-db
    nodeExposed: true
    ports:
    - port: 3310
      targetport: 3310