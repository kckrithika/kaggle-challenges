apiVersion: v1

system:
  functions:
  - name: redis-inspector
    count: 1
    volumes:
    - name: redisauthvol
      k4aSecret:
        secretName: csc-redis-auth-0
    - name: client-cert
      maddogCert:
        type: client
    containers:
    - name: redis-inspector
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/wpang/redis-inspector:081418
      volumeMounts:
      - mountPath: /var/secrets/redis
        name: redisauthvol
        readOnly: true
      - mountPath: /certs
        name: client-cert
      livenessProbe:
        exec:
          command:
          - echo
          - always_healthy
      env:
      - name: RINSP_REDIS_HOST
        value: $(REDISLB_SERVICE_HOST)
      - name: RINSP_REDIS_PORT
        value: $(REDISLB_SERVICE_PORT)
      - name: RINSP_COMMANDS_INFO_INTERVAL
        value: 30s
      - name: RINSP_COMMANDS_COMMANDSTATS_INTERVAL
        value: 30s
      - name: RINSP_COMMANDS_KEYSPACE_INTERVAL
        value: 30s
      - name: RINSP_COMMANDS_SLOWLOG_INTERVAL
        value: 30s
      - name: RINSP_AJNA_FLUSHINTERVAL
        value: 60s
      - name: RINSP_AJNA_MTLSENABLED
        value: true
      - name: RINSP_AJNA_CERTPATH
        value: /certs/client/certificates/client.pem
      - name: RINSP_AJNA_KEYPATH
        value: /certs/client/keys/client-key.pem
      - name: RINSP_AJNA_CACERTPATH
        value: /certs/ca.pem
      - name: RINSP_REDIS_AUTHPATH
        value: /var/secrets/redis/auth
      command: ["/bin/sh", "-c"]
      args: ["
      export RINSP_AJNA_FUNNEL_HOST=ajna0-funnel1-1-prd.eng.sfdc.net ;
      export RINSP_AJNA_FUNNEL_PORT=11443 ;
      export RINSP_AJNA_DATACENTER=${KINGDOM} ;
      export RINSP_AJNA_DEVICE=${ESTATE}.${FUNCTION_NAMESPACE}.${FUNCTION}.${FUNCTION_INSTANCE_NAME} ;
      ./redis-inspector
      "]
  - name: redis
    count: 1
    volumes:
      - name: redisauthvol
        k4aSecret:
          secretName: csc-redis-auth-0
    containers:
    - name: redis
      image: tnrp/csc-health/redis-auth:4.0.8-0000008-24e58629
      volumeMounts:
      - mountPath: /var/secrets/redis
        name: redisauthvol
        readOnly: true
      env:
      - name: REDIS_AUTH_PATH
        value: /var/secrets/redis/auth
      ports:
      - containerPort: 6379
      livenessProbe:
        exec:
          command:
          - echo
          - always_healthy
  loadbalancers:
  - lbname: redislb
    function: redis
    nodeExposed: true
    ports:
    - port: 6379
      targetport: 6379


