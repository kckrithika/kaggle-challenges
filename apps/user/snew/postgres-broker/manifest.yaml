apiVersion: v1

system:
  notifications:
    email:
    - snew@salesforce.com

  functions:
  - name: postgres
    count: 1
    type: stateful-set
    containers:
    - name: postgres
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/mgrass/postgres:9.3-sfdc

      env:
      # Set PGDATA to a subdir, since postgres doesn't like being at a mountpoint.
      # See https://github.com/docker-library/docs/pull/277/files
      - name: PGDATA
        value: /var/lib/postgresql/data/pgdata

      volumeMounts:
      - name: datavol
        mountPath: /var/lib/postgresql/data

      ports:
      - containerPort: 5432

      env:
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          value: password
        - name: POSTGRES_DB
          value: postgres

      livenessProbe:
        tcpSocket:
          port: 5432
        failureThreshold: 3
        initialDelaySeconds: 10
        periodSeconds: 60

    lbname: postgres-headless-lb

    # Give containers a bit of time to shut down, as they might be syncing
    # state into the PV on shutdown
    terminationGracePeriodSeconds: 30

    volumeClaimTemplates:
    - name: datavol
      storageClassName: standard
      storageSizeRequest: 10Gi

  - name: broker-app
    count: 1
    type: stateful-set
    containers:
    - name: broker
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/snew/post-broke:1
      ports:
      - containerPort: 9292
      livenessProbe:
        tcpSocket:
          port: 9292
        failureThreshold: 3
        initialDelaySeconds: 60
        periodSeconds: 60

    lbname: broker-headless-lb

    # Give containers a bit of time to shut down, as they might be syncing
    # state into the PV on shutdown
    terminationGracePeriodSeconds: 30


  loadbalancers:
  - lbname: postgres
    function: postgres
    slbEnabled: true
    ports:
      - port: 5432
        targetport: 5432
  - lbname: broker
    function: broker-app
    slbEnabled: true
    ports:
      - port: 9292
        targetport: 9292
        lbtype: tcp
