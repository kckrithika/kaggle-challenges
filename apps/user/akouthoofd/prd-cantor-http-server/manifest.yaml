apiVersion: v1

system:
    notifications:
      email:
        - akouthoofd@salesforce.com
    functions:
    - name: cantor-http-server
      count: 3
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 0
          maxUnavailable: 1
      containers:
      - name: prd-cantor-http-server
        image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/akouthoofd/cantor-http-server:latest
        ports:
        - name: cantor-http
          containerPort: 7020
        livenessProbe:
          exec:
            command:
            - /usr/bin/true
        env:
        - name: SUBDOMAIN
          value: "eng"
        - name: STORAGE_TYPE
          value: "grpc"
        volumeMounts:
        - name: server-cert
          mountPath: /server-certs
      - name: cantor-http-sherpa
        # Use the latest release version from https://git.soma.salesforce.com/servicelibs/sherpa-envoy/releases
        image: sfci/servicelibs/sherpa-envoy:1.0.13
        # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
        ports:
        - name: http2-in
          containerPort: 7012
        - name: http2-tls-in
          containerPort: 7443
        - name: sherpa-adm
          containerPort: 15373
        livenessProbe:
          exec:
            command:
              - ./bin/is-alive
          initialDelaySeconds: 60
          periodSeconds: 5
        readinessProbe:
          exec:
            command:
              - ./bin/is-ready
          initialDelaySeconds: 50
          periodSeconds: 5
        # The cert names should match whatever you choose below in your volumes section.
        # The mount paths match the defaults assumed by sherpa. Changing the paths requires a corresponding manual override in sherpa.
        volumeMounts:
          - name: client-cert
            mountPath: /client-certs
          - name: server-cert
            mountPath: /server-certs
      volumes:
      - name: client-cert
        maddogCert:
          type: client
      - name: server-cert
        maddogCert:
          type: server
    loadbalancers:
    - lbname: cantor-service
      function: cantor-http-server
      slbEnabled: true
      ports:
        - port: 7020
          targetport: 7020
        - port: 7012
          targetport: 7012
        - port: 7443
          targetport: 7443
          lbalgorithm: roundrobin
