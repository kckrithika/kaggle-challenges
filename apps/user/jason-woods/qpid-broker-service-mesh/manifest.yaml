apiVersion: v1

system:
  notifications:
    email:
      - jason.woods@salesforce.com
  functions:
    - name: qpid-broker-service-mesh
      type: stateful-set
      count: 3
      containers:
        - name: qpid-broker-runtime
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/appscale/qpid-broker-runtime:267fdc6.4
          ports:
            - name: amqp-port
              containerPort: 5672
            - name: http-port
              containerPort: 7022
          env:
            - name: HTTP_PORT
              value: 7022
            - name: AMQP_PORT
              value: 5672
          resources:
            limits: { cpu: "24", memory: "20Gi" }
            requests: { cpu: "24", memory: "20Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/qpid
              name: logvol
        - name: beacon
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
          command: ["/bin/sh"]
          args: ["-c", "QPID_HOST=$(hostname -s); java -jar service.jar -endpoint samapp/user-jason-woods/qpid-broker-service-mesh-${QPID_HOST}:POD:7442"]
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                - "/home/scone/is-alive.sh"
            - name: sherpa
            # https://sconelibci.dop.sfdc.net/job/servicelibs/job/sherpa-envoy/job/master/73
            image: sfci/servicelibs/sherpa-envoy:1.0.4
            # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
            ports:
            - containerPort: 15373
              name: sherpa-adm
            - containerPort: 7442
              name: http1-tls-in
            livenessProbe:
              exec:
                command:
                - "./bin/is-alive"
              initialDelaySeconds: 120
              periodSeconds: 5
            readinessProbe:
              exec:
                command:
                - "./bin/is-ready"
              initialDelaySeconds: 110
              periodSeconds: 5
            # Mount volumes with certificates. The paths here match the defaults assumed by sherpa
            volumeMounts:
            - name: sherpaclientcert
              mountPath: /client-certs
            - name: sherpaservercert
              mountPath: /server-certs
      lbname: qpid-lb-jason-woods-service-mesh
      volumes:
        - name: logvol
          hostpath:
            path: /var/log/qpid
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
  loadbalancers:
    - lbname: qpid-lb-jason-woods-service-mesh
      function: qpid-broker
      slbEnabled: true
      nodeExposed: true
      ports:
        - port: 7020
          targetport: 7020
          lbtype: http
        - port: 5672
          targetport: 5672
          lbtype: tcp