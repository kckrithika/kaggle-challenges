apiVersion: v1

system:
  functions:
    - name: deployerbot
      count: 1
      containers:
        - name: phaser
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/hpamukcu/deployerbot:hpamukcu-202002161527
          env:
            - name: GO_PIPELINE_LABEL
              value: 1
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          command: ["/moe/phaser"]
          args:
            - "-gheTokenPath=/secrets/hpam-ghe-pat"
            - "-pgpkeypath=/gpgsecrets/hpam-gpg-key"
            - "-repoBaseDir=/repo"
            - "-upstreamOrgName=sfcd"
            - "-repoName=spinnaker"
            - "-gitURL=https://git.soma.salesforce.com/api/v3/"
            - "-phaseFile=infrasecsecretsfire/vault/phases.j2"
            - "-commitAppend=@tok-secrets"
            - "-branchName=vault-phaser"
            - "-phaseMarkerRegexp=.*{%- macro (.*)Params\\(pipeline\\) -%}.*"
            - "-phaseEndMarkerRegexp=.*{%- endmacro %}.*"
            - "-ignoreLinesRegexp=.*DEPLOYMENT_PHASE.*"
            - "-ignoreLinesRegexp=^\\s*,"
            - "-checkInterval=20m"
          volumeMounts:
            - mountPath: /secrets
              name: phaser-ghe-pat-hpam
              readOnly: true
            - mountPath: /gpgsecrets
              name: phaser-gpg-key-hpam
              readOnly: true
            - mountPath: /repo
              name: repo-base
          livenessProbe:
            exec:
              command: ["ls", "/"]
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 60
      volumes:
        - name: phaser-ghe-pat-hpam
          k4aSecret:
            secretName: phaser-ghe-pat-hpam
        - name: phaser-gpg-key-hpam
          k4aSecret:
            secretName: phaser-gpg-key-hpam
        - name: repo-base
          emptyDir: {}