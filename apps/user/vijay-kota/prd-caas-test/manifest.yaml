apiVersion: v1

system:
  notifications:
    email:
      - vijay.kota@salesforce.com
  functions:
    - name: cs66-app
      count: 1
      containers:
        - name: app
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/vijay-kota/myenvoy:Jul19
          command: ["/usr/bin/python"]
          args: ["/home/sfdc-sherpa/myscripts/myapp.py"]
          ports:
            - name: client-port
              containerPort: 12345
          env:
            - name: HTTP_PORT
              value: 2012
            - name: CLIENT_PORT
              value: 12345
            - name: SFDC_ENVIRONMENT
              value: sam 
          resources:
            limits: { cpu: "8", memory: "16Gi" }
            requests: { cpu: "8", memory: "16Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/qpid
              name: logvol

        - name: sherpa-app
          # https://sconelibci.dop.sfdc.net/job/servicelibs/job/sherpa-envoy/job/master/73
          image: sfci/servicelibs/sherpa-envoy:1.0.7
          # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
          ports:
          - containerPort: 15373
            name: sherpa-adm
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          env:
            - name: SFDC_ENVIRONMENT
              value: sam
          livenessProbe:
            exec:
              command:
              - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
              - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
          # Mount volumes with certificates. The paths here match the defaults assumed by sherpa
          volumeMounts:
          - name: sherpaclientcert
            mountPath: /client-certs
          - name: sherpaservercert
            mountPath: /server-certs
          - name: sherpa-log-volume
            mountPath: /log

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/qpid
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs

    - name: cs66-qpid
      type: stateful-set
      count: 1
      identity:
        serviceName: qpid
        pod: cs66
      containers:
        - name: qpid-broker-runtime
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/vijay-kota/myenvoy:Jul19
          command: ["/usr/bin/python"]
          args: ["/home/sfdc-sherpa/myscripts/myqpid.py"]
          ports:
            - name: amqp-port
              containerPort: 2011
            - name: http-port
              containerPort: 7022
          env:
            - name: AMQP_PORT
              value: 2011
            - name: HTTP_PORT
              value: 2011
            # value: 7022
            - name: QPID_JAVA_HEAPSZ
              value: 8g
            - name: SFDC_ENVIRONMENT
              value: sam 
          resources:
            limits: { cpu: "8", memory: "16Gi" }
            requests: { cpu: "8", memory: "16Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/qpid
              name: logvol

        - name: beacon-qpid
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
          args:
            - -endpoint
            - samapp/$(FUNCTION_NAMESPACE)/$(FUNCTION)-http:DATACENTER_ALLENV:7014
            # samapp/$(FUNCTION_NAMESPACE)/$(FUNCTION)-https:DATACENTER_ALLENV:7442
            - -endpoint
            - qpid/$(FUNCTION_INSTANCE_NAME):POD:2010
            # samapp/$(FUNCTION_NAMESPACE)/$(FUNCTION):DATACENTER_ALLENV:2010
          env:
            - name: SFDC_ENVIRONMENT
              value: sam
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                - "/home/scone/is-alive.sh"
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          volumeMounts:
            - mountPath: /home/scone/logs
              name: beacon-log-volume

        - name: sherpa-qpid
          # https://sconelibci.dop.sfdc.net/job/servicelibs/job/sherpa-envoy/job/master/73
          image: sfci/servicelibs/sherpa-envoy:1.0.7
          # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
          ports:
          - containerPort: 15373
            name: sherpa-adm
          - containerPort: 2010
            name: tcp-in
          - containerPort: 7014
            name: http1-in
          # containerPort: 7442
          # name: http1-tls-in
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          env:
            - name: SFDC_ENVIRONMENT
              value: sam
          livenessProbe:
            exec:
              command:
              - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
              - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
          # Mount volumes with certificates. The paths here match the defaults assumed by sherpa
          volumeMounts:
          - name: sherpaclientcert
            mountPath: /client-certs
          - name: sherpaservercert
            mountPath: /server-certs
          - name: sherpa-log-volume
            mountPath: /log

      lbname: cs66-qpid-lb

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/qpid
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs

    - name: cs66-caas
      count: 1
      identity:
        serviceName: caas
        pod: cs66
      containers:
        - name: caas
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/vijay-kota/myenvoy:Jul19
          resources:
            limits: { memory: "8G" }
            requests: { memory: "8G" }
          command: ["/usr/bin/python"]
          args: ["/home/sfdc-sherpa/myscripts/myqpid.py"]
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 15
            timeoutSeconds: 10
          ports:
          - containerPort: 12028
          env:
           - name: HTTP_PORT
             value: 12028

        - name: beacon-caas
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
          args:
          - -endpoint
          - caas/caas-cluster-1:POD:12027
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                - "/home/scone/is-alive.sh"
          env:
           - name: SFDC_ENVIRONMENT
             value: mesh
           - name: NO_ENV_FOR_RESTART
             value: 1
          resources:
            limits: { memory: "500M" }
            requests: { memory: "500M" }

        - name: sherpa-caas
          image: sfci/servicelibs/sherpa-envoy:1.0.7
          ports:
          - containerPort: 12027
          - containerPort: 15373
          env:
          - name: SFDC_ENVIRONMENT
            value: mesh
          resources:
            limits:
              cpu: "1"
              memory: 1Gi
            requests:
              cpu: "1"
              memory: 1Gi
          volumeMounts:
          - mountPath: /client-certs
            name: tls-client-cert
          - mountPath: /server-certs
            name: tls-server-cert
          livenessProbe:
            exec:
              command:
              - ./bin/is-alive
            initialDelaySeconds: 20
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
              - ./bin/is-ready
            initialDelaySeconds: 15
            periodSeconds: 5
      volumes:
        - name: tls-client-cert
          maddogCert:
            type: client
        - name: tls-server-cert
          maddogCert:
            type: server            

    - name: cs66-caas-pc
      count: 1
      identity:
        serviceName: caas2
        pod: cs66
      containers:
        - name: caas
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/vijay-kota/myenvoy:Jul19
          resources:
            limits: { memory: "8G" }
            requests: { memory: "8G" }
          command: ["/usr/bin/python"]
          args: ["/home/sfdc-sherpa/myscripts/myqpid.py"]
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 15
            timeoutSeconds: 10
          ports:
          - containerPort: 12088
          env:
           - name: HTTP_PORT
             value: 12088

        - name: beacon-caas
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
          args:
          - -endpoint
          - caas/caas-pc:POD:12087
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                - "/home/scone/is-alive.sh"
          env:
           - name: SFDC_ENVIRONMENT
             value: mesh
           - name: NO_ENV_FOR_RESTART
             value: 1
          resources:
            limits: { memory: "500M" }
            requests: { memory: "500M" }

        - name: sherpa-caas
          image: sfci/servicelibs/sherpa-envoy:1.0.7
          ports:
          - containerPort: 12087
          - containerPort: 15373
          env:
          - name: SFDC_ENVIRONMENT
            value: mesh
          resources:
            limits:
              cpu: "1"
              memory: 1Gi
            requests:
              cpu: "1"
              memory: 1Gi
          volumeMounts:
          - mountPath: /client-certs
            name: tls-client-cert
          - mountPath: /server-certs
            name: tls-server-cert
          livenessProbe:
            exec:
              command:
              - ./bin/is-alive
            initialDelaySeconds: 20
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
              - ./bin/is-ready
            initialDelaySeconds: 15
            periodSeconds: 5
      volumes:
        - name: tls-client-cert
          maddogCert:
            type: client
        - name: tls-server-cert
          maddogCert:
            type: server            
