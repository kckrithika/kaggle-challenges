apiVersion: v1

system:
  notifications:
    email:
      - vijay.kota@salesforce.com
  functions:
    - name: cs77-app
      count: 2
      identity:
        serviceName: cronapp
        pod: cs77
      containers:
        - name: app
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/vijay-kota/myenvoy:10Jul19
          command: ["/usr/bin/python"]
          args: ["/home/sfdc-sherpa/myscripts/myapp.py"]
          ports:
            - name: http-port
              containerPort: 7022
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: CLIENT_PORT
              value: 7022
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/app
              name: logvol

        - name: sherpa-app
          # https://sconelibci.dop.sfdc.net/job/servicelibs/job/sherpa-envoy/job/master/73
          image: sfci/servicelibs/sherpa-envoy:1.0.7
          # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
          ports:
          - containerPort: 7014
            name: http1-in
          - containerPort: 15373
            name: sherpa-adm
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: ENVOY_DEBUG_OPTIONS
              value: --log-level trace --log-path /home/sfdc-sherpa/envoy.log
          livenessProbe:
            exec:
              command:
              - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
              - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
          # Mount volumes with certificates. The paths here match the defaults assumed by sherpa
          volumeMounts:
          - name: sherpaclientcert
            mountPath: /client-certs
          - name: sherpaservercert
            mountPath: /server-certs
          - name: sherpa-log-volume
            mountPath: /log

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/app
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs

    - name: cs77-cron
      count: 2
      identity:
        serviceName: cron
        pod: cs77
      containers:
        - name: cron-service
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/vijay-kota/myenvoy:10Jul19
          command: ["/bin/sh"]
          args: ["-c", "export AMQP_PORT=$HTTP_PORT ; /usr/bin/python /home/sfdc-sherpa/myscripts/myqpid.py"]
          ports:
            - name: http-port
              containerPort: 7022
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: HTTP_PORT
              value: 7022
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/cron
              name: logvol

        - name: beacon-cron
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
          command: ["/bin/sh"]
          # BUMP UP cluster# with each deployment for debuggability
          args: ["-c", "export port=$HTTP_PORT ; /usr/bin/java -jar /home/scone/service.jar -endpoint cron/cron-cs77-1:POD:${port}"]
            # -endpoint
            # samapp/$(FUNCTION_NAMESPACE)/$(FUNCTION)-http:DATACENTER_ALLENV:7014
            # samapp/$(FUNCTION_NAMESPACE)/$(FUNCTION)-https:DATACENTER_ALLENV:7442
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: HTTP_PORT
              value: 7014
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                # "/home/scone/is-alive.sh"
                - "/bin/true"
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          volumeMounts:
            - mountPath: /home/scone/logs
              name: beacon-log-volume

        - name: sherpa-cron
          # https://sconelibci.dop.sfdc.net/job/servicelibs/job/sherpa-envoy/job/master/73
          image: sfci/servicelibs/sherpa-envoy:1.0.7
          # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
          ports:
          - containerPort: 7014
            name: http1-in
          - containerPort: 15373
            name: sherpa-adm
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            # name: ENVOY_DEBUG_OPTIONS
            # value: --log-level trace --log-path /home/sfdc-sherpa/envoy.log
          livenessProbe:
            exec:
              command:
              - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
              - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
          # Mount volumes with certificates. The paths here match the defaults assumed by sherpa
          volumeMounts:
          - name: sherpaclientcert
            mountPath: /client-certs
          - name: sherpaservercert
            mountPath: /server-certs
          - name: sherpa-log-volume
            mountPath: /log

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/qpid
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs

    - name: cs77-mc
      count: 1
      identity:
        serviceName: cronmc
        pod: cs77
      containers:
        - name: cron-service
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/vijay-kota/myenvoy:10Jul19
          command: ["/bin/sh"]
          args: ["-c", "export AMQP_PORT=$HTTP_PORT ; /usr/bin/python /home/sfdc-sherpa/myscripts/myqpid.py"]
          ports:
            - name: http-port
              containerPort: 7022
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: HTTP_PORT
              value: 7022
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/web
              name: logvol

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/web
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs

    - name: cs77-sdb
      count: 1
      identity:
        serviceName: cronsdb
        pod: cs77
      containers:
        - name: sdbgo
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/vijay-kota/mysdb:03Oct19
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            # name: PGPORT
            # value: "1521"
          ports:
            - containerPort: 1521
              name: sdb-port
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/sdb
              name: logvol

      volumes:
        - name: logvol
          emptyDir: {}
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs

  loadbalancers:
  - lbname: cronsvc-cs77
    function: cs77-cron
    slbenabled: true
    ports:
      - port: 7014
        targetport: 7014
      - port: 7022
        targetport: 7022
      - port: 15373
        targetport: 15373
  - lbname: cronapp-cs77
    function: cs77-app
    slbenabled: true
    ports:
      - port: 7014
        targetport: 7014
      - port: 7022
        targetport: 7022
      - port: 15373
        targetport: 15373
  - lbname: cronmc-cs77
    function: cs77-mc
    slbenabled: true
    ports:
      - port: 7022
        targetport: 7022
  - lbname: cronsdb-cs77
    function: cs77-sdb
    slbenabled: true
    ports:
      - port: 1521
        targetport: 1521
