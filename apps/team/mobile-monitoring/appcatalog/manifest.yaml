apiVersion: v1

system:
  notifications:
    email:
    - jschroeder@salesforce.com

  functions:
  - name: appcatalog-postgres
    type: stateful-set
    count: 1
    containers:
    - name: postgres
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/mobile/postgres:9.3-sfdc
      env:
      # Set PGDATA to a subdir, since postgres doesn't like being at a mountpoint.
      # See https://github.com/docker-library/docs/pull/277/files
      - name: PGDATA
        value: /var/lib/postgresql/data/pgdata
      volumeMounts:
      - name: appcatalog-datavol
        mountPath: /var/lib/postgresql/data
      ports:
      - containerPort: 5432

      resources:
        requests:
          memory: "1Gi"
          cpu: "1"
        limits:
          memory: "4Gi"
          cpu: "2"

      livenessProbe:
        tcpSocket:
          port: 5432
        failureThreshold: 3
        initialDelaySeconds: 5
        periodSeconds: 60

    lbname: mobile-monitoring-postgres-headless-lb

    # Give containers a bit of time to shut down, as they might be syncing
    # state into the PV on shutdown
    terminationGracePeriodSeconds: 30

    volumeClaimTemplates:
    - name: appcatalog-datavol
      storageClassName: mobile-monitoring-postgres-storage-hdd-pool
      storageSizeRequest: 500Mb

  loadbalancers:
  - lbname: mobile-monitoring-postgres
    function: appcatalog-postgres
    slbEnabled: true
    ports:
      - port: 5432
        targetport: 5432
