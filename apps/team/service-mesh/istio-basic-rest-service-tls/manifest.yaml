apiVersion: v1

system:
  functions:
    - name: istio-basic-rest-service-tls
      count: 1
      labels:
        app: istio-basic-rest-service-tls
        settings_path: istio.-.prd.-.istio-basic-rest-service-tls
        istio_app: test
      annotations:
        sidecar.istio.io/inject: "true"
        routing.mesh.sfdc.net/enabled: "true"
      containers:
        - name: basic-rest-service
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/shaktiprakash-das/basic-rest-service:dev
          env:
            - name: SFDC_ENVIRONMENT
              value: istio
            - name: SERVER_PORT
              value: 7442
            - name: JAVA_OPTS
              value: "-Dscone.service.name=istio-basic-rest-service-tls -Dmanagement.server.port=15372"
            - name: JAVA_HEAP_OPTS
              value: -Xmx64m
          ports:
            - containerPort: 7442
              name: http-svc
            - containerPort: 15372
              name: scone-mgmt
          livenessProbe:
            initialDelaySeconds: 120
            httpGet:
              path: /manage/health
              port: 15372

      # Volumes used by auto-injected istio-proxy.
      volumes:
        - name: tls-client-cert
          maddogCert:
            type: client
        - name: tls-server-cert
          maddogCert:
            type: server

  loadbalancers:
    - lbname: istio-basic-rest-service-tls
      function: istio-basic-rest-service-tls
      labels:
        app: istio-basic-rest-service-tls
        settings_path: istio.-.prd.-.istio-basic-rest-service-tls
      annotations:
        routing.mesh.sfdc.net/enabled: "true"
      ports:
        - lbtype: dsr
          port: 7442
          targetport: 7442
          name: http-svc
