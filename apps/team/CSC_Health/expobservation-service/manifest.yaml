apiVersion: v1

system:
  notifications:
    email:
      - cschealthcp@salesforce.com
  functions:
  - name: expobservation-service
    count: 1
    containers:
    - name: expobservation-service
      image: tnrp/csc-health/observation-service:observation-service-0000025-03ac4b89
      ports:
      - containerPort: 8080
      volumeMounts:
        - mountPath: /var/secrets
          name: secretvol
          readOnly: true
      env:
      - name: OBS_AJNA_ENABLED
        value: true
      - name: OBS_REPORTCOLLECTOR_MTLSENABLED
        value: false
      - name: OBS_REPORTCOLLECTOR_POLLPERIOD
        value: 180s
      - name: OBS_REPORTCOLLECTORALTERNATE_ENABLED
        value: true
      - name: OBS_REPORTCOLLECTORALTERNATE_POLLPERIOD
        value: 180s
      - name: OBS_REPORTCOLLECTORALTERNATE_MTLSENABLED
        value: true
      - name: OBS_REPORTCOLLECTORALTERNATE_CERTPATH
        value: /var/secrets/grok-client.crt.pem
      - name: OBS_REPORTCOLLECTORALTERNATE_KEYPATH
        value: /var/secrets/grok-client.key
      - name: OBS_GROK_CERTPATH
        value: /var/secrets/grok-client.crt.pem
      - name: OBS_GROK_KEYPATH
        value: /var/secrets/grok-client.key
      - name: OBS_HEALTH_PORT
        value: 8080
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 5
      command: ["/bin/sh", "-c"]
      args: ["
        export OBS_AJNA_FUNNELENDPOINT=http://${SFDC_METRICS_SERVICE_HOST}:${SFDC_METRICS_SERVICE_PORT} ;
        export OBS_AJNA_DATACENTER=${KINGDOM} ;
        export OBS_AJNA_DEVICE=${ESTATE}.${FUNCTION_NAMESPACE}.${FUNCTION}.${FUNCTION_INSTANCE_NAME} ;
        export OBS_GROK_ENDPOINT=dead-end ;
        export OBS_REPORTCOLLECTORALTERNATE_ENDPOINT=https://reportcollector-${KINGDOM}.data.sfdc.net:18444 ;
        case ${KINGDOM} in
          prd)
            export OBS_REPORTCOLLECTOR_ENDPOINT=https://ops0-health1-1-${KINGDOM}.eng.sfdc.net:18444
            ;;
          *)
            export OBS_REPORTCOLLECTOR_ENDPOINT=https://ops0-health1-1-${KINGDOM}.ops.sfdc.net:18444
            ;;
        esac ;
        /observationservice
      "]
    volumes:
      - name: secretvol
        secret:
          secretName: csc-health-secret

  loadbalancers:
  - lbname: expobservationservicelb
    function: expobservation-service
    ports:
    - port: 80
      targetport: 8080
