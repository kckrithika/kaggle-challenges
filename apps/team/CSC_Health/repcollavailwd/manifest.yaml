apiVersion: v1

system:
  notifications:
    email:
      - cschealthcp@salesforce.com
  functions:
  - name: repcollavailwd
    count: 1
    containers:
    - name: repcollavailwd
      image: docker-all/dva/report-collector-availability-watchdog:2
      ports:
      - name: liveness
        containerPort: 8089
      resources:
        requests: { cpu: "0.5", memory: "200M" }
      volumeMounts:
      - mountPath: /var/log/report-collector-availability-watchdog
        name: logvol
      - mountPath: /var/lib/report-collector-availability-watchdog/pki
        name: clientcertvol
      env:
      - name: RC_WD_INTERVALMS
        value: 60000
      - name: RC_WD_REPORTCOLLECTOR_PROVIDER_PROTOCOL
        value: https
      - name: RC_WD_REPORTCOLLECTOR_CONSUMER_PROTOCOL
        value: https
      - name: RC_WD_REPORTCOLLECTOR_CONSUMER_TIMEOUTMS
        value: 90000
      - name: RC_WD_VERIFYREPORTISTRUSTED
        value: true
      - name: RC_WD_SSL_VERIFYSERVERIDENTITY
        value: false
      - name: RC_WD_SSL_STRICTSSL
        value: true
      - name: RC_WD_SSL_AUTH_CERT
        value: /var/lib/report-collector-availability-watchdog/pki/client/certificates/client.pem
      - name: RC_WD_SSL_AUTH_KEY
        value: /var/lib/report-collector-availability-watchdog/pki/client/keys/client-key.pem
      - name: RC_WD_SSL_AUTH_CA
        value: /var/lib/report-collector-availability-watchdog/pki/ca.pem
      - name: RC_WD_LOGGER_LOGDIR
        value: /var/log/report-collector-availability-watchdog
      - name: RC_WD_LOGGER_LEVEL
        value: debug
      - name: RC_WD_LIVENESS_FRESHNESSMS
        value: 130000
      - name: RC_WD_AJNA_SHOULDPUBLISHPRODUCTIONMETRICS
        value: false
      - name: RC_WD_AJNA_STRICTSSL
        value: true
      - name: RC_WD_AJNA_AUTH_CERT
        value: /var/lib/report-collector-availability-watchdog/pki/client/certificates/client.pem
      - name: RC_WD_AJNA_AUTH_KEY
        value: /var/lib/report-collector-availability-watchdog/pki/client/keys/client-key.pem
      - name: RC_WD_AJNA_AUTH_CA
        value: /var/lib/report-collector-availability-watchdog/pki/ca.pem
      command: ["/bin/sh", "-c"]
      args: ["
      export RC_WD_AJNA_FUNNELVIP=http://${SFDC_METRICS_SERVICE_HOST}:${SFDC_METRICS_SERVICE_PORT} ;
      export RC_WD_AJNA_DATACENTER=${KINGDOM} ;
      export RC_WD_AJNA_DEVICE=${ESTATE}.${FUNCTION_NAMESPACE}.${FUNCTION}.${FUNCTION_INSTANCE_NAME} ;
      export RC_WD_REPORTCOLLECTOR_PROVIDER_HOST=$(REPORTCOLLECTORHALB_SERVICE_HOST) ;
      export RC_WD_REPORTCOLLECTOR_PROVIDER_PORT=$(REPORTCOLLECTORHALB_SERVICE_PORT_TCP8443) ;
      export RC_WD_REPORTCOLLECTOR_CONSUMER_HOST=$(REPORTCOLLECTORHALB_SERVICE_HOST) ;
      export RC_WD_REPORTCOLLECTOR_CONSUMER_PORT=$(REPORTCOLLECTORHALB_SERVICE_PORT_TCP8444) ;

      case ${KINGDOM} in
        prd|phx|dfw|frf|par|ukb|iad|ord)
          export RC_WD_REPORTCOLLECTOR_PROVIDER_HOST=$(REPORTCOLLECTORLB_SERVICE_HOST) ;
          export RC_WD_REPORTCOLLECTOR_PROVIDER_PORT=$(REPORTCOLLECTORLB_SERVICE_PORT_TCP8443) ;
          export RC_WD_REPORTCOLLECTOR_CONSUMER_HOST=$(TEMPSTORELB_SERVICE_HOST) ;
          export RC_WD_REPORTCOLLECTOR_CONSUMER_PORT=$(TEMPSTORELB_SERVICE_PORT) ;
          ;;
        *)
      esac;

      node --harmony ${APP_DIR}/lib/watchdog.js ;
      "]
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8089
        initialDelaySeconds: 5
        periodSeconds: 5
    volumes:
    - name: logvol
      hostPath:
        path: /var/log/report-collector-availability-watchdog
    - name: clientcertvol
      maddogCert:
        type: client
