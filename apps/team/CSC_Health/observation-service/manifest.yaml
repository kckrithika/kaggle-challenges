apiVersion: v1

system:
  notifications:
    email:
      - cschealthcp@salesforce.com
  functions:
  - name: observation-service
    count: 1
    containers:
    - name: observation-service-logrotator
      image: docker-all/dva/csc-health/observation-service:4
      volumeMounts:
        - mountPath: /home/sfdc-csc-health/observation-service
          name: logvol
      livenessProbe:
        exec:
          command:
          - echo
          - always_healthy
        initialDelaySeconds: 5
        periodSeconds: 30
      command: ["/bin/sh", "-c"]
      args: ['
        printf "compress\n
        /home/sfdc-csc-health/observation-service/observation-service.log {\n
          rotate 30\n
          daily\n
          copytruncate\n
          delaycompress\n
        }" > /tmp/observation-service-logrotate.conf;
        status_file=/home/sfdc-csc-health/observation-service/observation-service-logrotate.status;
        cmd="/usr/sbin/logrotate -v -s ${status_file} /tmp/observation-service-logrotate.conf";
        while true;
        do
          printf "\n`date`\n\n";
          $cmd;
          sleep 21600;
        done
      ']
    - name: observation-service
      image: docker-all/dva/csc-health/observation-service:4
      ports:
      - containerPort: 8080
      volumeMounts:
        - mountPath: /certs
          name: client-cert
        - mountPath: /home/sfdc-csc-health/observation-service
          name: logvol
      env:
      - name: OBS_AJNA_ENABLED
        value: true
      - name: OBS_AJNA_CERTPATH
        value: /certs/client/certificates/client.pem
      - name: OBS_AJNA_KEYPATH
        value: /certs/client/keys/client-key.pem
      - name: OBS_AJNA_CACERTPATH
        value: /certs/ca.pem
      - name: OBS_REPORTCOLLECTOR_WHITELIST
        value: netmgt.nhal_client,netmgt.sandman,sandman
      - name: OBS_REPORTCOLLECTOR_WHITELISTUNTRUSTED
        value: infrastructure-observer.system
      - name: OBS_REPORTCOLLECTOR_CERTPATH
        value: /certs/client/certificates/client.pem
      - name: OBS_REPORTCOLLECTOR_KEYPATH
        value: /certs/client/keys/client-key.pem
      - name: OBS_REPORTCOLLECTOR_CACERTPATH
        value: /certs/ca.pem
      - name: OBS_GROK_CERTPATH
        value: /certs/client/certificates/client.pem
      - name: OBS_GROK_KEYPATH
        value: /certs/client/keys/client-key.pem
      - name: OBS_GROK_CACERTPATH
        value: /certs/ca.pem
      - name: OBS_HEALTH_PORT
        value: 8080
      - name: OBS_LOG_FILE
        value: /home/sfdc-csc-health/observation-service/observation-service.log
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 5
      command: ["/bin/sh", "-c"]
      args: ["
        export OBS_AJNA_FUNNELENDPOINT=http://${SFDC_METRICS_SERVICE_HOST}:${SFDC_METRICS_SERVICE_PORT} ;
        export OBS_AJNA_DATACENTER=${KINGDOM} ;
        export OBS_AJNA_DEVICE=${ESTATE}.${FUNCTION_NAMESPACE}.${FUNCTION}.${FUNCTION_INSTANCE_NAME} ;
        export OBS_GROK_ENDPOINT=https://ops0-grok1-0-${KINGDOM}.data.sfdc.net ;
        export OBS_REPORTCOLLECTOR_ENDPOINT=https://reportcollector-${KINGDOM}.data.sfdc.net:18444 ;

        /observationservice
      "]
    volumes:
      - name: client-cert
        maddogCert:
          type: client
      - name: logvol
        hostPath:
          path: /home/sfdc-csc-health/observation-service

  loadbalancers:
  - lbname: observationservicelb
    function: observation-service
    ports:
    - port: 80
      targetport: 8080
