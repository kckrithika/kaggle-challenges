apiVersion: v1

system:
  functions:
  - name: expmaddog-repcollavailwd
    count: 1
    containers:
    - name: expmaddog-repcollavailwd
      image: tnrp/csc-health/report-collector-availability-watchdog:2.8.0-0000094-1c59fd7d
      ports:
      - name: liveness
        containerPort: 8089
      resources:
        requests: { cpu: "0.5", memory: "200M" }
      volumeMounts:
      - mountPath: /var/lib/report-collector-availability-watchdog/certificates
        name: clientcertvol
      env:
      - name: REPORT_COLLECTOR_HOST
        value: $(EXPREPORTCOLLECTORHALB_SERVICE_HOST)
      - name: REPORT_COLLECTOR_PROVIDER_PORT
        value: $(EXPREPORTCOLLECTORHALB_SERVICE_PORT_TCP28445)
      - name: REPORT_COLLECTOR_CONSUMER_PORT
        value: $(EXPREPORTCOLLECTORHALB_SERVICE_PORT_TCP28446)
      - name: REPORT_COLLECTOR_PROTOCOL
        value: https
      - name: DEBUG_ENABLED
        value: true
      - name: HTTP_OPTIONS_STRICTSSL
        value: true
      - name: HTTP_OPTIONS_VERIFYSERVERIDENTITY
        value: false
      - name: HTTP_OPTIONS_PATHTOCACERTIFICATE
        value: /var/lib/report-collector-availability-watchdog/certificates/ca.pem
      - name: HTTP_OPTIONS_PATHTOCLIENTCERTIFICATE
        value: /var/lib/report-collector-availability-watchdog/certificates/client/certificates/client.pem
      - name: HTTP_OPTIONS_PATHTOCLIENTCERTIFICATEKEY
        value: /var/lib/report-collector-availability-watchdog/certificates/client/keys/client-key.pem
      - name: VERIFY_REPORT_IS_TRUSTED
        value: true
      command: ["/bin/sh", "-c"]
      args: ["
      export FUNNEL_VIP=http://${SFDC_METRICS_SERVICE_HOST}:${SFDC_METRICS_SERVICE_PORT} ;
      export DEVICE=${ESTATE}.${FUNCTION_NAMESPACE}.${FUNCTION}.${FUNCTION_INSTANCE_NAME} ;
      export DATACENTER=${KINGDOM} ;
      export SHOULD_PUBLISH_PROD_METRICS=false ;
      node --harmony ${APP_DIR}/lib/watchdog.js
      "]
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8089
        initialDelaySeconds: 5
        periodSeconds: 5
    volumes:
    - name: clientcertvol
      maddogCert:
        type: client
