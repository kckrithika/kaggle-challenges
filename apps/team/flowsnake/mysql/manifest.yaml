apiVersion: v1

# Based on https://kubernetes.io/docs/tasks/run-application/run-single-instance-stateful-application/
# and also on https://git.soma.salesforce.com/sam/manifests/blob/master/apps/user/hari-udhayakumar/postgres-pv/manifest.yaml

system:
  notifications:
    email:
    - khogeland@salesforce.com

  functions:
  - name: mysql
    count: 1
    type: stateful-set
    containers:
    - name: mysql
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/d.smith/mysql:20180123_135035.df4fafc7.dirty.duncsmith-ltm

      # TODO: Use a k4a secret
      env:
      - name: MYSQL_ROOT_PASSWORD
        value: pass
      
      volumeMounts:
      - mountPath: /var/lib/mysql
        name: mysql-persistent-storage-rev-three
      - mountPath: /certs
        name: certs
      
      ports:
      - containerPort: 3306
        name: mysql

      livenessProbe:
        tcpSocket:
          port: 3306
        initialDelaySeconds: 1500
        periodSeconds: 100
        failureThreshold: 1000
        
    volumes:
    - name: certs
      maddogCert:
        type: server

    lbname: mysql-stateful-lb

    # Give containers a bit of time to shut down, as they might be syncing 
    # state into the PV on shutdown
    terminationGracePeriodSeconds: 20

    volumeClaimTemplates:
    - name: mysql-persistent-storage-rev-three
      storageClassName: flowsnake-sql-hdd-pool
      storageSizeRequest: 100Gi

  loadbalancers:
  - lbname: mysql
    function: mysql
    slbEnabled: true
    ports:
      - port: 3306
        targetport: 3306
        lbtype: dsr
