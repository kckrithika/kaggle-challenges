apiVersion: v1
system:
  functions:
  - name: consul
    count: 3
    type: stateful-set
    containers:
    - name: consul
      image: ops0-artifactrepo2-0-xrd.slb.sfdc.net/docker-devmvp/ameesala/consul-ts:142-20190212-3
      args:
        - "agent"
        - "-advertise=$(FUNCTION_INSTANCE_IP)"
        - "-bind=0.0.0.0"
        - "-bootstrap-expect=3"
        - "-retry-join=consul-0.consul-stateful-ilb.$(FUNCTION_NAMESPACE).svc"
        - "-retry-join=consul-1.consul-stateful-ilb.$(FUNCTION_NAMESPACE).svc"
        - "-retry-join=consul-2.consul-stateful-ilb.$(FUNCTION_NAMESPACE).svc"
        - "-client=$(FUNCTION_INSTANCE_IP)"
        - "-datacenter=dc1"
        - "-data-dir=/consul/data"
        - "-domain=cluster.local"
        - "-server"
        - "-ui"
        - "-disable-host-node-id"
      ports:
      - containerPort: 8500
        name: http
      - containerPort: 8301
        name: serflan
      - containerPort: 8302
        name: serfwan
      - containerPort: 8300
        name: consulserver
      - containerPort: 8600
        name: consuldns
      livenessProbe:
        httpGet:
          path: /
          port: 8500
    lbname: consul-stateful-ilb
  loadbalancers:
  - lbname: consul-lb
    function: consul
    slbEnabled: true
    ports:
      - port: 8500
        targetport: 8500
      - port: 8301
        targetport: 8301
      - port: 8302
        targetport: 8302
      - port: 8300
        targetport: 8300
      - port: 8600
        targetport: 8600

