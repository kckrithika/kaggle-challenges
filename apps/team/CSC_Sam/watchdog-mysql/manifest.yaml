apiVersion: v1

# Based on https://kubernetes.io/docs/tasks/run-application/run-single-instance-stateful-application/
# and also on https://git.soma.salesforce.com/sam/manifests/blob/master/apps/user/hari-udhayakumar/postgres-pv/manifest.yaml

system:
  notifications:
    email:
    - a.mitra@salesforce.com

  functions:
  - name: watchdog-mysql
    count: 1
    type: stateful-set
    containers:
    - name: watchdog-mysql
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/d.smith/mysql:20180123_135035.df4fafc7.dirty.duncsmith-ltm

      env:
      - name: MYSQL_ROOT_PASSWORD
        value: test@pass
        #/secrets/mysql_watchdog-password
      - name: MYSQL_TCP_PORT
        value: 3309
        
      volumeMounts:
      - mountPath: /var/lib/watchdog-mysql
        name: watchdog-mysql-persistent-storage-rev-three
      - mountPath: /certs
        name: certs
      - mountPath: /secrets
        name: watchdog-mysqlsecret
        readOnly: true
      
      ports:
      - containerPort: 3309
        name: watchdog-mysql

      livenessProbe:
        tcpSocket:
          port: 3309
        initialDelaySeconds: 1500
        periodSeconds: 100
        failureThreshold: 1000
        
    volumes:
    - name: certs
      maddogCert:
        type: server
        lbname: watchdog-mysql-stateful-lb
    - name: watchdog-mysqlsecret
      k4aSecret:
        secretName: watchdogmysql

    # Give containers a bit of time to shut down, as they might be syncing 
    # state into the PV on shutdown
    terminationGracePeriodSeconds: 20

    volumeClaimTemplates:
    - name: watchdog-mysql-persistent-storage-rev-three
      storageClassName: mysql-hdd-pool
      storageSizeRequest: 100Gi

  loadbalancers:
  - lbname: watchdog-mysql-stateful-lb
    function: watchdog-mysql
    slbEnabled: true
    lbtype: dsr
    ports:
      - port: 3309
        targetport: 3309