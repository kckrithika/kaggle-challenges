
#
# Generated manifest
# DO NOT MODIFY - See https://git.soma.salesforce.com/insights/moana-release
#
apiVersion: v1
system:
  functions:
  - containers:
    - image: ops0-artifactrepo2-0-prd.data.sfdc.net/sfci/insights/moanaengine:release-20200128.34-55e9e47
      livenessProbe:
        exec:
          command: [ls]
        initialDelaySeconds: 5
      name: moana-engine
    count: 0
    name: moana-engine-release
  - containers:
    - image: ops0-artifactrepo2-0-prd.data.sfdc.net/sfci/insights/moanaengine:beta-20191129.2-c8731b7
      livenessProbe:
        exec:
          command: [ls]
        initialDelaySeconds: 5
      name: moana-engine-beta
    count: 0
    name: moana-engine-beta-release
  - containers:
    - env:
      - {name: MANAGEMENT_SERVER_PORT, value: '15372'}
      - {name: LOGGING_JSON_STDOUT_LEVEL, value: ALL}
      - {name: LOGGING_STDERR_LEVEL, value: ALL}
      - {name: TEST_POD, value: moana-driver-release}
      - {name: PKI_TRUSTSTORE_DIR, value: /home/scone/client-certs}
      - {name: PKI_KEYSTORE_DIR, value: /home/scone/client-certs/client}
      - {name: JAVA_OPTS, value: '-server -XX:MaxMetaspaceSize=256m -Xmx1024m -Xms1024m'}
      - {name: TESTRECIPE_MAESTROPINGTEST, value: 'true'}
      - {name: DEPLOYMENT_ID, value: prd-release}
      - {name: SFDC_ENVIRONMENT, value: stm}
      - {name: TESTINTERACTIVE_ENABLED, value: 'true'}
      - {name: GRPC_HOST, value: jobcontroller-release.wave-elt.localhost.mesh.force.com}
      - {name: GRPC_PORT, value: '5443'}
      - {name: HANDLED_PODS_PATTERN, value: stmfa\..*|moana-driver-master}
      - {name: HANDLED_PODS_INVERT_MATCH, value: 'true'}
      image: sfci/insights/moana-driver:release-20200128.39-ee5cda6
      livenessProbe:
        httpGet: {path: /manage/health, port: 15372}
        initialDelaySeconds: 30
        periodSeconds: 60
        timeoutSeconds: 30
      name: moana-driver
      ports:
      - {containerPort: 8080, name: http}
      - {containerPort: 15372, name: mgmt}
      resources:
        limits: {cpu: 2, memory: 2G}
        requests: {cpu: 1, memory: 2G}
      volumeMounts:
      - {mountPath: /home/scone/client-certs, name: tls-client-certs}
    - image: sfci/servicelibs/sherpa-envoy:1.0.13
      livenessProbe:
        exec:
          command: [./bin/is-alive]
        initialDelaySeconds: 60
        periodSeconds: 5
      name: sherpa
      ports:
      - {containerPort: 7443, name: http2-tls-in}
      - {containerPort: 15373, name: sherpa-adm}
      readinessProbe:
        exec:
          command: [./bin/is-ready]
        initialDelaySeconds: 50
        periodSeconds: 5
      volumeMounts:
      - {mountPath: /client-certs, name: tls-client-certs}
    count: 3
    hostnetwork: false
    identity: {serviceName: moana-driver}
    name: moana-driver-release
    volumes:
    - maddogCert: {type: server}
      name: tls-server-certs
    - maddogCert: {type: client}
      name: tls-client-certs
  - containers:
    - env:
      - {name: INTERACTIVE_SESSION_PROXY, value: 'true'}
      - {name: READYPOOL_SIZE, value: '3'}
      - {name: MANAGEMENT_SERVER_PORT, value: '15372'}
      - {name: LOGGING_JSON_STDOUT_LEVEL, value: ALL}
      - {name: LOGGING_STDERR_LEVEL, value: ALL}
      - {name: MOANA_SPARK_ENGINE_IMAGE, value: 'ops0-artifactrepo2-0-prd.data.sfdc.net/sfci/insights/moanaengine:release-20200128.34-55e9e47'}
      - {name: MOANA_SPARK_ENGINE_BETA_IMAGE, value: 'ops0-artifactrepo2-0-prd.data.sfdc.net/sfci/insights/moanaengine:beta-20191129.2-c8731b7'}
      - {name: KAFKA_GROUP_ID, value: moana-jobcontroller-release}
      - {name: DEPLOYMENT_ID, value: prd-release}
      - {name: JAVA_OPTS, value: '-server -XX:MaxMetaspaceSize=512m -Xmx2048m -Xms2048m'}
      - {name: SIZING_MEMORY_OVERHEAD, value: '1024'}
      - {name: K8S_CPU_LIMIT_APPLY, value: 'false'}
      - {name: STARTUP_JOB_ENABLED, value: 'false'}
      - {name: SFDC_ENVIRONMENT, value: stm}
      - {name: HANDLED_PODS_PATTERN, value: stmfa\..*|moana-driver-master}
      - {name: HANDLED_PODS_INVERT_MATCH, value: 'true'}
      image: sfci/insights/jobcontroller:release-20200204.43-2740c75
      livenessProbe:
        httpGet: {path: /manage/health, port: 15372}
        initialDelaySeconds: 90
        periodSeconds: 60
        timeoutSeconds: 30
      name: jobcontroller
      ports:
      - {containerPort: 15372, name: mgmt}
      resources:
        limits: {cpu: 2, memory: 4G}
        requests: {cpu: 2, memory: 4G}
      volumeMounts:
      - {mountPath: /home/datapool/logs, name: logvol}
      - {mountPath: /home/datapool/client-certs, name: tls-client-certs}
    - image: sfci/servicelibs/sherpa-envoy:1.0.13
      livenessProbe:
        exec:
          command: [./bin/is-alive]
        initialDelaySeconds: 60
        periodSeconds: 5
      name: sherpa
      ports:
      - {containerPort: 7443, name: http2-tls-in}
      - {containerPort: 15373, name: sherpa-adm}
      readinessProbe:
        exec:
          command: [./bin/is-ready]
        initialDelaySeconds: 50
        periodSeconds: 5
      volumeMounts:
      - {mountPath: /client-certs, name: tls-client-certs}
      - {mountPath: /server-certs, name: tls-server-certs}
    - args: [-endpoint, '$(FUNCTION_NAMESPACE)/$(FUNCTION):DATACENTER_ALLENV:HTTP2_TLS']
      image: sfci/services/sfdc-bazel/disco/beacon:d7f1640
      livenessProbe:
        exec:
          command: [/opt/beacon/is-alive.sh]
        initialDelaySeconds: 5
      name: beacon
    count: 3
    hostnetwork: false
    identity: {serviceName: jobcontroller-release}
    name: jobcontroller-release
    volumes:
    - hostPath: {path: /data/sam/wave/log/datapool}
      name: logvol
    - hostPath: {path: /home/sfdc-sherpa/logs}
      name: sherpa-log-volume
    - maddogCert: {type: server}
      name: tls-server-certs
    - maddogCert: {type: client}
      name: tls-client-certs
  loadbalancers:
  - function: moana-driver-release
    lbname: moana-driver-release
    nodeExposed: true
    ports:
    - {lbalgorithm: roundrobin, lbtype: http, port: 8082, sticky: 0, targetport: 8080}
    slbEnabled: true
  - annotations: {slb.sfdc.net/cnames: '[{"cname": "moana-driver-release-prd.slb.sfdc.net"}]'}
    function: moana-driver-release
    lbname: moana-driver-release-tls
    nodeExposed: true
    ports:
    - {lbalgorithm: roundrobin, lbtype: http, port: 8092, sticky: 0, targetport: 8080,
      tls: true}
    slbEnabled: true
  - function: jobcontroller-release
    lbname: jobcontroller-release
    ports:
    - {lbtype: dsr, name: grpc-in, port: 7443, targetport: 7443}
  notifications:
    email: [moanaserviceseng@salesforce.com]
