apiVersion: v1

system:
  functions:
    - name: moana-mock-maestro
      volumes:
      - maddogCert: {type: server}
        name: tls-server-certs
      - maddogCert: {type: client}
        name: tls-client-certs
      count: 1
      containers:
        - image: sfci/servicelibs/sherpa-envoy:1.0.13
          livenessProbe:
            exec:
              command: [./bin/is-alive]
            initialDelaySeconds: 60
            periodSeconds: 5
          name: sherpa
          ports:
            - {containerPort: 7442, name: http1-tls-in}
          readinessProbe:
            exec:
              command: [./bin/is-ready]
            initialDelaySeconds: 50
            periodSeconds: 5
          volumeMounts:
            - {mountPath: /client-certs, name: tls-client-certs}
            - {mountPath: /server-certs, name: tls-server-certs}

        - name: mock-maestro
          resources:
            limits: {cpu: 16, memory: 4G}
            requests: {cpu: 4, memory: 4G}
          env:
          - {name: JAVA_OPTS, value: '-server -XX:MaxMetaspaceSize=512m -Xmx2048m -Xms2048m'}
          - {name: FILE_MANAGER_UNCOMPRESSED, value: '0'}
          - {name: SERVER_PORT, value: '7022'}
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/insights/mock-maestro-gateway:master-21-f923e87
          ports:
            - containerPort: 15372
              name: manage
            - containerPort: 7022
              name: http
          livenessProbe:
            httpGet: {path: /manage/health, port: 15372}
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 30

  loadbalancers:
    - lbname: moana-mock-maestro
      function: moana-mock-maestro
      slbEnabled: true
      nodeExposed: true
      ports:
        - port: 8001
          targetport: 7022
        - port: 8011
          lbtype: http
          targetport: 7022
          tls: true
