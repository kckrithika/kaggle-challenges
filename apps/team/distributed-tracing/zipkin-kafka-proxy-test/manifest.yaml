apiVersion: v1

system:
    notifications:
        email:
        - afalko@salesforce.com

    functions:
    - name: zipkin-kafka-proxy-test
      count: 1
      strategy:
          type: RollingUpdate
          rollingUpdate:
              maxSurge: 0
              maxUnavailable: 1
      volumes:
        - name: tls-client-cert
          maddogCert:
              type: client
      containers:
      - name: kafka-test
        image: docker-all/dva/dva-kafka:jenkins-monitoring-dva-kafka-afalko-zipkin-sam-test-2-itest
        command: ["/bin/sleep"]
        args: ["inf"]
        livenessProbe:
            exec:
                command:
                - /bin/true
            initialDelaySeconds: 5
            periodSeconds: 5
        volumeMounts:
            - name: tls-client-cert
              mountPath: /client-certs
      - name: zipkin-kafka-proxy-test
        image: docker-all/dva/zipkin-kafka-proxy:jenkins-monitoring-zipkin-kafka-proxy-test-producer-4-itest
        env:
        - name: ZIPKIN_KAFKA_PROXY_HOST
          value: zipkin-kafka-proxy
        - name: KAFKA_BOOTSTRAP_SERVERS
          value: ajna0-broker1-0-prd.data.sfdc.net:9093
        - name: KAFKA_TOPIC
          value: sfdc.prod.distributed-tracing.zipkin-kafka-proxy-test__prd.ajna_local__tracing
        ports: 
        - containerPort: 9411
          name: proxy-in
        livenessProbe:
            exec:
                # TODO: Check if process is running?
                command: 
                - /bin/true
            initialDelaySeconds: 5
            periodSeconds: 5
        volumeMounts:
        - mountPath: /etc/pki_service/zipkin-kafka-proxy
          name: client-certs
      - name: sherpa
        image: sfci/servicelibs/sherpa:2.0.25
        args: ["--zipkin-rate", "0.0"]
        args: ["--http1-origin", "localhost:9411"]
        env:
        - name: SFDC_ENVIRONMENT
          value: "sam"
        resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
        ports:
        - containerPort: 7014
          hostPort: 7014
          name: sherpa-http1-in
        - containerPort: 15373
          name: sherpa-adm
        livenessProbe:
            exec:
                command:
                - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
        readinessProbe:
            exec:
                command:
                - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
      - name: beacon
        image: sfci/servicelibs/beacon:853c4db9f14805018be6f5e7607ffe65b5648822
        env:
        - name: SFDC_ENVIRONMENT
          value: mesh
        args:
        - -endpoint
        - zipkin:DATACENTER_ALLENV:7014
        livenessProbe:
            initialDelaySeconds: 5
            exec:
                command:
                - "/home/scone/is-alive.sh"
