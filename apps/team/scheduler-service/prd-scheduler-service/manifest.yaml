apiVersion: v1

system:
  notifications:
    email:
      - rakella@salesforce.com
  functions:
    - name: cs101-sdb
      count: 1
      identity:
        serviceName: sdb
        pod: cs101
      containers:
        - name: sdbgo
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/rakella/scheduler-db:20feb2020
          env:
          - name: SFDC_ENVIRONMENT
            value: mesh
          ports:
          # expose sdb port outside the container
          - containerPort: 1521
            name: sdb-port
          livenessProbe:
               exec:
                 command: ["/bin/true"]
               initialDelaySeconds: 10
               timeoutSeconds: 10
               periodSeconds: 60
      volumes:
        - name: sdblogs
          emptyDir: {}

    - name: cs101-cron
      count: 2
      identity:
        serviceName: scheduler-service
        pod: cs101
      containers:
        - name: cronsvc
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/rakella/scheduler-service:24feb20-1
          ports:
            - name: grpc-port
              containerPort: 7020
            - name: scone-port
              containerPort: 15374
          command: ["./launcher.sh"]
          args:
            - --scheduler.database.url=jdbc:postgresql://cs101-sdb-lb.scheduler-service.prd-sam.prd.slb.sfdc.net:1521/crondb
            - --logging.level.root=INFO
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
          #esources:
          # limits: { cpu: "1", memory: "1Gi" }
          # requests: { cpu: "1", memory: "1Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/cron
              name: logvol

        - name: beacon
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/servicemesh/beacon:1.0.0
          args:
            - -endpoint
            - samapp/$(FUNCTION_NAMESPACE)/scheduler-service-cs101:POD:7012
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                # "/home/scone/is-alive.sh"
                - "/bin/true"
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          volumeMounts:
            - mountPath: /home/scone/logs
              name: beacon-log-volume

        - name: sherpa
          # https://sconelibci.dop.sfdc.net/job/servicelibs/job/sherpa-envoy/job/master/73
          image: sfci/servicelibs/sherpa-envoy:1.0.7
          # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
          ports:
          - containerPort: 7012
            name: http2-in
          - containerPort: 15373
            name: sherpa-adm
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: ENVOY_DEBUG_OPTIONS
              value: --log-level trace --log-path /home/sfdc-sherpa/envoy.log
          livenessProbe:
            exec:
              command:
              - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
              - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
          # Mount volumes with certificates. The paths here match the defaults assumed by sherpa
          volumeMounts:
          - name: sherpaclientcert
            mountPath: /client-certs
          - name: sherpaservercert
            mountPath: /server-certs
          - name: sherpa-log-volume
            mountPath: /log

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/app
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
        - name: beacon-log-volume
          hostPath:
            path: /home/sfdc-beacon/logs

    - name: cs101-jds
      count: 1
      identity:
        serviceName: scheduler-jds
        pod: cs101
      containers:
        - name: jds
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/rakella/scheduler-jds:23feb20
          ports:
            - name: scone-port
              containerPort: 15376
          command: ["./launcher.sh"]
          args:
            - --scheduler.database.url=jdbc:postgresql://cs101-sdb-lb.scheduler-service.prd-sam.prd.slb.sfdc.net:1521/crondb
            - --logging.level.root=INFO
            - --scheduler.jds.interval=3000
            - --scheduler.jds.batchsize=200
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/app
              name: logvol
      volumes:
        - name: logvol
          hostpath:
            path: /var/log/jds

    - name: cs101-exec
      count: 4
      identity:
        serviceName: executor-service
        pod: cs101
      containers:
        - name: cronexec
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/rakella/executor-service:23feb20
          ports:
            - name: grpc-port
              containerPort: 9020
            - name: scone-port
              containerPort: 15474
          command: ["./launcher.sh"]
          args:
            - --scheduler.service.hostname=cs101-cron-lb.scheduler-service.prd-sam.prd.slb.sfdc.net
            - --scheduler.service.port=7012
            - --scheduler.executor.interval=3000
            - --logging.level.com.salesforce.scheduler.executor=INFO
            - --scheduler.executor.executorThreadPoolSize=60
            - --scheduler.executor.batchsize=50
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/cronexec
              name: logvol

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/cronexec
        - name: sherpaclientcert
          maddogCert:
            type: client
        - name: sherpaservercert
          maddogCert:
            type: server
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs

    - name: cs101-ui
      count: 1
      identity:
        serviceName: scheduler-ui
        pod: cs101
      containers:
        - name: cronui
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/rakella/scheduler-ui:20feb20
          ports:
            - name: http-port
              containerPort: 7022
            - name: scone-port
              containerPort: 15372
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
            - name: DEMO_SVC
              value: cs101-cron-lb.scheduler-service.prd-sam.prd.slb.sfdc.net:7012
            - name: DEMO_DATA
              value: DemoClient_50,http://cs101-demo-lb.scheduler-service.prd-sam.prd.slb.sfdc.net:9090/jobs/DemoClient_50,*/50 * * * * ?,SYSTEM_ORG
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/cronui
              name: logvol

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/cronui

    - name: cs101-demo
      count: 1
      identity:
        serviceName: scheduler-demo-client
        pod: cs101
      containers:
        - name: crondemo
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/rakella/scheduler-demo-client:23feb20
          ports:
            - name: http-port
              containerPort: 9090
          command: ["./launcher.sh"]
          args:
            - --scheduler.service.hostname=cs101-cron-lb.scheduler-service.prd-sam.prd.slb.sfdc.net
            - --scheduler.service.port=7012
            - --scheduler.client.hostname=cs101-demo-lb.scheduler-service.prd-sam.prd.slb.sfdc.net              
          env:
            - name: SFDC_ENVIRONMENT
              value: mesh
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          livenessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
            periodSeconds: 60
          readinessProbe:
            exec:
              command: ["/bin/true"]
            initialDelaySeconds: 10
            timeoutSeconds: 10
          volumeMounts:
            - mountPath: /var/log/crondemo
              name: logvol

      volumes:
        - name: logvol
          hostpath:
            path: /var/log/crondemo

  loadbalancers:
  - lbname: cs101-sdb-lb
    function: cs101-sdb
    slbenabled: true
    ports:
      - port: 1521
        targetport: 1521
  - lbname: cs101-demo-lb
    function: cs101-demo
    slbenabled: true
    ports:
      - port: 9090
        targetport: 9090
  - lbname: cs101-jds-lb
    function: cs101-jds
    slbenabled: true
    ports:
      # Following are only for debugging
      - port: 15376
        targetport: 15376     
  - lbname: cs101-exec-lb
    function: cs101-exec
    slbenabled: true
    ports:
      - port: 9020
        targetport: 9020
      # Following are only for debugging
      - port: 15474
        targetport: 15474
  - lbname: cs101-ui-lb
    function: cs101-ui
    slbenabled: true
    ports:
      - port: 7022
        targetport: 7022
      # Following are only for debugging
      - port: 15372
        targetport: 15372      
  - lbname: cs101-cron-lb
    function: cs101-cron
    slbenabled: true
    ports:
      - port: 7012
        targetport: 7012
      # Following are only for debugging
      - port: 7020
        targetport: 7020
      - port: 15373
        targetport: 15373
      - port: 15374
        targetport: 15374
