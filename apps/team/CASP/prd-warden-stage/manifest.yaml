apiVersion: v1

system:
    notifications:
      email:
        - warden@salesforce.com
    functions:
    - name: warden-stage-func
      count: 3
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 0
          maxUnavailable: 1
      containers:
      - name: prd-warden-stage
        image: dva/casp/warden_strata:475
        ports:
        - name: http
          containerPort: 8889
        - name: https
          containerPort: 8444
        - name: actuator
          containerPort: 15372
        env:
        - name: BRANCH
          value: "eng_production_staging"
        - name: NODENAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - mountPath: /home/sfdc-casp/logs
          name: staging-log-vol
        - mountPath: /opt/warden/cantor
          name: staging-cantor-vol
        - mountPath: /wardenpki/
          name: wardenpki
          readOnly: true
        - mountPath: /home/sfdc-casp/pki/client
          name: maievclientcert
        - mountPath: /home/sfdc-casp/pki/server
          name: wardenservercert
        - mountPath: /warden-secrets/
          name: splunk-credentials
        - mountPath: /warden/secrets/
          name: warden-secrets-conf
        - mountPath: /warden-secrets/argus-secrets/
          name: argus-secrets
          readOnly: true
        - mountPath: /warden/secrets/gus-secrets/
          name: gus-credentials
          readOnly: true
        livenessProbe:
          httpGet:
            path: /manage/health
            port: 15372
          initialDelaySeconds: 120
          periodSeconds: 10
      volumes:
      - name: staging-log-vol
        hostPath:
          path: /home/sfdc-casp/staging/logs
      - name: staging-cantor-vol
        hostPath:
          path: /home/sfdc-casp/staging/cantor
      - name: wardenpki
        k4aSecret:
          secretName: wardenpki
      - name: maievclientcert
        maddogCert:
          type: client
      - name: wardenservercert
        maddogCert:
          type: server
          lbnames:
          - warden-stage-node
      - name: splunk-credentials
        k4aSecret:
          secretName: warden-secrets
      - name: warden-secrets-conf
        k4aSecret:
          secretName: warden-secrets-conf
      - name: argus-secrets
        k4aSecret:
          secretName: argus-secrets
      - name: gus-credentials
        k4aSecret:
          secretName: gus-secrets

    loadbalancers:
    - lbname: warden-stage-node
      function: warden-stage-func
      slbEnabled: true
      ports:
        - port: 80
          targetport: 8889
          lbalgorithm: roundrobin
        - port: 443
          targetport: 8444
          lbalgorithm: roundrobin
        - port: 15372
          targetport: 15372
          lbalgorithm: roundrobin
