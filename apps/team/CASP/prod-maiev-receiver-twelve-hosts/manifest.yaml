apiVersion: v1

system:
    notifications:
      email:
        - warden@salesforce.com
    functions:
    - name: maiev-receiver
      identity:
        serviceName: maiev-receiver
      count: 3
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 0
          maxUnavailable: 2
      containers:
      - name: prod-maiev-receiver
        image: dva/maiev-receiver:jenkins-CASP-maiev-dt-remove-streams-3-itest
        ports:
        - name: receiver-grpc
          containerPort: 7020
        - name: receiver-http
          containerPort: 8086
        - name: receiver-https
          containerPort: 8443
        livenessProbe:
          exec:
            command:
            - /usr/bin/true
        env:
        - name: MASTER_GRPC_PORT
          value: "7020"
        - name: CANTOR_GRPC_TARGET
          value: "cantor.casp.$KINGDOM-sam.$KINGDOM.slb.sfdc.net:11983"
        - name: HTTP_PORT
          value: "8085"
        - name: BASE_PATH
          value: "/v1/*"
        - name: BRANCH
          value: "ops_production"
        - name: KAFKA_PROPERTIES
          value: "/home/sfdc-maiev/receiver/kafka-producer.properties"
        - name: NODENAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - mountPath: /home/sfdc-maiev/logs
          name: log-vol
        - mountPath: /home/sfdc-maiev/certs
          name: server-cert
        - mountPath: /home/sfdc-maiev/client-certs
          name: client-cert
      # ------- sherpa envoy container -------
      - name: maiev-sherpa
        # Use the latest release version from https://git.soma.salesforce.com/servicelibs/sherpa-envoy/releases
        image: sfci/servicelibs/sherpa-envoy:1.0.13
        # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
        ports:
        - name: http2-tls-in
          containerPort: 7443
        - name: sherpa-adm
          containerPort: 15373
        livenessProbe:
          exec:
            command:
              - ./bin/is-alive
          initialDelaySeconds: 60
          periodSeconds: 5
        readinessProbe:
          exec:
            command:
              - ./bin/is-ready
          initialDelaySeconds: 50
          periodSeconds: 5
        # The cert names should match whatever you choose below in your volumes section.
        # The mount paths match the defaults assumed by sherpa. Changing the paths requires a corresponding manual override in sherpa.
        volumeMounts:
          - name: client-cert
            mountPath: /client-certs
          - name: server-cert
            mountPath: /server-certs
      # ------- beacon container - announces service so mesh proxy is aware -------
      - name: beacon
        image: sfci/servicelibs/beacon:853c4db9f14805018be6f5e7607ffe65b5648822
        livenessProbe:
          exec:
            command:
              - /usr/bin/true
        # FUNCTION_NAMESPACE: The Kubernetes namespace in which the container is running.
        # FUNCTION: Value listed in the manifest for the function key.
        args:
          - -endpoint
          - $(FUNCTION_NAMESPACE)/$(FUNCTION):DATACENTER_ALLENV:7443 # http2/gRPC tls port
      volumes:
      - name: log-vol
        hostPath:
          path: /home/sfdc-casp/maiev-logs
      - name: server-cert
        maddogCert:
          type: server
          lbnames:
            - maiev-receiver
      - name: client-cert
        maddogCert:
          type: client
    loadbalancers:
    - lbname: maiev-receiver
      function: maiev-receiver
      slbEnabled: true
      ports:
        - port: 80 # http
          targetport: 8086
        - port: 443 # https
          targetport: 8443
        - port: 7443 # http2-tls-in
          targetport: 7443
        - port: 7442 # grpc sherpa bypass
          targetport: 7020
        - port: 15373 # sherpa admin
          targetport: 15373
