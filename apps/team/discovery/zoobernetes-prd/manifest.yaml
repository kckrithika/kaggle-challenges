apiVersion: v1
system:
  functions:
  - name: zoobernetes
    count: 1

    containers:
    - name: zoobernetes
      image: sfci/services/sfdc-bazel/disco/zoobernetes:6e59764a8
      args:
      - >- #Multiline argument
        --z9s.whitelisted.services=app:app;
        casam:green,blue;
        service-mesh:ajnafunneldirect;
        funnel:ajnafunneldirecttls,zipkindirecttls

      #Used to trigger redeploy
      env:
      - name: DEMO_GREETING
        value: "Hello from z9s"

      ports:
      - containerPort: 7020
        name: grpc-svc
      - containerPort: 15372
        name: scone-mgmt

      resources:
        limits:
          cpu: 4000m
          memory: 4Gi
        requests:
          cpu: 2000m
          memory: 2Gi

      livenessProbe:
        initialDelaySeconds: 60
        httpGet:
          path: /manage/health
          port: 15372

      volumeMounts:
      - mountPath: /home/scone/logs
        name: logvolservice

    - name: sherpa
      # Use the latest release version from https://git.soma.salesforce.com/servicelibs/sherpa-envoy/releases
      image: sfci/servicelibs/sherpa-envoy:1.0.8
      # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
      ports:
      - containerPort: 7443
        name: http2-tls-in
      - containerPort: 15373
        name: sherpa-adm
      livenessProbe:
        exec:
          command:
          - ./bin/is-alive
        initialDelaySeconds: 60
        periodSeconds: 5
      readinessProbe:
        exec:
          command:
          - ./bin/is-ready
        initialDelaySeconds: 50
        periodSeconds: 5
      # The cert names should match whatever you choose below in your volumes section.
      # The mount paths match the defaults assumed by sherpa. Changing the paths requires a corresponding manual override in sherpa.
      volumeMounts:
      - name: client-cert
        mountPath: /client-certs
      - name: server-cert
        mountPath: /server-certs

    serviceAccountName: zoobernetessvcaccount

    volumes:
      # The volumes to mount for shipping logs to splunk
      # General rule is to use path with pattern: /home/sfdc-*/logs/**/*.json
      - name: logvolservice
        hostPath:
          path: /home/sfdc-scone-zoobernetes/logs
      # Volumes for maddog for sherpa
      - name: client-cert
        maddogCert:
          type: client
      - name: server-cert
        maddogCert:
          type: server
