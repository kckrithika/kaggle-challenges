apiVersion: v1
system:
  functions:
  - name: zoobernetes-test
    count: 1
    annotations:
      sidecar.istio.io/inject: "true"

    containers:
    - name: zoobernetes
      image: sfci/services/sfdc-bazel/disco/zoobernetes:c4802ae5d
      args:
      - >- #Multiline argument
        --z9s.whitelisted.services=
        casam:green,blue;
        service-mesh:ajnafunneldirect;
        funnel:ajnafunneldirecttls,zipkindirecttls

      #Used to trigger redeploy
      env:
      - name: DEMO_GREETING
        value: "Hello from environment"
      - name: JAVA_OPTS
        value: "-Dmesh.istio-mode=true"

      ports:
      - containerPort: 7443
        name: grpc-sherpa
      - containerPort: 7020
        name: grpc-svc
      - containerPort: 15372
        name: scone-mgmt

      resources:
        limits:
          cpu: 4000m
          memory: 4Gi
        requests:
          cpu: 2000m
          memory: 2Gi

      livenessProbe:
        initialDelaySeconds: 60
        httpGet:
          path: /manage/health
          port: 15372

      volumeMounts:
      - mountPath: /home/scone/logs
        name: logvolservice

    serviceAccountName: zoobernetessvcaccount

    volumes:
      # The volumes to mount for shipping logs to splunk
      # General rule is to use path with pattern: /home/sfdc-*/logs/**/*.json
      - name: logvolservice
        hostPath:
          path: /home/sfdc-scone-zoobernetes/logs
      # Volumes for maddog for sherpa
      - name: client-cert
        maddogCert:
          type: client
      - name: server-cert
        maddogCert:
          type: server

  loadbalancers:
  - lbname: zoobernetes-test
    function: zoobernetes-test
    ports:
      - lbtype: dsr
        port: 7443
        targetport: 7443
        name: grpc-das

