apiVersion: v1

system:
  notifications:
    email:
      - cre@salesforce.com
  functions:
    - name: cre-control-plane
      count: 3
      containers:
        - name: cre-control-plane
          image: sfci/cre-fusion/services:controlplane.v2.0.2.master.2db8e12.18
          env:
            - name: K8S_API_ENDPOINT
              value: https://kubernetes-api-flowsnake-iad.slb.sfdc.net
            ####################################################################################################
            ############################   ENGINE/DDS FLOWSNAKE ARTIFACTS ( Most frequently changed ) ##########
            ####################################################################################################
            - name: INGEST_SPEC_IMAGE
              value: ops0-artifactrepo1-0-iad.data.sfdc.net/sfci/cre/cre-engine:2.0.0.1.master.c637511.21
            - name: EXPORT_SPEC_IMAGE
              value: ops0-artifactrepo1-0-iad.data.sfdc.net/sfci/cre/cre-dds-spark:2.0.1.master.c5ad758.18
            - name: SAVE_SPEC_IMAGE
              value: ops0-artifactrepo1-0-iad.data.sfdc.net/sfci/cre/cre-dds-spark:2.0.1.master.c5ad758.18
            ####################################################################################################
            ####################################### GLOBAL SHARED VALUES #######################################
            ####################################################################################################
            - name: CONTROL_PLANE_ENDPOINT
              value: http://cre-control-plane.retail-cre.localhost.mesh.force.com:5442
            - name: SFDC_ENVIRONMENT
              value: prod
            - name: METRICS_KAFKA_ENABLED
              value: true
            - name: METRICS_KAFKA_TOPIC
              value: sfdc.prod.cre__iad.ajna_local__cre_metrics
            - name: METRICS_KAFKA_SERVER
              value: ajna0-broker1-0-iad.data.sfdc.net:9093
              ## HBASE
            - name: HBASE_ENVIRONMENT
              value: prod
            - name: HBASE_DATACENTER
              value: iad
              ## FLOWSNAKE
            - name: MAX_FLOWSNAKE_ENVIRONMENTS
              value: 25
            ####################################################################################################
            ####################################### INGEST environment variables ###############################
            ####################################################################################################
            - name: INGEST_ANNOTATIONS_PKI_NAME
              value: cre-engine
            - name: INGEST_K4A_VAULT
              value: cre-engine-na-1
            - name: INGEST_ADDITIONAL_JVM_ARGS
              value: "-Dfile.encoding=UTF-8 -Djars=/opt/cre/cre-engine.jar -XX:+UseG1GC -verbose:jni -Dscala.concurrent.context.numThreads=x4 -Dspark.task.maxFailures=16"
            ####################################################################################################
            ####################################### SAVE environment variables ###############################
            ####################################################################################################
            - name: SAVE_ANNOTATIONS_PKI_NAME
              value: cre-engine
            - name: SAVE_K4A_VAULT
              value: cre-dds-na-1
            - name: SAVE_EXECUTOR_INSTANCES
              value: 4
            - name: SAVE_SPARK_DEFAULT_PARALLELISM
              value: 60
            - name: SAVE_SPARK_SQL_SHUFFLE_PARTITIONS
              value: 60
            ####################################################################################################
            ####################################### EXPORT environment variables ###############################
            ####################################################################################################
            - name: EXPORT_ANNOTATIONS_PKI_NAME
              value: cre-engine
            - name: EXPORT_K4A_VAULT
              value: cre-dds-na-1
            - name: EXPORT_DRIVER_CORES
              value: 16
            - name: EXPORT_EXECUTOR_CORES
              value: 15
            - name: EXPORT_EXECUTOR_INSTANCES
              value: 4
            - name: EXPORT_DRIVER_MEMORY
              value: 16g
            - name: EXPORT_SPARK_DEFAULT_PARALLELISM
              value: 60
            - name: EXPORT_SPARK_SQL_SHUFFLE_PARTITIONS
              value: 60
            ####################################################################################################
            ##################################### APP Config environment variables #############################
            ####################################################################################################
            - name: FLOWSNAKE_ENDPOINT
              value:  https://flowsnake-iad.data.sfdc.net
              ## MADDOG (MAD DOG)
            - name: MADDOG_CLIENT_KEYSTORE
              value: maddog/maddog-client-keystore.json
            - name: MADDOG_CLIENT_TRUSTSTORE
              value: maddog/maddog-client-truststore.json
              ## DBaaS
            - name: DATABASE_NAMESPACE
              value: crecontrolplane
            - name: SPRING_DATASOURCE_URL
              value: jdbc:discover://dbaas0-minionapp1-1-iad.ops.sfdc.net:1511,dbaas0-minionapp2-1-iad.ops.sfdc.net:1511,dbaas0-minionapp3-1-iad.ops.sfdc.net:1511/${database.namespace}?${database.discovery.params}
              ## Stream Processor
            - name: STREAM_PROCESSING_ENDPOINT
              value: cre-sp.retail-cre.localhost.mesh.force.com:5442
            - name: OU_NAME
              value: app, retail-cre.cre-sp, retail-cre.cre-engine
            - name: GDOT_ENVIRONMENT
              value: production
            - name: GDOT_PRODUCTION
              value: false
            - name: GDOT_PROVISIONING_USER_NAME
              value: creprodprovisioner
            - name: CRE_API_ENDPOINT
              value: cre-api.retail-cre.localhost.mesh.force.com:5442
            ####################################################################################################
            ####################################### PERF environment variables #################################
            ####################################################################################################
            - name: JVM_ARGS
              value: "-Djava.util.concurrent.ForkJoinPool.common.parallelism=8
                  -verbose:gc -XX:+PrintHeapAtGC
                  -XX:+PrintPromotionFailure -XX:+PrintTenuringDistribution -XX:+PrintGCDetails
                  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime
                  -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCCause -XX:+DisableExplicitGC
                  -Xloggc:/opt/cre/cre-control-plane/verbosegc_$(FUNCTION_INSTANCE_NAME).log
                  -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M
                  -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/cre/cre-control-plane
                  -Xmx4G -Xms4G -XX:ParallelGCThreads=8"
          resources:
            limits: { cpu: "2", memory: "6Gi" }
            requests: { cpu: "2", memory: "5Gi" }
          ports:
            - containerPort: 8080
            - containerPort: 7022
            - containerPort: 15372
          livenessProbe:
            httpGet:
              path: /manage/health
              port: 15372
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /manage/ready
              port: 15372
            initialDelaySeconds: 60
            periodSeconds: 10
          volumeMounts:
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
            - mountPath: /opt/cre/cre-control-plane
              name: logvol
        - name: sherpa-cre-control-plane
          # Each commit to master for https://git.soma.salesforce.com/servicelibs/sherpa-envoy/commits/master has an image created.
          # Use the full git SHA as the docker image tag.
          image: sfci/servicelibs/sherpa-envoy:213d5137f0015e81c59afe6f93f6ab775dc4798b
          volumeMounts:
            - mountPath: /log
              name: sherpa-log-volume
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
          env:
            - name: SFDC_ENVIRONMENT
              value: prod
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          ports:
            - containerPort: 7442
              name: sh-in-http1-tls
            - containerPort: 15373 # Sherpa admin port. This can be handy when debugging issues.
              name: sherpa-in-admin
          livenessProbe:
            exec:
              command:
                - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
                - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
        - name: beacon
          image: sfci/servicelibs/beacon:f6445b2b299f232eda1e0be9739b8242153478ea
          args:
            - -endpoint
            - retail-cre/cre-control-plane:DATACENTER_ALLENV:7442
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                - "/home/scone/is-alive.sh"
      volumes:
        - name: logvol
          hostPath:
            path: /home/sfdc-cre/logs/cre-control-plane
        - name: client-certs
          maddogCert:
            type: client
        - name: server-certs
          maddogCert:
            type: server
            lbnames:
              - cre-control-plane-lb
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
  loadbalancers:
    - lbname: cre-control-plane-lb
      function: cre-control-plane
      slbEnabled: true
      ports:
        - port: 7442
          targetport: 7442
