apiVersion: v1

system:
  notifications:
    email:
      - cre@salesforce.com
  functions:
    - name: cre-control-plane-ccp-perf
      count: 3
      labels:
        app: cre-control-plane-ccp-perf
      annotations:
        "routing.mesh.sfdc.net/enabled": "true"
      containers:
        - name: cre-control-plane-ccp-perf
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/cre-fusion/services:controlplane.2.1.2.0.release-2.1.2.6ca65c6.5
          env:
            ####################################################################################################
            ############################ ENGINE/DDS FLOWSNAKE ARTIFACTS ( Most frequently changed ) ############
            ####################################################################################################
            - name: INGEST_SPEC_IMAGE
              value: ops0-artifactrepo2-0-prd.data.sfdc.net/docker-sfci-dev/sfci/cre/cre-engine:2.1.0.7.master.0b1f4d4.45
            - name: EXPORT_SPEC_IMAGE
              value: ops0-artifactrepo2-0-prd.data.sfdc.net/docker-sfci-dev/sfci/cre/cre-dds-spark:2.1.4.0.master.40e17aa.23
            - name: SAVE_SPEC_IMAGE
              value: ops0-artifactrepo2-0-prd.data.sfdc.net/docker-sfci-dev/sfci/cre/cre-dds-spark:2.1.4.0.master.40e17aa.23
            ####################################################################################################
            ####################################### GLOBAL SHARED VALUES #######################################
            ####################################################################################################
            - name: CONTROL_PLANE_ENDPOINT
              value: http://cre-control-plane-ccp-perf.retail-cre.localhost.mesh.force.com:5442
            - name: SFDC_ENVIRONMENT
              value: ccp-perf
              ## KAFKA
            - name: METRICS_KAFKA_ENABLED
              value: true
            - name: METRICS_KAFKA_TOPIC
              value: sfdc.prod.cre__prd.ajna_local__cre_metrics_CCP_Integration_Performance
            - name: METRICS_KAFKA_SERVER
              value: ajna0-broker1-0-prd.data.sfdc.net:9093
              ## HBASE
            - name: HBASE_ENVIRONMENT
              value: kingdom-perf
            - name: HBASE_NAMESPACE
              value: CRE
            - name: HBASE_DATACENTER
              value: prd
            ####################################################################################################
            ####################################### INGEST environment variables ###############################
            ####################################################################################################
            - name: INGEST_ANNOTATIONS_PKI_NAME
              value: cre-engine-ccp-perf
            - name: INGEST_K4A_VAULT
              value: cre-engine-dev
            ####################################################################################################
            ####################################### SAVE environment variables #################################
            ####################################################################################################
            - name: CRE_DDS_ENV
              value: Prd
            - name: SAVE_ANNOTATIONS_PKI_NAME
              value: cre-engine-ccp-perf
            - name: SAVE_K4A_VAULT
              value: cre-dds-dev
            # 2.1.4 PATCH ENVIRONMENT VARIABLES
            - name: SAVE_EXECUTOR_INSTANCES
              value: 4
            - name: SAVE_EXECUTOR_CORES
              value: 10
            - name: SAVE_EXECUTOR_MEMORY
              value: 36g
            - name: SAVE_EXECUTOR_MEMORY_OVERHEAD
              value: 4g
            - name: SAVE_SPARK_DEFAULT_PARALLELISM
              value: 40
            - name: SAVE_SPARK_SQL_SHUFFLE_PARTITIONS
              value: 40
            ####################################################################################################
            ####################################### EXPORT environment variables ###############################
            ####################################################################################################
            - name: EXPORT_ANNOTATIONS_PKI_NAME
              value: cre-engine-ccp-perf
            - name: EXPORT_K4A_VAULT
              value: c360-dvd-rw-dev-na-1
            ####################################################################################################
            ##################################### APP Config environment variables #############################
            ####################################################################################################
              ## MADDOG (MAD DOG)
            - name: MADDOG_CLIENT_KEYSTORE
              value: maddog/maddog-client-keystore.json
            - name: MADDOG_CLIENT_TRUSTSTORE
              value: maddog/maddog-client-truststore.json
              ## DBaaS
            - name: DATABASE_NAMESPACE
              value: crecontrolplaneccpperf
            - name: SPRING_DATASOURCE_URL
              value: jdbc:discover://dbaas0-minionapp1-1-prd.eng.sfdc.net:1511,dbaas0-minionapp2-1-prd.eng.sfdc.net:1511,dbaas0-minionapp3-1-prd.eng.sfdc.net:1511/${database.namespace}?${database.discovery.params}
              ## Stream Processor
            - name: STREAM_PROCESSING_ENDPOINT
              value: cre-sp-ccp-perf.retail-cre.localhost.mesh.force.com:5442
            - name: CRE_API_ENDPOINT
              value: cre-api-ccp-perf.retail-cre.localhost.mesh.force.com:5442
            ####################################################################################################
            ####################################### PERF environment variables #################################
            ####################################################################################################
            - name: JVM_ARGS
              value: "-Djava.util.concurrent.ForkJoinPool.common.parallelism=8
                  -verbose:gc -XX:+PrintGCDateStamps -XX:+PrintHeapAtGC
                  -XX:+PrintPromotionFailure -XX:+PrintTenuringDistribution -XX:+PrintGCDetails
                  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime
                  -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCCause -XX:+DisableExplicitGC
                  -Xloggc:/opt/cre/cre-control-plane-ccp-perf/verbosegc_$(FUNCTION_INSTANCE_NAME).log
                  -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/cre/cre-control-plane-ccp-perf
                  -Dcom.sun.management.jmxremote.port=8898
                  -Dcom.sun.management.jmxremote.rmi.port=8898
                  -Dcom.sun.management.jmxremote.ssl=false
                  -Dcom.sun.management.jmxremote.authenticate=false
                  -Xmx4G -Xms4G -XX:ParallelGCThreads=8"
          resources:
            limits: { cpu: "2", memory: "6Gi" }
            requests: { cpu: "2", memory: "5Gi" }
          ports:
            - containerPort: 8080
            - containerPort: 7022
            - containerPort: 15372
          livenessProbe:
            httpGet:
              path: /manage/health
              port: 15372
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /manage/ready
              port: 15372
            initialDelaySeconds: 30
            periodSeconds: 10
          volumeMounts:
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
            - mountPath: /opt/cre/cre-control-plane-ccp-perf
              name: logvol
        - name: sherpa-cre-control-plane
          # Sherpa latest releases: https://git.soma.salesforce.com/servicelibs/sherpa-envoy/releases
          image: sfci/servicelibs/sherpa-envoy:1.0.13
          volumeMounts:
            - mountPath: /log
              name: sherpa-log-volume
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
          env:
            - name: SFDC_ENVIRONMENT
              value: ccp-perf
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          ports:
            - containerPort: 7442
              name: sh-in-http1-tls
            - containerPort: 15373 # Sherpa admin port. This can be handy when debugging issues.
              name: sherpa-in-admin
          livenessProbe:
            exec:
              command:
                - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
                - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
      volumes:
        - name: logvol
          hostPath:
            path: /home/sfdc-cre/logs/cre-control-plane-ccp-perf
        - name: client-certs
          maddogCert:
            type: client
        - name: server-certs
          maddogCert:
            type: server
            lbnames:
              - cre-control-plane-ccp-perf-lb
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
  loadbalancers:
    - lbname: cre-control-plane-ccp-perf-lb
      function: cre-control-plane-ccp-perf
      slbEnabled: true
      ports:
        - port: 7442
          targetport: 7442
        - port: 8096
          targetport: 7022
        - port: 9096
          targetport: 15372
    - lbname: cre-control-plane-ccp-perf
      function: cre-control-plane-ccp-perf
      ports:
        - lbtype: dsr
          port: 7442
          targetport: 7442
          name: https-cre
