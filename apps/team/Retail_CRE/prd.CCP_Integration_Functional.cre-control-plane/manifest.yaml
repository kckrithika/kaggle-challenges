apiVersion: v1

system:
  notifications:
    email:
      - cre@salesforce.com
  functions:
    - name: cre-control-plane-ccp-func
      count: 3
      labels:
        app: cre-control-plane-ccp-func
      annotations:
        "routing.mesh.sfdc.net/enabled": "true"
      containers:
        - name: cre-control-plane-ccp-func
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/cre-fusion/services:controlplane.2.1.1.0.release-2.1.1.2ba82c8.8
          env:
            ####################################################################################################
            ############################ ENGINE/DDS FLOWSNAKE ARTIFACTS ( Most frequently changed ) ############
            ####################################################################################################
            - name: INGEST_SPEC_IMAGE
              value: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/cre/cre-engine:1.2.1.1.release-2.1.c5feda5.3
            - name: EXPORT_SPEC_IMAGE
              value: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/cre/cre-dds-spark:2.1.1-TEST.0.develop-at-test.b1c5d51.9
            - name: SAVE_SPEC_IMAGE
              value: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/cre/cre-dds-spark:2.1.1-TEST.0.develop-at-test.b1c5d51.9
            ####################################################################################################
            ####################################### GLOBAL SHARED VALUES #######################################
            ####################################################################################################
            - name: CONTROL_PLANE_ENDPOINT
              value: http://cre-control-plane-ccp-func.retail-cre.localhost.mesh.force.com:5442
            - name: SFDC_ENVIRONMENT
              value: ccp-func
              ## KAFKA
            - name: METRICS_KAFKA_ENABLED
              value: true
            - name: METRICS_KAFKA_TOPIC
              value: sfdc.prod.cre__prd.ajna_local__cre_metrics_CCP_Integration_Functional
            - name: METRICS_KAFKA_SERVER
              value: ajna0-broker1-0-prd.data.sfdc.net:9093
              ## HBASE
            - name: HBASE_ENVIRONMENT
              value: kingdom-test
            - name: HBASE_DATACENTER
              value: prd
            ####################################################################################################
            ####################################### INGEST environment variables ###############################
            ####################################################################################################
            - name: INGEST_ANNOTATIONS_PKI_NAME
              value: cre-engine-ccp-func
            - name: INGEST_K4A_VAULT
              value: cre-engine-dev
            ####################################################################################################
            ####################################### SAVE environment variables #################################
            ####################################################################################################
            - name: CRE_DDS_ENV
              value: Prd
            - name: SAVE_ANNOTATIONS_PKI_NAME
              value: cre-engine-ccp-func
            - name: SAVE_K4A_VAULT
              value: cre-dds-dev
            ####################################################################################################
            ####################################### EXPORT environment variables ###############################
            ####################################################################################################
            - name: EXPORT_ANNOTATIONS_PKI_NAME
              value: cre-engine-ccp-func
            ####################################################################################################
            ##################################### APP Config environment variables #############################
            ####################################################################################################
              ## MADDOG (MAD DOG)
            - name: MADDOG_CLIENT_KEYSTORE
              value: maddog/maddog-client-keystore.json
            - name: MADDOG_CLIENT_TRUSTSTORE
              value: maddog/maddog-client-truststore.json
              ## DBaaS
            - name: DATABASE_NAMESPACE
              value: crecontrolplaneccpfunc
            - name: SPRING_DATASOURCE_URL
              value: jdbc:discover://dbaas0-minionapp1-1-prd.eng.sfdc.net:1511/${database.namespace}?${database.discovery.params}
              ## Stream Processor
            - name: STREAM_PROCESSING_ENDPOINT
              value: cre-sp-ccp-func.retail-cre.localhost.mesh.force.com:5442
            - name: CRE_API_ENDPOINT
              value: cre-api-ccp-func.retail-cre.localhost.mesh.force.com:5442
            ####################################################################################################
            ####################################### PERF environment variables #################################
            ####################################################################################################
            - name: JVM_ARGS
              value: "-Djava.util.concurrent.ForkJoinPool.common.parallelism=8
                  -verbose:gc -XX:+PrintGCDateStamps -XX:+PrintHeapAtGC
                  -XX:+PrintPromotionFailure -XX:+PrintTenuringDistribution -XX:+PrintGCDetails
                  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime
                  -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCCause -XX:+DisableExplicitGC
                  -Xloggc:/opt/cre/cre-control-plane-ccp-func/verbosegc_$(FUNCTION_INSTANCE_NAME).log
                  -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/cre/cre-control-plane-ccp-func
                  -Dcom.sun.management.jmxremote.port=8898
                  -Dcom.sun.management.jmxremote.rmi.port=8898
                  -Dcom.sun.management.jmxremote.ssl=false
                  -Dcom.sun.management.jmxremote.authenticate=false
                  -Xmx4G -Xms4G -XX:ParallelGCThreads=8
                  -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=6103"
          resources:
            limits: { cpu: "2", memory: "6Gi" }
            requests: { cpu: "2", memory: "5Gi" }
          ports:
            - containerPort: 8080
            - containerPort: 7022
            - containerPort: 15372
          livenessProbe:
            httpGet:
              path: /manage/health
              port: 15372
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /manage/ready
              port: 15372
            initialDelaySeconds: 30
            periodSeconds: 10
          volumeMounts:
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
            - mountPath: /opt/cre/cre-control-plane-ccp-func
              name: logvol
        - name: sherpa-cre-control-plane
          # Each commit to master for https://git.soma.salesforce.com/servicelibs/sherpa-envoy/commits/master has an image created.
          # Use the full git SHA as the docker image tag.
          image: sfci/servicelibs/sherpa-envoy:213d5137f0015e81c59afe6f93f6ab775dc4798b
          volumeMounts:
            - mountPath: /log
              name: sherpa-log-volume
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
          env:
            - name: SFDC_ENVIRONMENT
              value: ccp-func
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          ports:
            - containerPort: 7442
              name: sh-in-http1-tls
            - containerPort: 15373 # Sherpa admin port. This can be handy when debugging issues.
              name: sherpa-in-admin
          livenessProbe:
            exec:
              command:
                - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
                - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
      volumes:
        - name: logvol
          hostPath:
            path: /home/sfdc-cre/logs/cre-control-plane-ccp-func
        - name: client-certs
          maddogCert:
            type: client
        - name: server-certs
          maddogCert:
            type: server
            lbnames:
              - cre-control-plane-ccp-func-lb
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
  loadbalancers:
    - lbname: cre-control-plane-ccp-func-lb
      function: cre-control-plane-ccp-func
      slbEnabled: true
      ports:
        - port: 7442
          targetport: 7442
        - port: 8094
          targetport: 7022
        - port: 9094
          targetport: 15372
    - lbname: cre-control-plane-ccp-func
      function: cre-control-plane-ccp-func
      ports:
        - lbtype: dsr
          port: 7442
          targetport: 7442
          name: https-cre
