apiVersion: v1

system:
  notifications:
    email:
      - cre@salesforce.com
  functions:
    - name: cre-control-plane
      count: 3
      containers:
        - name: cre-control-plane
          image: sfci/cre-fusion/services:controlplane.2.1.0.0.master.9176c7d.20
          env:
            - name: K8S_API_ENDPOINT
              value: https://kubernetes-api-flowsnake-frf.slb.sfdc.net
            ####################################################################################################
            ############################   ENGINE/DDS FLOWSNAKE ARTIFACTS ( Most frequently changed ) ##########
            ####################################################################################################
            - name: INGEST_SPEC_IMAGE
              value: ops0-artifactrepo1-0-frf.data.sfdc.net/sfci/cre/cre-engine:1.2.1.1.master.871cb95.36
            - name: EXPORT_SPEC_IMAGE
              value: ops0-artifactrepo1-0-frf.data.sfdc.net/sfci/cre/cre-dds-spark:2.1.1.master.07f636a.21
            - name: SAVE_SPEC_IMAGE
              value: ops0-artifactrepo1-0-frf.data.sfdc.net/sfci/cre/cre-dds-spark:2.1.1.master.07f636a.21
            ####################################################################################################
            ####################################### GLOBAL SHARED VALUES #######################################
            ####################################################################################################
            - name: CONTROL_PLANE_ENDPOINT
              value: http://cre-control-plane.retail-cre.localhost.mesh.force.com:5442
            - name: SFDC_ENVIRONMENT
              value: prod
            - name: METRICS_KAFKA_ENABLED
              value: true
            - name: METRICS_KAFKA_TOPIC
              value: sfdc.prod.cre__frf.ajna_local__cre_metrics
            - name: METRICS_KAFKA_SERVER
              value: ajna0-broker1-0-frf.data.sfdc.net:9093
              ## HBASE
            - name: HBASE_ENVIRONMENT
              value: prod
            - name: HBASE_DATACENTER
              value: frf
            ####################################################################################################
            ####################################### INGEST environment variables ###############################
            ####################################################################################################
            - name: INGEST_ANNOTATIONS_PKI_NAME
              value: cre-engine
            - name: INGEST_K4A_VAULT
              value: cre-engine-eu-1
            - name: BUCKET_INGEST_MANIFEST_OVERRIDE_ENABLED
              value: true
            - name: BUCKET_INGEST_CONCURRENCY_CONTROL_ENABLED
              value: true
            ####################################### Bucket Small variables #####################################
            - name: BUCKET_INGEST_SMALL_THRESHOLD_SIZE_MAX_JSON
              value: 80M
            - name: BUCKET_INGEST_SMALL_THRESHOLD_SIZE_MAX_CSV
              value: 40M
            - name: BUCKET_INGEST_SMALL_CONCURRENCY_CONTROL
              value: 50
            - name: BUCKET_INGEST_SMALL_SPARK_EXECUTOR_CORES
              value: 5
            - name: BUCKET_INGEST_SMALL_SPARK_EXECUTOR_CORE_REQUESTS
              value: 5
            - name: BUCKET_INGEST_SMALL_SPARK_EXECUTOR_MEMORY
              value: 16g
            - name: BUCKET_INGEST_SMALL_SPARK_EXECUTOR_MEMORY_OVERHEAD
              value: 1g
            - name: BUCKET_INGEST_SMALL_SPARK_SQL_SHUFFLE_PARTITIONS
              value: 200
            - name: BUCKET_INGEST_SMALL_SPARK_JAVA_OPTIONS
              value: "-Djars=/opt/cre/cre-engine.jar -XX:+UseParallelGC -verbose:jni"
            ####################################### Bucket Medium variables #####################################
            - name: BUCKET_INGEST_MEDIUM_THRESHOLD_SIZE_MIN_JSON
              value: 80M
            - name: BUCKET_INGEST_MEDIUM_THRESHOLD_SIZE_MAX_JSON
              value: 2G
            - name: BUCKET_INGEST_MEDIUM_THRESHOLD_SIZE_MIN_CSV
              value: 40M
            - name: BUCKET_INGEST_MEDIUM_THRESHOLD_SIZE_MAX_CSV
              value: 1G
            - name: BUCKET_INGEST_MEDIUM_CONCURRENCY_CONTROL
              value: 25
            - name: BUCKET_INGEST_MEDIUM_SPARK_DRIVER_MEMORY
              value: 7g
            - name: BUCKET_INGEST_MEDIUM_SPARK_DRIVER_MEMORY_OVERHEAD
              value: 1g
            - name: BUCKET_INGEST_MEDIUM_SPARK_EXECUTOR_MEMORY
              value: 30g
            - name: BUCKET_INGEST_MEDIUM_SPARK_JAVA_OPTIONS
              value: "-Djars=/opt/cre/cre-engine.jar -XX:+UseParallelGC -verbose:jni"
            ####################################### Bucket Large variables #######################################
            - name: BUCKET_INGEST_LARGE_THRESHOLD_SIZE_MIN_JSON
              value: 2G
            - name: BUCKET_INGEST_LARGE_THRESHOLD_SIZE_MIN_CSV
              value: 1G
            - name: BUCKET_INGEST_LARGE_CONCURRENCY_CONTROL
              value: 10
            - name: BUCKET_INGEST_LARGE_SPARK_DRIVER_MEMORY
              value: 8g
            - name: BUCKET_INGEST_LARGE_SPARK_JAVA_OPTIONS
              value: "-Djars=/opt/cre/cre-engine.jar -XX:+UseParallelGC -verbose:jni"
            ####################################################################################################
            ####################################### SAVE environment variables ###############################
            ####################################################################################################
            - name: SAVE_ANNOTATIONS_PKI_NAME
              value: cre-engine
            - name: SAVE_K4A_VAULT
              value: cre-dds-eu-1
            - name: SAVE_CONCURRENCY_CONTROL_ENABLED
              value: true
            - name: SAVE_CONCURRENCY_CONTROL
              value: 25
            - name: SAVE_DRIVER_MEMORY
              value: 7g
            - name: SAVE_DRIVER_MEMORY_OVERHEAD
              value: 1g
            - name: SAVE_EXECUTOR_INSTANCES
              value: 2
            - name: SAVE_EXECUTOR_CORES
              value: 10
            - name: SAVE_EXECUTOR_CORE_REQUESTS
              value: 10
            - name: SAVE_EXECUTOR_MEMORY
              value: 30g
            - name: SAVE_SPARK_SQL_SHUFFLE_PARTITIONS
              value: 20
            - name: SAVE_SPARK_DEFAULT_PARALLELISM
              value: 20
            ####################################################################################################
            ####################################### EXPORT environment variables ###############################
            ####################################################################################################
            - name: EXPORT_ANNOTATIONS_PKI_NAME
              value: cre-engine
            - name: EXPORT_K4A_VAULT
              value: cre-dds-eu-1
            - name: EXPORT_CONCURRENCY_CONTROL_ENABLED
              value: true
            - name: EXPORT_CONCURRENCY_CONTROL
              value: 15
            - name: EXPORT_DRIVER_MEMORY_OVERHEAD
              value: 1g
            - name: EXPORT_EXECUTOR_CORES
              value: 10
            - name: EXPORT_DRIVER_MEMORY
              value: 7g
            - name: EXPORT_SPARK_DEFAULT_PARALLELISM
              value: 20
            - name: EXPORT_SPARK_SQL_SHUFFLE_PARTITIONS
              value: 20
            - name: EXPORT_EXECUTOR_CORE_REQUESTS
              value: 10
            - name: EXPORT_EXECUTOR_MEMORY
              value: 30g
            ####################################################################################################
            ##################################### APP Config environment variables #############################
            ####################################################################################################
            - name: FLOWSNAKE_ENDPOINT
              value:  https://flowsnake-frf.data.sfdc.net
              ## MADDOG (MAD DOG)
            - name: MADDOG_CLIENT_KEYSTORE
              value: maddog/maddog-client-keystore.json
            - name: MADDOG_CLIENT_TRUSTSTORE
              value: maddog/maddog-client-truststore.json
              ## DBaaS
            - name: DATABASE_NAMESPACE
              value: crecontrolplane
            - name: SPRING_DATASOURCE_URL
              value: jdbc:discover://dbaas0-minionapp1-1-frf.ops.sfdc.net:1511,dbaas0-minionapp2-1-frf.ops.sfdc.net:1511,dbaas0-minionapp3-1-frf.ops.sfdc.net:1511/${database.namespace}?${database.discovery.params}
              ## Stream Processor
            - name: STREAM_PROCESSING_ENDPOINT
              value: cre-sp.retail-cre.localhost.mesh.force.com:5442
            - name: OU_NAME
              value: app, retail-cre.cre-sp, retail-cre.cre-engine
            - name: GDOT_ENVIRONMENT
              value: production
            - name: GDOT_PRODUCTION
              value: false
            - name: GDOT_PROVISIONING_USER_NAME
              value: creprodprovisioner
            - name: CRE_API_ENDPOINT
              value: cre-api.retail-cre.localhost.mesh.force.com:5442
            ####################################################################################################
            ####################################### PERF environment variables #################################
            ####################################################################################################
            - name: JVM_ARGS
              value: "-Djava.util.concurrent.ForkJoinPool.common.parallelism=8
                  -verbose:gc -XX:+PrintHeapAtGC
                  -XX:+PrintPromotionFailure -XX:+PrintTenuringDistribution -XX:+PrintGCDetails
                  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime
                  -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCCause -XX:+DisableExplicitGC
                  -Xloggc:/opt/cre/cre-control-plane/verbosegc_$(FUNCTION_INSTANCE_NAME).log
                  -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M
                  -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/cre/cre-control-plane
                  -Xmx4G -Xms4G -XX:ParallelGCThreads=8"
          resources:
            limits: { cpu: "2", memory: "6Gi" }
            requests: { cpu: "2", memory: "5Gi" }
          ports:
            - containerPort: 8080
            - containerPort: 7022
            - containerPort: 15372
          livenessProbe:
            httpGet:
              path: /manage/health
              port: 15372
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /manage/ready
              port: 15372
            initialDelaySeconds: 60
            periodSeconds: 10
          volumeMounts:
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
            - mountPath: /opt/cre/cre-control-plane
              name: logvol
        - name: sherpa-cre-control-plane
          # Each commit to master for https://git.soma.salesforce.com/servicelibs/sherpa-envoy/commits/master has an image created.
          # Use the full git SHA as the docker image tag.
          image: sfci/servicelibs/sherpa-envoy:213d5137f0015e81c59afe6f93f6ab775dc4798b
          volumeMounts:
            - mountPath: /log
              name: sherpa-log-volume
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
          env:
            - name: SFDC_ENVIRONMENT
              value: prod
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          ports:
            - containerPort: 7442
              name: sh-in-http1-tls
            - containerPort: 15373 # Sherpa admin port. This can be handy when debugging issues.
              name: sherpa-in-admin
          livenessProbe:
            exec:
              command:
                - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
                - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
      volumes:
        - name: logvol
          hostPath:
            path: /home/sfdc-cre/logs/cre-control-plane
        - name: client-certs
          maddogCert:
            type: client
        - name: server-certs
          maddogCert:
            type: server
            lbnames:
              - cre-control-plane-lb
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
  loadbalancers:
    - lbname: cre-control-plane-lb
      annotations:
        slb.sfdc.net/iptype: private_reserved
      function: cre-control-plane
      slbEnabled: true
      ports:
        - port: 7442
          targetport: 7442
