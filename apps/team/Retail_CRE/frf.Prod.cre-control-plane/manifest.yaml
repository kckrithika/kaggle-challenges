apiVersion: v1

system:
  notifications:
    email:
      - cre@salesforce.com
  functions:
    - name: cre-control-plane
      count: 1
      containers:
        - name: cre-control-plane
          image: sfci/cre-fusion/services:controlplane.1.9.0.4.master.09c2e64.16
          env:
            ####################################################################################################
            ############################   ENGINE/DDS FLOWSNAKE ARTIFACTS ( Most frequently changed ) ##########
            ####################################################################################################
            - name: INGEST_FLOWSNAKE_ARTIFACT
              value: ops0-artifactrepo1-0-frf.data.sfdc.net/sfci/cre/cre-engine:1.9.0.0.master.3718f20.10
            - name: SAVE_FLOWSNAKE_ARTIFACT
              value: ops0-artifactrepo1-0-frf.data.sfdc.net/sfci/cre/cre-dds-spark:1.9.1.0.master.51209bb.11
            - name: EXPORT_FLOWSNAKE_ARTIFACT
              value: ops0-artifactrepo1-0-frf.data.sfdc.net/sfci/cre/cre-dds-spark:1.9.1.0.master.51209bb.11
            ####################################################################################################
            ####################################### GLOBAL SHARED VALUES #######################################
            ####################################################################################################
            - name: CONTROL_PLANE_ENDPOINT
              value: http://cre-control-plane.retail-cre.localhost.mesh.force.com:5442
            - name: SFDC_ENVIRONMENT
              value: prod
            - name: METRICS_KAFKA_ENABLED
              value: true
            - name: METRICS_KAFKA_TOPIC
              value: sfdc.prod.cre__frf.ajna_local__cre_metrics
            - name: METRICS_KAFKA_SERVER
              value: ajna0-broker1-0-frf.data.sfdc.net:9093
              ## HBASE
            - name: HBASE_ENVIRONMENT
              value: prod
            - name: HBASE_DATACENTER
              value: frf
              ## FLOWSNAKE
            - name: MAX_FLOWSNAKE_ENVIRONMENTS
              value: 25
            ####################################################################################################
            ####################################### INGEST environment variables ###############################
            ####################################################################################################
            - name: INGEST_CRE_APPLICATION_NAME
              value: cre-engine
            - name: INGEST_K4A_VAULT
              value: cre-engine-na-1
            - name: INGEST_ADDITIONAL_JVM_ARGS
              value: "-Dfile.encoding=UTF-8 -Djars=/opt/cre/cre-engine.jar -XX:+UseG1GC -verbose:jni -Dscala.concurrent.context.numThreads=x4 -Dspark.task.maxFailures=16"
            ####################################################################################################
            ####################################### SAVE environment variables ###############################
            ####################################################################################################
            - name: CRE_DDS_ENV
              value: Prod
            - name: SAVE_CRE_APPLICATION_NAME
              value: cre-engine
            - name: SAVE_K4A_VAULT
              value: cre-dds-na-1
            - name: SAVE_ADDITIONAL_JVM_ARGS
              value: "-Dspark.sql.shuffle.partitions=500 -Dscala.concurrent.context.numThreads=x4 -Dspark.task.maxFailures=16"
            ####################################################################################################
            ####################################### EXPORT environment variables ###############################
            ####################################################################################################
            - name: EXPORT_CRE_APPLICATION_NAME
              value: cre-engine
            - name: EXPORT_ADDITIONAL_JVM_ARGS
              value: "-Dspark.sql.shuffle.partitions=500 -Dscala.concurrent.context.numThreads=x4 -Dspark.task.maxFailures=16"
            ####################################################################################################
            ##################################### APP Config environment variables #############################
            ####################################################################################################
            - name: FLOWSNAKE_ENDPOINT
              value:  https://flowsnake-frf.data.sfdc.net
              ## MADDOG (MAD DOG)
            - name: MADDOG_CLIENT_KEYSTORE
              value: maddog/maddog-client-keystore.json
            - name: MADDOG_CLIENT_TRUSTSTORE
              value: maddog/maddog-client-truststore.json
              ## DBaaS
            - name: DATABASE_NAMESPACE
              value: crecontrolplane
            - name: SPRING_DATASOURCE_URL
              value: jdbc:discover://dbaas0-minionapp1-1-frf.ops.sfdc.net:1511,dbaas0-minionapp2-1-frf.ops.sfdc.net:1511,dbaas0-minionapp3-1-frf.ops.sfdc.net:1511/${database.namespace}?${database.discovery.params}
              ## Stream Processor
            - name: STREAM_PROCESSING_ENDPOINT
              value: cre-sp.retail-cre.localhost.mesh.force.com:5442
            - name: OU_NAME
              value: app, retail-cre.cre-sp, retail-cre.cre-engine
            - name: GDOT_ENVIRONMENT
              value: production
            - name: GDOT_PRODUCTION
              value: false
            - name: GDOT_PROVISIONING_USER_NAME
              value: creprodprovisioner
            - name: CRE_API_ENDPOINT
              value: http://cre-api.retail-cre.localhost.mesh.force.com:5442
            ####################################################################################################
            ####################################### PERF environment variables #################################
            ####################################################################################################
            - name: JVM_ARGS
              value: "-Djava.util.concurrent.ForkJoinPool.common.parallelism=8
                  -verbose:gc -XX:+PrintHeapAtGC
                  -XX:+PrintPromotionFailure -XX:+PrintTenuringDistribution -XX:+PrintGCDetails
                  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime
                  -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCCause -XX:+DisableExplicitGC
                  -Xloggc:/opt/cre/cre-control-plane/verbosegc_$(FUNCTION_INSTANCE_NAME).log
                  -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M
                  -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/cre/cre-control-plane
                  -Xmx4G -Xms4G -XX:ParallelGCThreads=8"
          resources:
            limits: { cpu: "2", memory: "6Gi" }
            requests: { cpu: "2", memory: "5Gi" }
          ports:
            - containerPort: 8080
            - containerPort: 7022
            - containerPort: 15372
          livenessProbe:
            exec:
              command:
                - ls
            initialDelaySeconds: 30
          volumeMounts:
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
            - mountPath: /opt/cre/cre-control-plane
              name: logvol
        - name: sherpa-cre-control-plane
          # Each commit to master for https://git.soma.salesforce.com/servicelibs/sherpa-envoy/commits/master has an image created.
          # Use the full git SHA as the docker image tag.
          image: sfci/servicelibs/sherpa-envoy:213d5137f0015e81c59afe6f93f6ab775dc4798b
          volumeMounts:
            - mountPath: /log
              name: sherpa-log-volume
            - mountPath: /client-certs
              name: client-certs
            - mountPath: /server-certs
              name: server-certs
          env:
            - name: SFDC_ENVIRONMENT
              value: prod
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          ports:
            - containerPort: 7442
              name: sh-in-http1-tls
            - containerPort: 15373 # Sherpa admin port. This can be handy when debugging issues.
              name: sherpa-in-admin
          livenessProbe:
            exec:
              command:
                - "./bin/is-alive"
            initialDelaySeconds: 120
            periodSeconds: 5
          readinessProbe:
            exec:
              command:
                - "./bin/is-ready"
            initialDelaySeconds: 110
            periodSeconds: 5
        - name: beacon
          image: sfci/servicelibs/beacon:f6445b2b299f232eda1e0be9739b8242153478ea
          args:
            - -endpoint
            - retail-cre/cre-control-plane:DATACENTER_ALLENV:7442
          resources:
            limits: { cpu: "1", memory: "1Gi" }
            requests: { cpu: "1", memory: "1Gi" }
          livenessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                - "/home/scone/is-alive.sh"
      volumes:
        - name: logvol
          hostPath:
            path: /home/sfdc-cre/logs/cre-control-plane
        - name: client-certs
          maddogCert:
            type: client
        - name: server-certs
          maddogCert:
            type: server
            lbnames:
              - cre-control-plane-lb
        - name: sherpa-log-volume
          hostPath:
            path: /home/sfdc-sherpa/logs
  loadbalancers:
    - lbname: cre-control-plane-lb
      function: cre-control-plane
      nodeExposed: true
      slbEnabled: true
      ports:
        - port: 8094
          targetport: 8080
