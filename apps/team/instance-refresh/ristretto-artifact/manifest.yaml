apiVersion: v1
system:
  notifications:
    email:
      - dpoh@salesforce.com
  functions:
    - name: ristretto-artifact
      count: 1
      containers:
      - name: ristretto-web
        image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/instance-refresh/ristretto_web:2020-02-13a
        command:
          - /usr/local/bin/wrapper_web.sh
        env:
        - name: GITHUB_SSH_KEY
          value: "/secrets/github_sshkey"
        - name: GITHUB_ORG_NAME
          value: "DBIAAS"
        - name: GITHUB_REPO_NAME
          value: "Ristretto"
        - name: GITHUB_BRANCH
          value: "master"
        - name: WEB_DIRECTORY
          value: "/ristretto-artifact"
        ports:
        - name: ristretto-http
          containerPort: 30000
        volumeMounts:
        - mountPath: /secrets
          name: ristretto-pass
          readOnly: true
        - name: shared-data
          mountPath: /ristretto-artifact
          readOnly: true
        livenessProbe:
          tcpSocket:
            port: 30000
          initialDelaySeconds: 60
          periodSeconds: 10
          failureThreshold: 5
      - name: ristretto-monitor
        image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/instance-refresh/ristretto_monitor:2020-02-13a
        command:
          - /usr/local/bin/wrapper_render_monitor.sh
        env:
        - name: GITHUB_SSH_KEY
          value: "/secrets/github_sshkey"
        - name: GITHUB_ORG_NAME
          value: "DBIAAS"
        - name: GITHUB_REPO_NAME
          value: "Ristretto"
        - name: GITHUB_BRANCH
          value: "master"
        - name: ARTIFACT_DIRECTORY
          value: "/ristretto-artifact"
        - name: REFRESH_INTERVAL
          value: 60
        volumeMounts:
        - mountPath: /secrets
          name: ristretto-pass
          readOnly: true
        - name: shared-data
          mountPath: /ristretto-artifact
        livenessProbe:
          exec:
            command:
              - /bin/bash
              - /usr/local/bin/monitor_health.sh
          initialDelaySeconds: 120
          periodSeconds: 60
          failureThreshold: 5
      identity:
        serviceName: ristretto-web
      volumes:
      - name: ristretto-pass
        k4aSecret:
          secretName: ristretto
      - name: shared-data
        emptyDir: {}
  loadbalancers:
  - lbname: ristretto-artifact
    function: ristretto-artifact
    slbEnabled: true
    ports:
    - port: 80
      targetport: 30000
