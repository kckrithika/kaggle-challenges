apiVersion: v1

system:
  functions:
  - name: speedometer-extension
    count: 1
    containers:
    - name: speedometer-extension
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/hsuanyu.chen/speedometer-extension:hsuanyu.chen-202001311606
      command: ["/moe/speedometer-extension"]
      args:
      - "-gheTokenPath=/secrets/ghe_pat"
      - "-log_dir=/host/data/speedometer/logs"
      - "-argusPasswordPath=/arguspw/password.txt"
      - "-imageRepoMap=policy-manager-v2:Infrastructure-Security/infrasec-secrets/master,vaultconfig-api:Infrastructure-Security/infrasec-secrets/master,vault-init:Infrastructure-Security/infrasec-secrets/master,vault-watchdog:Infrastructure-Security/infrasec-secrets/master,vault:Infrastructure-Security/infrasec-secrets/master"
      ports:
      - containerPort: 8080
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
        # Speedometer typically takes 30 - 40 minutes for a single loop:
        # https://argus-ui.data.sfdc.net/argus/#/viewmetrics?expression=DOWNSAMPLE(-14d:slb.speedometer.PRD.NONE.prd-sam:agingcodevelocity.Deployment.sam-system.slb-ipvs%7Bcontainer%3Dslb-ipvs-processor%7D:avg,%2345m-count%23)
        # Allow it 45 minutes to pulse the first heartbeat. Check every 60 seconds afterwards (the heartbeat decay is set to 45m above).
        initialDelaySeconds: 2700
        periodSeconds: 60
      volumeMounts:
      - mountPath: /host/data/speedometer-extension/logs
        name: logvol
      - mountPath: /secrets
        name: speedometer-ghe-pat
        readOnly: true
      - mountPath: /arguspw
        name: tok-secrets
        readOnly: true
    volumes:
    - name: logvol
      hostPath:
        path: /data/speedometer-extension/logs
    - name: speedometer-ghe-pat
      k4aSecret:
        secretName: speedometer-ghe-pat
    - name: tok-secrets
      k4aSecret:
        secretName: tok-secrets
  loadbalancers:
  - lbname: speedometer-extension
    function: speedometer-extension
    slbenabled: true
    ports:
      - port: 80
        targetport: 8080
        lbtype: http