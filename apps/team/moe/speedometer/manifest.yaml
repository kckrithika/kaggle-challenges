apiVersion: v1

system:
  functions:
  - name: speedometer
    count: 1
    containers:
    - name: speedometer
      image: dva/moe/speedometer:2232-52c6f2bd1d8c35367afea1f4dbed660fd2e8454f
      command: ["/moe/speedometer"]
      args:
      - "-gheTokenPath=/secrets/ghe_pat"
      - "-log_dir=/host/data/speedometer/logs"
      - "-imagePrefixMapPath=image_prefixes.yaml"
      - "-webfilesPath=/moe/webfiles"
      - "-heartbeat.defaultdecayduration=45m"
      ports:
      - containerPort: 8080
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
        # Speedometer typically takes 30 - 40 minutes for a single loop:
        # https://argus-ui.data.sfdc.net/argus/#/viewmetrics?expression=DOWNSAMPLE(-14d:slb.speedometer.PRD.NONE.prd-sam:agingcodevelocity.Deployment.sam-system.slb-ipvs%7Bcontainer%3Dslb-ipvs-processor%7D:avg,%2345m-count%23)
        # Allow it 45 minutes to pulse the first heartbeat. Check every 60 seconds afterwards (the heartbeat decay is set to 45m above).
        initialDelaySeconds: 2700
        periodSeconds: 60
      volumeMounts:
      - mountPath: /host/data/speedometer/logs
        name: logvol
      - mountPath: /secrets
        name: speedometer-ghe-pat
        readOnly: true
    volumes:
    - name: logvol
      hostPath:
        path: /data/speedometer/logs
    - name: speedometer-ghe-pat
      k4aSecret:
        secretName: speedometer-ghe-pat
  loadbalancers:
  - lbname: speedometer
    function: speedometer
    slbenabled: true
    ports:
      - port: 80
        targetport: 8080
        lbtype: http