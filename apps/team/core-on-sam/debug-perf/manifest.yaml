apiVersion: v1
 
system:
  functions:
  - name: debug-perf-core
    count: 1
    volumes:
    - name: cert
      maddogCert:
        type: client
    - name: automationvol
      emptyDir: {}
    containers:
    - name: debug-perf-core
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/mgainsborough/casam:214_patch__16015380-perf-4

      env:
        # DB info
        - name: DB_USER
          value: bashful
        - name: DB_SID
          value: mist61c214utf
        - name: IP_DB
          value: mist61ice1-db1-1-prd.eng.sfdc.net

        # Matches the external port on the load balancer, used for redirection upon login
        - name: PUBLIC_PORT
          value: 18086

        # Set to true it PUBLIC_PORT is an https endpoint
        - name: PUBLIC_PORT_IS_SECURE
          value: true

        # Container(s) may not actually get scheduled on this host; we just need to hit the LB proxy
        # "samcaas2-caasminion1-2-prd.eng.sfdc.net" for SAM LB (either Cyan or direct to container),
        # "cyanlb.cache-as-a-service-sp2.prd-sam.prd.slb.sfdc.net" for L4-SLB
        - name: PUBLIC_HOST_NAME
          value: debug-perf-core-lb.core-on-sam-sp2.prd-sam.prd.slb.sfdc.net
        # This maps to http_port
        - name: PORT
          value: 12100
        # This maps to https_port
        - name: SPORT
          value: 12099
        # This maps to https2way_port
        - name: S2PORT
          value: 12098

        # Set to true to trigger a plsql stats load during startup
        - name: PLSQL_UPDATE_RUNSTATS
          value: false

        # By default we patch server to NOT expire sessions across major release bounday.
        # Comment out this name/value pair to revert back to normal session invalidation.
        - name: DISABLE_AUTH_RELEASE_CHECK
          value: true

        # App color to be used for blue/green release
        - name: CASAM_APP_COLOR
          value: purple

        # Override port being announced in SD
        - name: SD_PORT_OVERRIDE
          value: 12099

        # Settings.path
        - name: CASAM_SETTINGS_PATH
          value: mist.mist61.prd.na1.app

        # Cluster name
        - name: CLUSTER_NAME
          value: MIST61

        - name: DEPLOYMENT
          value: C

        # Increase DB connections
        - name: DB_CONN_NUM
          value: 25

      livenessProbe:
        exec:
          command:
           - echo
           - HEALTHY
        initialDelaySeconds: 480
        periodSeconds: 1

      readinessProbe:
        httpGet:
          path: /ping.jsp
          port: 12100
        initialDelaySeconds: 120
        periodSeconds: 1
        failureThreshold: 10

      ports:
        # Actually used by the container
        - containerPort: 8998
        - containerPort: 12100
        - containerPort: 11211
        - containerPort: 12098
        - containerPort: 12099

      volumeMounts:
        - name: cert
          mountPath: /certs
        - name: automationvol
          mountPath: /home/sfdc/automation

    - name: perfsidecar
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/casam/perfsidecar:20180629-153037

      livenessProbe:
        exec:
          command:
           - echo
           - HEALTHY
        initialDelaySeconds: 30
        periodSeconds: 120
      readinessProbe:
        exec:
          command:
           - echo
           - HEALTHY
        initialDelaySeconds: 30
        periodSeconds: 120
      volumeMounts:
        - name: automationvol
          mountPath: /home/sfdc/automation
    
    terminationGracePeriodSeconds: 500
    progressDeadlineSeconds: 300

    strategy:
      type: Recreate

  loadbalancers:
  - lbname: debug-perf-core-lb
    function: debug-perf-core
    slbEnabled: true 
    ports:
    - port: 18086
      targetport: 12099
