apiVersion: v1
system:
  notifications:
    email:
      - rshinde@salesforce.com
  functions:
  - name: na6-mist61dapp-prd
    count: 1
    identity:
      serviceName: dapp
    containers:
    - name: coreapp
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/coreonsam/casam:release_main_18435895
      env:
      - name: DB_SID
        value: mist61a222utf
      - name: DB_INSTANCE_NAME
        value: mist61a222utf-1
      - name: DB_USER
        value: doc
      - name: DB_STATS_USER
        value: snowwhite
      - name: DB_CONN_NUM
        value: 20
      - name: IP_DB
        value: mist61ice1-db1-1-prd.eng.sfdc.net
      - name: DB_PASSWORD
        value: rotate
      - name: DB_STATS_PASSWORD
        value: rotate
      - name: IP_MNDS1
        value: 127.0.0.1
      - name: OFFLINE
        value: true
      - name: SERVER_ID
        value: x
      - name: PUBLIC_PORT
        value: 8443
      - name: PUBLIC_PORT_IS_SECURE
        value: true
      - name: PUBLIC_HOST_NAME
        value: us6-sfproxy-lb.core-on-sam-sp2.prd-sam.prd.slb.sfdc.net
      - name: SFPROXY_VIP
        value: https://us6-sfproxy-lb.core-on-sam-sp2.prd-sam.prd.slb.sfdc.net:8443
      - name: HTTP_PORT
        value: 7022
      - name: SPORT
        value: 8443
      - name: S2PORT
        value: 12098
      - name: PLSQL_UPDATE_RUNSTATS
        value: false
      - name: DISABLE_AUTH_RELEASE_CHECK
        value: true
      - name: CASAM_APP_COLOR
        value: debug
      - name: SD_PORT_OVERRIDE
        value: 7442
      - name: CASAM_SETTINGS_PATH
        value: mist.mist61.prd.na6.dapp
      - name: CLUSTER_NAME
        value: na6
      - name: DEPLOYMENT
        value: B
      - name: ZDT
        value: true
      - name: ENABLE_APP_DEBUG_MODE
        value: true
      - name: APP_DEBUG_PORT
        value: 4501
      - name: CASAM_HOST_NAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
      livenessProbe:
        exec:
          command:
          - /home/sfdc/salesforce/casam/bin/live_probe.sh
        failureThreshold: 99999
        initialDelaySeconds: 120
        periodSeconds: 20
        timeoutSeconds: 20
      ports:
      - containerPort: 8998
      - containerPort: 7022
      - containerPort: 11211
      - containerPort: 12098
      - containerPort: 8443
      - containerPort: 4501
      - containerPort: 4505
      readinessProbe:
        exec:
          command: ["/bin/true"]
        failureThreshold: 99999
        initialDelaySeconds: 120
        periodSeconds: 20
        timeoutSeconds: 20
      volumeMounts:
      - mountPath: /home/sfdc/logs/sfdc
        name: log-volume-sfdc
      - mountPath: /home/sfdc/logs/jvm
        name: log-volume-jvm
      - mountPath: /etc/pki_service
        name: tls-client-cert
      - mountPath: /certs/cert-server
        name: tls-server-cert
      - mountPath: /home/sfdc/salesforce/casam
        name: coreapp-casam-volume
      - mountPath: /home/sfdc/salesforce/config/settings/overrides/caas-cluster-casam-sp2
        name: secretvol
        readOnly: true
    - name: casam-sidecar
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/casam/coreapp_overrides:5e6abc
      env:
      - name: CASAM_SETTINGS_PATH
        value: mist.mist61.prd.na6.dapp
      livenessProbe:
        exec:
          command:
          - cat
          - /tmp/live
        initialDelaySeconds: 10
        periodSeconds: 5
      readinessProbe:
        exec:
          command:
          - cat
          - /tmp/ready
        initialDelaySeconds: 10
        periodSeconds: 5
      volumeMounts:
      - mountPath: /home/sfdc/salesforce/casam
        name: coreapp-casam-volume
    - name: dapp-sherpa
      image: sfci/servicelibs/sherpa-envoy:1.0.8
      ports:
      - containerPort: 15373
        name: sherpa-adm
      - containerPort: 4500
        name: jdwp-in
      - containerPort: 7014
        name: http1-in
      livenessProbe:
        exec:
          command:
          - ./bin/is-alive
        initialDelaySeconds: 60
        periodSeconds: 5
      readinessProbe:
        exec:
          command:
          - ./bin/is-ready
        initialDelaySeconds: 50
        periodSeconds: 5
      volumeMounts:
      - name: tls-client-cert
        mountPath: /client-certs
      - name: tls-server-cert
        mountPath: /server-certs
    - name: dapp-beacon
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/casam/beacon:c574fe83d
      args:
      - -endpoint
      - core-on-sam/dapp:DATACENTER_ALLENV:4500
      livenessProbe:
        initialDelaySeconds: 20
        exec:
          command:
          - "/opt/beacon/is-alive.sh"
    progressDeadlineSeconds: 400
    strategy:
      type: Recreate
    terminationGracePeriodSeconds: 120
    volumes:
    - emptyDir: {}
      name: envoy-config-volume
    - emptyDir: {}
      name: coreapp-casam-volume
    - maddogCert:
        type: client
      name: tls-client-cert
    - maddogCert:
        type: server
      name: tls-server-cert
    - hostPath:
        path: /data/logs/sfdc
      name: log-volume-sfdc
    - hostPath:
        path: /data/logs/jvm
      name: log-volume-jvm
    - name: sherpa-log-volume
      hostPath:
        path: /data/logs/sherpa
    - name: secretvol
      k4aSecret:
        secretName: caas-k4a-secret-prd
  - name: na6-mist61dhub-prd
    count: 1
    containers:
      - name: prod-debug-service
        image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/hubs/prod-debug:prod-debug-2019-07-09-14-15-52
        ports:
          - containerPort: 2022
        livenessProbe:
          exec:
            command:
            - cat
            - /tmp/live
          initialDelaySeconds: 10
          periodSeconds: 5
        readinessProbe:
         exec:
          command:
          - cat
          - /tmp/ready
         initialDelaySeconds: 10
         periodSeconds: 5
      - name: prod-debug-sherpa
        image: sfci/servicelibs/sherpa-envoy:1.0.8
        ports:
        - containerPort: 15373
          name: sherpa-adm
        livenessProbe:
          exec:
            command:
            - ./bin/is-alive
          initialDelaySeconds: 60
          periodSeconds: 5
        readinessProbe:
          exec:
            command:
            - ./bin/is-ready
          initialDelaySeconds: 50
          periodSeconds: 5
        volumeMounts:
        - name: tls-client-cert
          mountPath: /client-certs
        - name: tls-server-cert
          mountPath: /server-certs
    volumes:
      - maddogCert:
          type: client
        name: tls-client-cert
      - maddogCert:
          type: server
        name: tls-server-cert
  - name: na6-mist61sfproxy-prd
    count: 1
    identity:
      pod: na6
      serviceName: sfproxy
    containers:
    - name: sfproxy-envoy
      image: sfci/frontend-gateway/sfproxy:c4d4721
      args:
      - --template=/home/sfdc-sherpa/sfproxy/config/core-on-sam/sfproxy-public-cloud-rds.yaml.template
      - --switchboard=na6-switchboard-lb.core-on-sam-sp2.prd-sam.prd.slb.sfdc.net:8088
      - --log-level=trace
      env:
      - name: ENVOY_DEBUG_OPTIONS
        value: --log-path /home/sfdc-sherpa/envoy.log
      - name: SFDC_ENVIRONMENT
        value: mist61
      livenessProbe:
        exec:
          command:
          - ./bin/is-alive
        initialDelaySeconds: 20
        periodSeconds: 5
      ports:
      - containerPort: 2525
      - containerPort: 12060
      - containerPort: 15373
      - containerPort: 18443
      readinessProbe:
        exec:
          command:
          - ./bin/is-ready
        initialDelaySeconds: 15
        periodSeconds: 5
      volumeMounts:
      - mountPath: /client-certs
        name: tls-client-cert
      - mountPath: /server-certs
        name: tls-server-cert
    volumes:
    - maddogCert:
        type: client
      name: tls-client-cert
    - maddogCert:
        lbnames:
        - us6-sfproxy-lb
        type: server
      name: tls-server-cert
  - name: na6-mist61switchboard-prd
    count: 1
    identity:
      pod: na6
      serviceName: sfproxy-switchboard
    serviceAccountName: switchboard-service-account
    containers:
    - name: sfproxy-switchboard-server
      image: sfci/servicelibs/switchboard:c5c9fc43f60a118a562144ec26b1b2ec07b052d4
      args:
      - --clusters.external-clusters[0]=ajnafunneldirect:HTTP1
      - --clusters.external-clusters[1]=spaasmesh:HTTP2
      - --metrics.maxNumberOfCollectedMetrics=100000
      - --metrics.funnelTimeOut=90000
      - --metrics.funnelEndPointURL=http://ajna0-funnel1-0-prd.data.sfdc.net:80
      - --routes.frontProxy.isTrueFrontProxy=true
      - --routeupdates.use.k8s=true
      env:
      - name: SFDC_ENVIRONMENT
        value: mist61
      - name: GRPC_SERVER_PORT
        value: 7020
      - name: JVM_HEAP_MAX
        value: 4G
      livenessProbe:
        httpGet:
          path: /manage/health
          port: 15372
        initialDelaySeconds: 20
        periodSeconds: 5
      ports:
      - containerPort: 7020
      - containerPort: 15372
      readinessProbe:
        httpGet:
          path: /manage/health
          port: 15372
        initialDelaySeconds: 15
        periodSeconds: 5
      volumeMounts:
      - mountPath: /home/sfdc-switchboard/sherpa-envoy-config-volume
        name: envoy-config-volume
    - name: sfproxy-switchboard-sherpa
      image: sfci/frontend-gateway/sfproxy:c4d4721
      ports:
      - containerPort: 15001
      - containerPort: 15373
      args:
      - --template
      - /home/sfdc-sherpa/sfproxy/config/switchboard-sidecar/sfproxy-switchboard-sidecar.config.yaml.template
      - --log-level
      - trace
      env:
      - name: SFDC_ENVIRONMENT
        value: mist61
      - name: ENVOY_DEBUG_OPTIONS
        value: --log-path /home/sfdc-sherpa/envoy.log
      livenessProbe:
        exec:
          command:
          - ./bin/is-alive
        initialDelaySeconds: 20
        periodSeconds: 5
      readinessProbe:
        exec:
          command:
          - ./bin/is-ready
        initialDelaySeconds: 15
        periodSeconds: 5
      volumeMounts:
      - mountPath: /switchboard-config
        name: envoy-config-volume
      - mountPath: /client-certs
        name: tls-client-cert
      - mountPath: /server-certs
        name: tls-server-cert
    volumes:
    - emptyDir: {}
      name: envoy-config-volume
    - maddogCert:
        type: client
      name: tls-client-cert
    - maddogCert:
        lbnames:
        - na6-switchboard-lb
        type: server
      name: tls-server-cert
  - name: na6-mist61app-prd
    count: 1
    identity:
      pod: na6
      serviceName: app
    containers:
    - name: coreapp
      image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/coreonsam/casam:release_222-patch_19057694
      ports:
      - containerPort: 8998
      - containerPort: 8085
      - containerPort: 11211
      - containerPort: 12098
      - containerPort: 8443
      env:
      - name: DB_SID
        value: mist61a222utf
      - name: DB_INSTANCE_NAME
        value: mist61a222utf-1
      - name: DB_USER
        value: doc
      - name: DB_STATS_USER
        value: snowwhite
      - name: DB_CONN_NUM
        value: 20
      - name: IP_DB
        value: mist61ice1-db1-1-prd.eng.sfdc.net
      - name: DB_PASSWORD
        value: rotate
      - name: DB_STATS_PASSWORD
        value: rotate
      - name: IP_MNDS1
        value: 127.0.0.1
      - name: OFFLINE
        value: true
      - name: SERVER_ID
        value: x
      - name: PUBLIC_PORT
        value: 8443
      - name: PUBLIC_PORT_IS_SECURE
        value: true
      - name: PUBLIC_HOST_NAME
        value: us6-sfproxy-lb.core-on-sam-sp2.prd-sam.prd.slb.sfdc.net
      - name: SFPROXY_VIP
        value: https://us6-sfproxy-lb.core-on-sam-sp2.prd-sam.prd.slb.sfdc.net:8443
      - name: HTTP_PORT
        value: 7022
      - name: SPORT
        value: 8443
      - name: S2PORT
        value: 12098
      - name: PLSQL_UPDATE_RUNSTATS
        value: false
      - name: DISABLE_AUTH_RELEASE_CHECK
        value: true
      - name: CASAM_APP_COLOR
        value: blue
      - name: SD_PORT_OVERRIDE
        value: 7442
      - name: CASAM_SETTINGS_PATH
        value: mist.mist61.prd.na6.app
      - name: CLUSTER_NAME
        value: na6
      - name: DEPLOYMENT
        value: B
      - name: CASAM_DEPLOYMENT_ID
        value: 12345
      - name: CASAM_HOST_NAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
      livenessProbe:
        exec:
          command:
          - /home/sfdc/salesforce/casam/bin/live_probe.sh
        failureThreshold: 99999
        initialDelaySeconds: 120
        periodSeconds: 5
        timeoutSeconds: 5
      readinessProbe:
        exec:
          command:
          - /home/sfdc/salesforce/casam/bin/ready_probe.sh
        failureThreshold: 99999
        initialDelaySeconds: 120
        periodSeconds: 5
        timeoutSeconds: 5
      volumeMounts:
      - mountPath: /home/sfdc/logs/sfdc
        name: log-volume-sfdc
      - mountPath: /home/sfdc/logs/jvm
        name: log-volume-jvm
      - mountPath: /etc/pki_service
        name: tls-client-cert
      - mountPath: /certs/cert-server
        name: tls-server-cert
      - mountPath: /home/sfdc/salesforce/casam
        name: coreapp-casam-volume
      - mountPath: /home/sfdc/salesforce/config/settings/overrides/caas-cluster-casam-sp2
        name: secretvol
        readOnly: true
    - name: casam-sidecar
      image: sfci/casam/coreapp_overrides:a9470f
      env:
      - name: CASAM_SETTINGS_PATH
        value: mist.mist61.prd.na6.app
      livenessProbe:
        exec:
          command:
          - cat
          - /tmp/live
        initialDelaySeconds: 10
        periodSeconds: 5
      readinessProbe:
        exec:
          command:
          - cat
          - /tmp/ready
        initialDelaySeconds: 10
        periodSeconds: 5
      volumeMounts:
      - mountPath: /home/sfdc/salesforce/casam
        name: coreapp-casam-volume
    - name: sherpa-envoy
      # Use the latest release version from https://git.soma.salesforce.com/servicelibs/sherpa-envoy/releases
      image: sfci/servicelibs/sherpa-envoy:33101eda4a3280cf3b4b8458da27a9494b0aa9ae
      # See https://git.soma.salesforce.com/servicelibs/sherpa#ports
      ports:
      - containerPort: 7442
        name: http1-tls-in
      - containerPort: 15373
        name: sherpa-adm
      livenessProbe:
        exec:
          command:
          - ./bin/is-alive
        initialDelaySeconds: 60
        periodSeconds: 5
      readinessProbe:
        exec:
          command:
          - ./bin/is-ready
        initialDelaySeconds: 50
        periodSeconds: 5
      volumeMounts:
      - name: tls-client-cert
        mountPath: /client-certs
      - name: tls-server-cert
        mountPath: /server-certs
    progressDeadlineSeconds: 300
    strategy:
      rollingUpdate:
        maxSurge: 200%
        maxUnavailable: 0
      type: RollingUpdate
    terminationGracePeriodSeconds: 500
    volumes:
    - emptyDir: {}
      name: envoy-config-volume
    - emptyDir: {}
      name: coreapp-casam-volume
    - maddogCert:
        type: client
      name: tls-client-cert
    - maddogCert:
        type: server
      name: tls-server-cert
    - hostPath:
        path: /data/logs/sfdc
      name: log-volume-sfdc
    - hostPath:
        path: /data/logs/jvm
      name: log-volume-jvm
    - k4aSecret:
        secretName: caas-k4a-secret-prd
      name: secretvol
  loadbalancers:
  - function: na6-mist61sfproxy-prd
    lbname: us6-sfproxy-lb
    nodeExposed: false
    ports:
    - port: 2525
      targetport: 2525
    - port: 8443
      targetport: 12060
    - port: 8087
      targetport: 15373
    - port: 8444
      targetport: 18443
    slbEnabled: true
  - function: na6-mist61switchboard-prd
    lbname: na6-switchboard-lb
    nodeExposed: false
    ports:
    - port: 8088
      targetport: 15001
    - port: 8089
      targetport: 15372
    - port: 8090
      targetport: 15373
    - port: 8888
      targetport: 7020
    slbEnabled: true
