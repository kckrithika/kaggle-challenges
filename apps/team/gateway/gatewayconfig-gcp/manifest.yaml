apiVersion: v1
system:
  notifications:
    email:
      - kbotha@salesforce.com
      - gateway@salesforce.com
      - yangyangliu@salesforce.com
  functions:
  - name: gateway-service
    count: 3
    volumes: 
    - name: client-cert
      maddogCert:
        type: client
    - name: server-cert
      maddogCert:
        type: server
    - name: logvol
      hostPath:
        path: /home/sfdc-gatewayconfig/logs
    - name: logvolsherpa
      hostPath:
        path: /home/sfdc-gatewayconfig/logs
    - name: logvolbeacon
      hostPath:
        path: /home/sfdc-gatewayconfig/logs
    - name: repo
      emptyDir:
        medium: Memory
    containers:
    - name: gatewayconfig
      image: ops0-artifactrepo2-0-xrd.slb.sfdc.net/docker-devmvp/kbotha/gatewayconfig:2019-04-01-gcp
      env:
      - name: PKI_CA_DIR
        value: /server-certs
      - name: PKI_MONITORDIR
        value: /server-certs/server
      - name: LOGGING_JSON_STDOUT_LEVEL
        value: all
      - name: LOGGING_STDERR_LEVEL
        value: all
      volumeMounts:
      - name: client-cert
        mountPath: /client-certs
      - name: server-cert
        mountPath: /server-certs
      - name: logvol
        mountPath: /log
      - name: repo
        mountPath: /repo
      args:
        - start
      ports:
      - containerPort: 7022
      - containerPort: 15372
      livenessProbe:
        initialDelaySeconds: 21
        periodSeconds: 15
        #exec:
        #  command:
        #  - "/bin/true"
        httpGet:
          path: /manage/health
          port: 15372
    - name: sherpa
      image: ops0-artifactrepo2-0-xrd.slb.sfdc.net/docker-gcp/sfci/servicelibs/sherpa-envoy:eeb8e3bfc9d7912299ed28658895aca9523f348f
      args:
      # 2018-02-08: Direct Connection to the switchboard for now
      - --switchboard=switchboard.service-mesh.svc:15001
      ports:
      - containerPort: 7442
        name: http1-tls-in
      - containerPort: 15373
        name: sherpa-adm
      volumeMounts:
      - name: logvolsherpa
        mountPath: /log
      - name: client-cert
        mountPath: /client-certs
      - name: server-cert
        mountPath: /server-certs
      livenessProbe:
        initialDelaySeconds: 60
        periodSeconds: 5
        exec:
          command:
          - ./bin/is-alive
      readinessProbe:
        initialDelaySeconds: 100
        periodSeconds: 5
        exec:
          command:
          - ./bin/is-ready
    - name: beacon
      image: ops0-artifactrepo2-0-xrd.slb.sfdc.net/docker-gcp/sfci/services/sfdc-bazel/disco/beacon:f804d14
      env:
        - name: SFDC_ENVIRONMENT
          value: mesh
      args:
      - -endpoint
      - gateway/gateway-service:DATACENTER_ALLENV:7442
      volumeMounts:
      - name: logvolbeacon
        mountPath: /log
      livenessProbe:
        initialDelaySeconds: 5
        exec:
          command:
          - /home/scone/is-alive.sh
  loadbalancers:
  - lbname: gatewayconfiglb
    function: gateway-service
    ports:
    - port: 7022
      targetport: 7022
