apiVersion: v1

system:
  notifications:
    email:
      - search-sip-notify@salesforce.com
  functions:
    - name: sip-em-prd
      count: 1
      volumes:
        - name: logvol
          hostPath:
            path: /home/sfdc-search-sip/logs
        - name: blacktab-secret
          k4asecret:
            secretName: blacktab-credentials
        - name: github-secret
          k4asecret:
            secretName: github-token
        - name: client-cert-vol
          maddogCert:
            type: client
        - name: server-cert-vol
          maddogCert:
            type: server
            lbnames:
              - sip-em-prd-slb
      containers:
        - name: sip-em
          image: ops0-artifactrepo1-0-prd.data.sfdc.net/docker-sam/searchdev/sip-experiment-manager:1.6
          livenessProbe:
            initialDelaySeconds: 180
            periodSeconds: 60
            timeoutSeconds: 10
            httpGet:
              path: /manage/health
              port: 15372
          readinessProbe:
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 10
            httpGet:
              path: /manage/health
              port: 15372
          volumeMounts:
            - mountPath: /home/sfdc-search-sip/logs
              name: logvol
            - mountPath: /secrets/blacktab/
              name: blacktab-secret
              readOnly: true
            - mountPath: /secrets/github/
              name: github-secret
              readOnly: true
            - name: client-cert-vol
              mountPath: /certs
            - name: server-cert-vol
              mountPath: /server-certs
          ports:
            - containerPort: 7020
              name: scone-grpc
            - containerPort: 15372
              name: scone-mgmt
          resources:
            limits:
              cpu: "4"
              memory: "10Gi"
          env:
            - name: GRPC_HOST
              value: sip-em-prd-slb.sip.prd-sam.prd.slb.sfdc.net:7020
            - name: SIP_EM_ENVIRONMENT
              value: production
  loadbalancers:
    - function: sip-em-prd
      lbname: sip-em-prd-slb
      ports:
        - lbtype: tcp
          port: 7020
          targetport: 7020
        - lbtype: http
          port: 15372
          targetport: 15372
      slbEnabled: true
